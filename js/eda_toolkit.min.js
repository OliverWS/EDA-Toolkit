/**
* EDA Toolkit
* Copyright 2013 Oliver Wilder-Smith 
* http://www.apache.org/licenses/LICENSE-2.0
*/
function testBit(a,b){var c=1<<b;return a&c}function truncate(a,b){var b=b||0;return Math.trunc(a*pow(10,b))/float(pow(10,b),b)}function unpackStruct(a){for(var b=[],c=0;c<a.length;c+=2){var d=a.charCodeAt(c),e=a.charCodeAt(c+1),f=256*d+e;b.push(f)}return b}function unpackSigned(a){var b=testBit(a,15)>0,c=3&a>>13,d=float(1023&a)/1e3;return b?truncate(round(-1*d*pow(10,c),3-c),3-c):truncate(round(d*pow(10,c),3-c),3-c)}function unpackUnsigned(a){var b=3&a>>14,c=float(16383&a)/1e4;return truncate(round(c*pow(10,b),4-b),4-b)}var e=Math.E,pi=Math.PI,np={},MU="μ";urlParams=function(){for(var a=location.search.substring(1).split("&"),b={},c={"true":!0,"false":!1,"null":null},d=0,e=a.length;e>d;d++){var f=a[d],g=f.indexOf("="),h=-1==g?f:f.substring(0,g),i=-1==g?!0:f.substring(g+1);i in c?i=c[i]:""+parseFloat(i,10)==i&&(i=parseFloat(i,10)),b[h]=i}return a=c=null,function(a){return a in b?b[a]:null}}(),float=function(a){return 1*a},int=function(a){return parseInt(a,10)},pow=function(a,b){return Math.pow(a,b)},round=function(a,b){var b=b||0;return a.toFixed(b)},String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)};var log=function(a){window.console&&console.log(a)},toast=function(a){var b=document.createElement("div");b.className="toast alert alert-info",b.innerHTML=a,b.style.position="absolute",b.style.display="block",b.style.width="30%",b.style.left="50%",b.style.top="50%",b.style["margin-left"]="-15%",b.style["margin-top"]="0px",document.getElementsByTagName("body")[0].appendChild(b),$(".toast").fadeOut(0),$(".toast").fadeIn(500),setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(a,b){return a.toFixed(b)},Number.prototype.pad=function(a){for(var b=""+this,c=b.length-a,d=0;c>d;d++)b="0"+b;return b},Date.prototype.toQFormat=function(){var a="";return a+=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate(),a+=" ",a+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2),a+=" ",a+="Offset:"+(this.getTimezoneOffset()>0?"+"+this.getTimezoneOffset():this.getTimezoneOffset())},parseDate=function(a){var b=a.split(" ")[0],c=a.split(" ")[1];float(a.split(" ")[2].split(":")[1]);var d=int(b.split("-")[0]),e=int(b.split("-")[1]-1),f=int(b.split("-")[2]),g=int(c.split(":")[0]),h=int(c.split(":")[1]),i=int(c.split(":")[2]);return new Date(d,e,f,g,h,i,0)};var TimeDelta=function(a){var b={};return a.isPrototypeOf(Object)?(b.days=a.days||0,b.hours=a.hours||0,b.minutes=a.minutes||0,b.seconds=a.seconds||0,b.milliseconds=a.milliseconds||0):(b.days=Math.floor(a/864e5),b.hours=Math.floor(a%864e5/36e5),b.minutes=Math.floor(a%36e5/6e4),b.seconds=Math.floor(a%6e4/1e3),b.milliseconds=Math.floor(a%1e3)),b.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)},b.valueOf=function(){var a=0;return a+=864e5*this.days,a+=36e5*this.hours,a+=6e4*this.minutes,a+=1e3*this.seconds,a+=this.milliseconds},b};Date.prototype.sub=function(a){var b=this.valueOf()-a.valueOf();return TimeDelta(b)},Date.prototype.add=function(a){return new Date(this.valueOf()+TimeDelta(a).valueOf())},Date.prototype.addMilliseconds=function(a){var b=new Date(this.valueOf()+a);return b},Date.prototype.addSeconds=function(a){return this.addMilliseconds(1e3*a)},Date.prototype.addMinutes=function(a){return this.addSeconds(60*a)},Date.prototype.addHours=function(a){return this.addMinutes(60*a)},Date.prototype.addDays=function(a){return this.addHours(24*a)},Date.prototype.getMinutesSinceMidnight=function(){var a=new Date(this.toString());a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);var b=(a.valueOf()-this.valueOf())/6e4;return b},Date.prototype.shortString=function(){return this.toLocaleTimeString()},String.prototype.contains=function(a){return this.indexOf(a)>-1},String.prototype.isnum=function(){try{return parseFloat(this.toString()),!0}catch(a){return!1}},String.prototype.isdate=function(){try{var a=new Date(this.toString());return a.valueOf().isNaN()?!1:!0}catch(b){return!1}},String.prototype.autoconvert=function(){try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());return 0/0!=b?b:this.toString()}catch(a){return this.toString()}},guess=function(a){return"string"!=typeof a?typeof a:a.isdate()?"date":a.isnum()?a.toString().contains(".")||a.toString().contains(",")?"float":"int":"unknown"},autoformat=function(a){var b=guess(a);switch(b){case"float":return float(a);case"int":return int(a);case"date":return new Date(a);default:return a}},gaussian=function(a,b){var c=Math.sqrt(b),d=1/(c*Math.sqrt(2*pi)),f=0,g=-1*(Math.pow(a-f,2)/(2*c*c)),h=d*Math.pow(e,g);return h},gaussianKernel=function(a,b){for(var c=new Array,d=-1*b/2;b/2>d;d++)c.push(gaussian(d,a));return c},gaussianFilter=function(a,b,c){var d=new Array;void 0==c&&(c=100);for(var e=0;e<a.length;e++){var f=0>e-c/2?0:e-c/2,g=e+c/2>=a.length?a.length-1:e+c/2,h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d},np.timeRange=function(a,b,c){for(var d=b-a,e=Math.floor(float(d)/c),f=new Array,g=0;c>g;g++)f.push(a.addMilliseconds(e*g));return f},np.arange=function(a,b,c){void 0==c&&(c=1);for(var d=new Array,e=a;b>e;e+=c)d.push(e);return d},np.round=function(a,b){var c=a%b;return a=c>b/2?(Math.round(a/b)+1)*b:Math.round(a/b)*b},np.map=function(a,b){for(var c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},np.max=function(a){for(var b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},np.min=function(a){for(var b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},convolve=function(a,b){var c=new Array;if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)c.push(a[d]*b[d]);return c},np.sum=function(a){for(var b=0,c=0;c<a.length;c++)a[c].isNaN()||(b+=a[c]);return b},Array.prototype.max=function(){for(var a=this,b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},Array.prototype.min=function(){for(var a=this,b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},Array.prototype.find=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)b[d]==a&&c.push(d);return c},Array.prototype.map=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},Array.prototype.max=function(){for(var a=this,b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},Array.prototype.min=function(){for(var a=this,b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},Array.prototype.map=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},float=function(a){return 1*a},int=function(a){return parseInt(a,10)},Array.prototype.clone=function(){for(var a=this,b=new Array,c=0;c<a.length;c++)b.push(a[c]);return b},gaussian=function(a,b){var c=Math.sqrt(b),d=1/(c*Math.sqrt(2*pi)),f=0,g=-1*(Math.pow(a-f,2)/(2*c*c)),h=d*Math.pow(e,g);return h},gaussianKernel=function(a,b){for(var c=new Array,d=-1*b/2;b/2>d;d++)c.push(gaussian(d,a));return c},String.prototype.autoconvert=function(){try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());return 0/0!=b?b:this.toString()}catch(a){return this.toString()}},gaussianFilter=function(a,b,c){var d=new Array;void 0==c&&(c=100);for(var e=0;e<a.length;e++){var f=0>e-c/2?0:e-c/2,g=e+c/2>=a.length?a.length-1:e+c/2,h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};var np=np||{};np.arange=function(a,b,c){void 0==c&&(c=1);for(var d=new Array,e=a;b>e;e+=c)d.push(e);return d},np.round=function(a,b){var c=a%b;return a=c>b/2?(Math.round(a/b)+1)*b:Math.round(a/b)*b},np.map=function(a,b){for(var c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},np.max=function(a){for(var b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},np.min=function(a){for(var b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},convolve=function(a,b){var c=new Array;if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)c.push(a[d]*b[d]);return c},np.sum=function(a){for(var b=0,c=0;c<a.length;c++)a[c].isNaN||(b+=a[c]);return b},np.mean=function(a){return np.sum(a)/(1*a.length)},np.average=np.mean,np.avg=np.mean,np.median=function(a){var b=a.clone();b.sort();var c=int(Math.ceil(a.length/2))-1;return 0==a.length%2?np.mean(b.slice(c,-c)):b[c]};var signals=signals||{};signals.sanitize=function(a,b,c){for(var b=b||[0],c=c||[0/0],d=0;d<a.length;d++)for(var e=0;e<c.length;e++)"-"==c[e]?a[d]<0&&(a[d]=b[e]):a[d]==c[e]&&(a[d]=b[e]);return a},signals.gaussianFilter=function(a,b){return gaussianFilter(a,b,10)},signals.medianFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.median(a.slice(e,f)))}return c},signals.maxFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.max(a.slice(e,f)))}return c},signals.minFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.min(a.slice(e,f)))}return c},signals.diff=function(a){for(var b=new Array,c=0;c<a.length-1;c++)b.push(a[c+1]-a[c]);return b},signals.where=function(a,b){for(var c=new Array,d=0;d<a.length;d++)b(a[d])&&c.push(d);return c},signals.zeroCrossings=function(a){for(var b=new Array,c=1;c<a.length;c++)b[c]=a[c-1]<0&&a[c]>0?1:a[c-1]>0&&a[c]<0?-1:0;return b},signals.peaks=function(a){var b=new Array;signals.diff(a),signals.zeroCrossings(a);var c=signals.where(b,function(a){return a>0}),d=signals.where(b,function(a){return 0>a});return[c,d]};var Dropzone=function(a,b,c){var d=this,c=c||{};d.active=!0,d.allowFolders=c.allowFolders||!0,d.width=c.width||$("#"+a).width()||300,d.height=c.height||$("#"+a).height()||d.width,d.autoremove=c.autoremove||!0,d.callback=b,margin=c.margin||10,d.styles=new StyleSheet;var e=d.styles.addStyle(".dropzone");e.addProperty("background-color: #CCC"),e.addProperty("width: "+(d.width-2*margin)+"px"),e.addProperty("height: "+(d.height-2*margin)+"px"),e.addProperty("margin: "+margin+"px"),e.addProperty("border: "+d.width/100+"px dashed"),e.addProperty("border-color: #333"),e.addProperty("border-radius: 50px"),e.addProperty("opacity: 0.75");var f=d.styles.addStyle(".stripes");f.addProperty("background-image: -webkit-linear-gradient(-45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent)"),f.addProperty("-webkit-background-size: 100px 100px");var g=document.getElementById(a);if(g.className+=" dropzone stripes ",c.label){var h=$("<h1>").html(c.label);$(g).append(h);var i=$(h).height();$(h).css("margin-top",(d.height-i)/2).css("text-align","center").css("vertical-align","middle")}g.ondragover=function(){return this.className.indexOf("hover")<0&&(this.className+=" hover"),!1},g.ondragend=function(){return this.className.replace("hover",""),!1},g.ondrop=function(a){if(a.preventDefault(),d.allowFolders){var b=a.dataTransfer.items[0].webkitGetAsEntry();if(b.isDirectory)document.getElementById("foldername")&&(document.getElementById("foldername").innerHTML=b.name),d.traverseFileTree(b),d.callback({},!0),d.autoremove&&d.remove();else{var c=a.dataTransfer.files[0];d.callback(c),d.autoremove&&d.remove()}}else{var c=a.dataTransfer.files[0];d.callback(c),d.autoremove&&d.remove()}},d.traverseFileTree=function(a,b){if(b=b||"",a.isFile&&"."!=a.name[0])a.file(function(a){d.callback(a)});else if(a.isDirectory&&"."!=a.name[0]){var c=a.createReader();c.readEntries(function(c){for(var e=[],f=0;f<c.length;f++)e.push(c[f]);e.sort(function(a,b){return a.name.localeCompare(b.name)});for(var f=0;f<e.length;f++)d.traverseFileTree(e[f],b+a.name+"/")})}},d.dropzone=g,d.remove=function(){$(g).find("h1").remove(),g.className=g.className.replace("dropzone",""),g.className=g.className.replace("stripes",""),g.ondragover=null,g.ondragend=null,g.ondrop=null,d.active=!1}},Loader=function(a,b){$(a).append($("<div>").addClass("loader").append($("<h2>").text("Loading...")).append($("<div>").attr("id",b).attr("class","progress progress-striped active").append($("<div>").addClass("progress-bar").attr("role","progressbar").attr("style","width: 0%;"))));var c=($(a).height()-$(a).find(".loader").height()-$(a).find("h2").height())/2;$(a).find(".loader").css("margin-top",c)},StyleSheet=function(){var a=this;a.css=document.createElement("style"),a.css.type="text/css",a.styles=[],a.css=document.head.appendChild(a.css),a.addStyle=function(b){var c={};return c.selector=b,c.properties=[],a.styles.push(c),c.addProperty=function(b){this.properties.push(b),a.update()},a.update(),c},a.update=function(){for(var b="\n",c=0;c<a.styles.length;c++){var d=a.styles[c],e="";e+=d.selector+" {\n";for(var f=0;f<d.properties.length;f++){var g=d.properties[f];e+="    "+g+(g.indexOf(";")>-1?"\n":";\n")}e+="\n}\n\n",b+=e}a.css.innerHTML=b},a.update()},VideoDroplet=function(a,b,c){var d=this,c=c||{};d.id=a,d.extension=c.extension||!1,d.callback=b,d.vsize=c.vsize||{},d.vsize.width=d.vsize.width||640,d.vsize.height=d.vsize.height||320,d.insertVideo=function(a,b){var c=b.name,e=b.type;$("#"+d.id).append($("<video>").attr("controls","").attr("class","video-js vjs-default-skin").attr("filename",c).attr("preload","auto").attr("id","video").attr("name","media").attr("src",a).attr("type",e)),$("#"+d.id).css("width","auto"),$("#"+d.id).css("height","auto"),_V_("video").ready(function(){var a=this;a.size(d.vsize.width,d.vsize.height),d.callback(a)})},d.dropzone=new Dropzone(d.id,function(a){if(new FileReader,d.file=a,a.name.endsWith("."+d.extension)||0==d.extension)d.insertVideo(window.webkitURL.createObjectURL(a),a);else{var b=$("#"+d.id).find(".dropzone").css("background-color"),c=$("#"+d.id).find(".dropzone").css("border-color");$("#"+d.id).find(".dropzone").animate({"background-color":"#f2dede","border-color":"#b94a48"},1e3,function(){$(this).animate({"background-color":b,"border-color":c},1e3)})}return!1},{label:"Drop video file here to view"})},qLogFile=function(){var a=this;this.worker=new Worker("js/eda_toolkit.worker.min.js"),a.isEDAFile=!0,a.didAlreadyLoad=!1,a.filename="EDA File",a.callbacks={},this.handleMessage=function(b){var c=b.data;switch(c.cmd){case"console":break;case"metadata":a.metadataDidLoad(c.data);break;case"data":a.dataDidLoad(c.data);break;case"scrs":a.callback(c.data);break;case"export":a.callback(c.data);break;case"filter":a.callback(c.data);break;case"progress":a.updateProgress(100*c.progress.toFixed(2));break;case"downsampled":if(console.log("Got downsampled data back"),c.key){var d=c.data;console.log(d),a.callbacks[c.key](d)}else a.callback(c.data),a.callback=null;break;case void 0:}a.validate()&&!a.didAlreadyLoad&&(a.didAlreadyLoad=!0,a.didLoad())},this.load=function(a,b){this.url=a,this.filename=a.split("/").slice(-1),this.callback=b,void 0==this.worker&&(this.worker=new Worker("js/eda_toolkit.worker.js")),this.worker.onmessage=this.handleMessage,this.worker.postMessage({cmd:"load",url:this.url})},this.loadText=function(a,b,c){this.callback=b,void 0!=c&&(this.filename=c),void 0==this.worker&&(this.worker=new Worker("js/eda_toolkit.worker.js")),this.worker.onmessage=this.handleMessage,this.worker.postMessage({cmd:"loadText",data:a})},this.updateProgress=function(a){void 0!=this.progress&&$("#"+this.progress).find("div.progress-bar").css("width",Math.round(a)+"%")},this.didLoad=function(){void 0!=this.callback&&this.callback.call(a)},this.validate=function(){return this.metadata&&this.data},this.metadataDidLoad=function(a){this.metadata=a,this.startTime=this.metadata["Start Time"],this.sampleRate=this.metadata["Sampling Rate"],this.channels=this.metadata["Column Names"]},this.dataDidLoad=function(b){this.data=b,this.events=b.markers,this.data.length=this.channels.map(function(b){return a.data[b].length}).min();var c=1e3*(this.data.length/this.sampleRate);this.endTime=this.startTime.addMilliseconds(c),this.duration=this.endTime.sub(this.startTime)},this.setData=function(b,c){if(c.length==a.data.length)for(var d=0;d<a.data.length;d++)a.data[b][d]=c[d]},this.getData=function(b){return a.data[b]},this.filter=function(b,c,d){a.callback=function(c){a.setData(b,c),d(a)};var e=a.getData(b);a.worker.postMessage({cmd:"filter",data:{data:e,filterType:c,width:a.sampleRate}})},this.offsetForTime=function(a){var b=a.sub(this.startTime);if(b.valueOf()>=0&&b.valueOf()<this.duration.valueOf())return Math.round(b.valueOf()/(1e3/this.sampleRate));if(b.valueOf()>=0&&b.valueOf()==this.duration.valueOf())return this.data.length-1;throw"Illegal Time: "+a+". Time must be between "+this.startTime+" and "+this.endTime},this.timeForOffset=function(a){var b=a*(1e3/this.sampleRate);if(b>=0&&b<this.duration.valueOf())return this.startTime.add(TimeDelta(b));if(b>=0&&b==this.duration.valueOf())return this.endTime;throw"Illegal Offset: "+a+". Offset must be between "+0+" and "+this.data.length-1},this.get=function(b,c){var c=c||{},d=c.start||this.timeForOffset(0),e=c.end||this.timeForOffset(a.data.EDA.length-1),f=c.channels||["EDA","X","Y","Z"],g=c.targetSamples||this.offsetForTime(e)-this.offsetForTime(d);console.log("start: "+d+"("+this.offsetForTime(d)+") \n end: "+e+"("+this.offsetForTime(e)+") \n targetSamples: "+g),a.getMultiChannelDataForOffsetRange(f,this.offsetForTime(d),this.offsetForTime(e),g,function(a){console.log(a);for(var c=new Array,h=np.timeRange(d,e,g),i=0;i<a[0].length;i++){for(var j={},k=0;k<f.length;k++)j[f[k]]=a[k][i];j.time=h[i],c.push(j)}b(c)})},this.getData=function(b,c,d){var e=a.data[b];if(!c)return e;var f=(10*Math.random()).toString();if(a.callbacks[f]=d,!(c>0))throw"Target Samples Error: target samples must be greater than 0 and less than "+this.data.length+", not "+c;this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:data,target:c,key:f}})},this.findSCRs=function(b,c,d){void 0==c&&(c=0),void 0==d&&(d=a.data.EDA.length-1),a.callback=b,a.worker.postMessage({cmd:"scrs",data:{points:this._getDataForOffsetRange("EDA",c,d),width:a.sampleRate}})},this.getDataForOffsetRange=function(b,c,d,e,f){if("acc"==b.toLowerCase())a.getMultiChannelDataForOffsetRange(["X","Y","Z"],c,d,e,f);else{var g=this._getDataForOffsetRange(b,c,d);if(!f)return g;var h=(10*Math.random()).toString();a.callbacks[h]=f,this.worker.postMessage({cmd:"downsample",data:{points:g,target:e,key:h}})}},a.getMultiChannelDataForOffsetRange=function(b,c,d,e,f){for(var g=[],h=0;h<b.length;h++)g.push(this._getDataForOffsetRange(b[h],c,d));if(!f)return points;var i=(10*Math.random()).toString();a.callbacks[i]=f,this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:g,target:e,key:i}})},this._getDataForOffsetRange=function(a,b,c){return b>=0&&c<this.data.length&&this.data.hasOwnProperty(a)?this.data[a].slice(b,c):[]},this.getDataForTimeRange=function(b,c,d,e,f){var g=this._getDataForTimeRange(b,c,d);return f?(a.callback=f,this.worker.postMessage({cmd:"downsample",data:{points:g,target:e}}),void 0):g},this._getDataForTimeRange=function(a,b,c){var a=a||"EDA",d=this.offsetForTime(b),e=this.offsetForTime(c);return 0/0==d||0/0==end?[]:this.data.hasOwnProperty(a)?this.data[a].slice(d,e):void 0},this.saveFileAs=function(b){var c=new Blob([b],{type:"text/plain;charset=UTF-8"});saveAs(c,a.filename)},this.savePDF=function(){},this.saveToDropbox=function(b){this.exportToCSV(function(c){b.writeFile(a.filename,c,function(){new Notify("File uploaded to Dropbox!")})})},this.exportToCSV=function(b){a.callback=b?b:a.saveFileAs,a.worker.postMessage({cmd:"export",data:{data:a.data,metadata:a.metadata,useBlob:!1}})}},EDADroplet=function(a,b,c){var d=this,c=c||{};d.id=a,d.extension=c.extension||"eda",d.callback=b,d.edaFile=new qLogFile,d.edaFile.progress="progress-indicator-"+parseInt(1e4*Math.random(),10),d.draw=function(){},d.graph=function(){console.log("Preparing to graph"),d.grapher=new Grapher(document.getElementById(d.id)),$("#"+d.id).find(".loader").remove(),d.grapher.plot(d.edaFile),d.callback(d.edaFile,d.grapher)},d.dropzone=new Dropzone(d.id,function(a){var b=new FileReader;if(console.log(a),a.name.endsWith("."+d.extension))new Loader("#"+d.id,d.edaFile.progress),console.log("Loading file..."),b.onload=function(b){return console.log(b.target),d.fileContents=b.target.result,d.edaFile.loadText(b.target.result,d.graph,a.name),!1},b.readAsBinaryString(a);else{var c=$(".dropzone").css("background-color"),e=$(".dropzone").css("border-color");$(".dropzone").animate({"background-color":"#f2dede","border-color":"#b94a48"},1e3,function(){$(this).animate({"background-color":c,"border-color":e},1e3)})}return!1},{label:"Drop EDA file here to view"})},FolderDroplet=function(a,b,c){var d=this,c=c||{};d.id=a,d.extension=c.extension||"eda",d.callback=b,d.vsize=c.vsize||{},d.vsize.width=d.vsize.width||640,d.vsize.height=d.vsize.height||320,d.graphs=[],d.videoFiles=[],$(document).append($("<script>").attr("src","http://vjs.zencdn.net/c/video.js")),$(document).append($("<link>").attr("href","http://vjs.zencdn.net/c/video-js.css").attr("rel","stylesheet")),d.handleError=function(){var a=$(".dropzone").css("background-color"),b=$(".dropzone").css("border-color");$(".dropzone").animate({"background-color":"#f2dede","border-color":"#b94a48"},1e3,function(){$(this).animate({"background-color":a,"border-color":b},1e3)})},d.handleEDA=function(a){console.log("Loading file...");var b=new FileReader;b.onload=function(b){console.log(b.target);var c="EDA"+($("div.edaGraph").length+1);$("#"+d.id).append($("<div>").attr("id",c).addClass("edaGraph").addClass("row-fluid"));var e=new qLogFile;return e.progress="progress-indicator-"+parseInt(1e4*Math.random(),10),new Loader("#"+c,e.progress),d.fileContents=b.target.result,e.loadText(b.target.result,function(){var a=this;console.log("Preparing to graph");var b=new Grapher(document.getElementById(c));$("#"+c).find(".loader").remove(),b.plot(a),d.graphs.push(b),d.callback(d.graphs)},a.name),!1},b.readAsBinaryString(a)},d.setupHandlers=function(){console.log("Video Width: "+$("video").width()),$("video").attr("height",320),$("video").attr("width","auto");for(var a=0;a<d.videoFiles.length;a++){var b=d.videoFiles[a];$("#"+b.id).css("margin-left",($("#"+d.id).width()-$("#"+b.id).width())/2),b.addEvent("timeupdate",function(){if($("#"+this.id).attr("data-start-time"))var a=new Date(parseInt($("#"+this.id).attr("data-start-time")));else{var b=$("#"+this.id).find("video").attr("filename"),c=b.split(" ")[0].split("-").map(parseInt),e=b.split(" ")[1].split(".m")[0].split("_").map(parseFloat);console.log(c+" "+e);var a=new Date(c[0],c[1]-1,c[2],e[0],e[1],Math.floor(e[2]),1e3*(e[2]-Math.floor(e[2])));$("#"+this.id).attr("data-start-time",a.valueOf())}console.log("Current Time: "+this.currentTime());for(var f=new TimeDelta(1e3*this.currentTime()),g=0;g<d.graphs.length;g++){var h=d.graphs[g];try{h.updateCursor(a.add(f))}catch(i){console.log(i)}}})}if(d.bookmark)for(var c=d.bookmark.split("-").map(parseInt),e=60*60*c[0]+60*c[1]+c[0],a=0;a<d.videoFiles.length;a++)d.videoFiles[a].currentTime(e),console.log("Current time for video: "+d.videoFiles[a].id+" is "+d.videoFiles[a].currentTime()),d.videoFiles[a].play(),d.videoFiles[a].pause(),setTimeout(function(){d.videoFiles[a].play(),d.videoFiles[a].pause()},400)},d.handleVideo=function(a){console.log("Got video file: "+a.name);var b=a,c=window.webkitURL.createObjectURL(a),e=b.name,f=b.type,g="video"+parseInt(1e3*Math.random()+"",10);$("#"+d.id).prepend($("<video>").attr("controls","").attr("class","video-js vjs-default-skin video").attr("filename",e).attr("preload","auto").attr("id",g).attr("name","media").attr("src",c).attr("type",f)),$("#"+d.id).css("width","auto"),$("#"+d.id).css("height","auto"),_V_(g).ready(function(){var a=this;console.log("Video loaded!"),a.size(d.vsize.width,d.vsize.height),d.videoFiles.push(a)})},d.dropzone=new Dropzone(d.id,function(a,b){if(b)return setTimeout(d.setupHandlers,500),d.callback(d.graphs),void 0;console.log(a);var c=a.name.split(".")[a.name.split(".").length-1].toLowerCase();switch(c){case"eda":d.handleEDA(a);break;case"reda":d.handleEDA(a);break;case"csv":d.handleEDA(a);break;case"avi":d.handleVideo(a);break;case"mp4":d.handleVideo(a);break;case"bookmark":d.bookmark=a.name.split(".")[0];break;default:d.handleError(a)}return!1},{label:"Drop folder here to view",allowFolders:!0})};$(document).on("keydown",function(a){switch(a.which){case 39:if($("video").length>0)_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()+.02);else for(var b=0;b<graphers.length;b++){var c=graphers[b],d=c.datasource.timeForOffset(c.datasource.x(0)).add(1e3),a=c.datasource.timeForOffset(c.datasource.x(c.w)).add(1e3);c.zoom(d,a,"zoomin")}break;case 8:break;case 37:case 33:if($("video").length>0)console.log("Video time: "+_V_($("video").attr("id")).currentTime()),_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()-.02);else for(var b=0;b<graphers.length;b++){var c=graphers[b],d=c.datasource.timeForOffset(c.datasource.x(0)).sub(1e3),a=c.datasource.timeForOffset(c.datasource.x(c.w)).sub(1e3);c.zoom(d,a,"zoomin")}break;default:return}}),d3&&(d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})});var Grapher=function(a,b){var c=this;this.container=a,this.unrendered=!0,this.opts=b||{},this.channels=this.opts.channel||["EDA"],this.autoscale=this.opts.autoscale||!0,c.showAcc=!1,this.units={EDA:"μS",X:"gs",Y:"gs",Z:"gs",Tonic:"μS",Phasic:"μS"},this.spinOpts={lines:13,length:21,width:12,radius:30,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:!0,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},d3?(this.renderer="svg",this.graph=$(a)):(this.renderer="canvas",this.graph=$("<canvas>"),$(this.container).append(this.graph)),this.width=$(a).width(),this.height=$(a).height(),this.plot=function(a,b){b&&(c.readyCallback=b);try{c.spinner||(c.spinner=new Spinner(c.spinOpts).spin(document.getElementById(c.graph[0].id)))}catch(d){console.log("Spinner error: "+d.toString())}void 0!=a&&("svg"==c.renderer?c.unrendered?(a.isEDAFile?(c.isEDA=!0,c.renderData(a),c.addPicker()):c.renderSVG(a),c.unrendered=!1):a.isEDAFile?c.renderUpdate(a):c.updateSVG(a):c.renderCanvas(a)),c.spinner&&c.spinner.stop()},this.channelSelectHandler=function(a){var b=$(c.container);$(this).toggleClass("selected-channel");var d=[];$(b).find("#channel-select li a.selected-channel").each(function(a,b){d.push($(b).text())}),console.log("New Selected Channels: "+d),c.setChannels(d),$(b).find("#channel-select li.ignore").remove();var e=$(b).find("#channel-select li").remove().sort(function(a,b){return $(a).find("a").hasClass("selected-channel")&&!$(b).find("a").hasClass("selected-channel")?-1:$(b).find("a").hasClass("selected-channel")&&!$(a).find("a").hasClass("selected-channel")?1:0});e.prependTo($(b).find("#channel-select")),$(b).find("#channel-select li a.selected-channel").last().parent().after('<li class="divider ignore"></li><li role="presentation" class="dropdown-header ignore">Other Channels</li>'),$(b).find("#channel-select li a.selected-channel").first().parent().before('<li role="presentation" class="dropdown-header ignore">Visible Channels</li>'),$(b).find("#channel-select li a").on("click",c.channelSelectHandler),$(".channel-select-dropdown").sortable({items:"li:has(.selected-channel)",cancel:".ignore"}),a.stopPropagation()},this.addPicker=function(){var a=$(c.container);$(c.container).prepend($("<div>").addClass("btn-toolbar").addClass("pull-right").css("margin-bottom",-50).append($("<div>").addClass("btn-group").append($("<button>").attr("class","btn btn-info dropdown-toggle").attr("data-toggle","dropdown").attr("href","#").html("Channels\n<span class='caret'></span>")).append($("<ul>").addClass("dropdown-menu channel-select-dropdown").attr("id","channel-select").attr("role","menu")))),$(a).find("#channel-select").empty(),$(a).find("#channel-select");var b=c.datasource;b.channels.forEach(function(b){"length"!=b&&($(a).find("#channel-select").append($("<li>").html("<a href='#'>"+b+"</a>")),console.log("Adding channel: "+b))}),$(a).find("#channel-select li a").each(function(a,b){console.log(b),console.log(c.channels.find($(b).text())),c.channels.find($(b).text()).length>0?$(b).attr("class","selected-channel"):$(b).attr("class","")}),$(a).find("#channel-select li a").on("click",c.channelSelectHandler),$(a).find("#channel-select").on("sortupdate",function(){var b=[];$(a).find("#channel-select li a").each(function(a,b){c.datasourceContainer.select("#"+$(b).text()).datum(a)}),c.datasourceContainer.selectAll("path").sort(d3.ascending);var b=[];$(a).find("#channel-select li a.selected-channel").each(function(a,c){b.push($(c).text())}),c.setChannels(b)})},this.renderCanvas=function(a){for(var b=c.graph.getContext("2d"),d=$(canvas).width(),e=$(canvas).height(),f=1*d/a.length,g=1*e/(a.max()-a.min()),h=1;h<a.length;h++){var i=a[h-1],j=a[h];b.moveTo((h-1)*f,e-i*g),b.lineTo(h*f,e-j*g),b.stroke(),b.fill()}},this.renderData=function(a){c.datasource=a,c.datasource.channels.find("Tonic").length>0&&c.datasource.channels.find("Phasic").length>0&&(console.log("Turning on tonic and phasic since they are present"),c.channels=["EDA","Tonic","Phasic"]);var b=this.container,d=$(b).width()/5<25?$(b).width()/5:25;c.w=$(b).width()-3*d,c.h=$(b).height()-2*d,c.datasource.x=d3.scale.linear().domain([0,c.w]).range([0,c.datasource.data.length]),c.datasource.y=d3.scale.linear().domain([0,c.h]).range([c.channels.map(function(a){return c.datasource.data[a].max()}).max(),c.channels.map(function(a){return c.datasource.data[a].min()}).min()]),localStorage.range={xmin:0,xmax:c.datasource.data.length-1,ymin:0,ymax:10},c.datasource.getMultiChannelDataForOffsetRange(c.channels,0,c.datasource.data.length-1,c.w,function(a){c.renderSVG(a)})},this.zoom_rect={},this.resize=function(a,b){var d=this.container;void 0!=b&&($(d).css("width",b),$(d).find("svg").attr("width",b),c.p=$(d).width()/5<25?$(d).width()/5:25,c.w=$(d).width()-3*p,c.datasourceContainer.attr("width",c.w)),void 0!=a&&($(d).css("height",a),$(d).find("svg").attr("height",a),c.h=$(d).height()-2*c.p,c.datasourceContainer.attr("height",c.h)),c.currentRange?c.renderUpdate(c.currentRange):c.renderUpdate()},this.setChannels=function(a){for(var b=[],d=0;d<a.length;d++){var e=a[d];c.datasource.data.hasOwnProperty(e)&&(b.push(e),0==c.channels.find(e).length&&("X"==e||"Y"==e||"Z"==e?c.datasourceContainer.append("path").attr("d","").attr("class",e.toLowerCase()).attr("id",e):c.datasourceContainer.append("path").attr("d","").attr("class",e.toLowerCase()).attr("clip-path","url(#edaclip)").attr("id",e)))}for(var d=0;d<c.channels.length;d++){var e=c.channels[d];0==b.find(e).length&&c.datasourceContainer.select("#"+e).remove()}c.channels=b;var f=1==c.showAcc;c.channels.find("X").length>0||c.channels.find("Y").length>0||c.channels.find("Z").length>0?c.showAcc=!0:(c.showAcc=!1,c.datasourceContainer.selectAll(".Acc").remove(),c.datasourceContainer.selectAll(".axis-label-Acc").remove(),!c.showAcc&&f&&c.datasourceContainer.attr("height",c.h)),$(c.container).find("#channel-select li a").each(function(a,b){console.log(b),console.log(c.channels.find($(b).text())),c.channels.find($(b).text()).length>0?$(b).attr("class","selected-channel"):$(b).attr("class","")}),c.currentRange?c.renderUpdate(c.currentRange):c.renderUpdate(),c.datasourceContainer.selectAll(".marker").moveToFront()},this.renderSVG=function(a){c.data=a;var b,d,e,f,g,h,i,j;f=c.container,b=$(f).width()/10<50?$(f).width()/10:50,c.p=b,d=$(f).width()-2*b,e=c.showACC?2*($(f).height()-3*b)/3:$(f).height()-2*b,c.w=d,c.h=e,c.datasource.x.domain([0,a.map(function(a){return a.length}).max()]);var k=d3.scale.linear().domain([0,c.w]).range([0,d]);if(c.datasource.y&&!c.autoscale)var l=[c.datasource.y.range()[1],c.datasource.y.range()[0]],m=d3.scale.linear().domain(l).range([c.h,0]);else var m=d3.scale.linear().domain([a.map(function(a){return a.min()}).min(),a.map(function(a){return a.max()}).max()]).range([c.h,0]);if(c.showAcc){m=m.range([c.h*(2/3),0]);for(var n=[],o=0;o<c.channels.length;o++)("X"==c.channels[o]||"Y"==c.channels[o]||"Z"==c.channels[o])&&n.push(c.data[o]);
var j=d3.scale.linear().domain([n.map(function(a){return a.min()}).min(),n.map(function(a){return a.max()}).max()]).range([c.h*(2/3),c.height]);i=d3.svg.line().x(function(a,b){return k(b)}).y(function(a){return j(a)})}h=d3.svg.line().x(function(a,b){return k(b)}).y(function(a){return m(a)}),c.x=k,c.y=m,c.y2=j,c.lineAcc=i,c.svg=d3.select(f).append("svg").attr("class","graph").attr("width",d+2*b).attr("height",e+3*b).on("mousedown",c.mousedown).on("mouseup",c.mouseup),g=c.svg.append("g").attr("transform","translate("+2*b+","+b+")"),g.append("defs").append("svg:clipPath").attr("id","edaclip").append("svg:rect").attr("id","clip-rect").attr("x","0").attr("y","0").attr("width",d).attr("height",e),c.datasourceContainer=g,c.renderGrid(c.datasourceContainer,"EDA");for(var o=0;o<c.channels.length;o++)a[o].unshift(0),a[o].push(0),"X"!=c.channels[o]&&"Y"!=c.channels[o]&&"Z"!=c.channels[o]||!c.showAcc?g.append("path").attr("d",h(a[o])).attr("class",c.channels[o].toLowerCase()).attr("clip-path","url(#edaclip)").attr("id",c.channels[o]):g.append("path").attr("d",c.lineAcc(a[o])).attr("class",c.channels[o].toLowerCase()).attr("id",c.channels[o]);if(c.datasource.events&&c.datasource.events.length>0){c.eventIdx=[];for(var o=0;o<c.datasource.events.length;o++){var p=c.datasource.events[o];c.eventIdx.push(p.index),console.log("Marker at "+p+"("+c.datasource.x.invert(p.index)+"px in current coordinate space) or "+c.datasource.timeForOffset(p.index).toTimeString()),g.append("circle").datum(p).attr("class","marker").attr("title",function(a){return a.comment+" | Time: "+c.datasource.timeForOffset(a.index).toTimeString()}).attr("cx",function(a){return c.x(c.datasource.x.invert(a.index))}).attr("cy",function(a){var b=Math.round(c.x(c.datasource.x.invert(a.index)));return b<c.data[c.data.length-1].length&&b>=0?c.y(c.data[c.data.length-1][b]):0}).attr("r",3).style("stroke","rgba(200,0,0,1.0)").style("fill","rgba(200,0,0,0.5)").style("stroke-width",2),$("circle.marker").tooltip({container:"body",placement:"top"})}}c.readyCallback&&!c.didLoad&&(c.didLoad=!0,c.readyCallback(c))},this.tooltip=function(){var a=d3.mouse(this);c.datasourceContainer.select("g.gtooltip circle").attr("cx",a[0]).attr("cy",c.y(c.data[a[0]-2*c.p])).attr("r",8),c.datasourceContainer.select("text.gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).text(c.datasource.timeForOffset(c.datasource.x(a[0]-2*c.p)).toTimeString()+" | "+c.datasource.y(a[1]-c.p).toFixed(2).toString())},this.mouseover=function(){var a=d3.mouse(this);c.datasourceContainer.append("svg:g").attr("class","gtooltip").enter().append("svg:circle").attr("class",c.channels[0].toLowerCase()).style("stroke-width",3).attr("cx",a[0]).attr("cy",c.y(c.data[a[0]-2*c.p])).attr("r",8).append("svg:text").attr("class","gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).attr("dy",-5).attr("text-anchor","middle").text(c.datasource.timeForOffset(c.datasource.x(a[0]-2*c.p)).toTimeString()+" | "+c.datasource.y(a[1]-c.p).toFixed(2).toString())},this.mousedown=function(){c.zoom_rect.p1=d3.mouse(this),c.zoom_rect.p2=d3.mouse(this),c.datasourceContainer.select("rect.zoomrect").remove(),c.datasourceContainer.append("svg:rect").attr("class","zoomrect").attr("x",function(){return c.zoom_rect.p1[0]}).attr("y",function(){return c.zoom_rect.p1[1]}).style("stroke","red").style("stroke-width",2).style("fill","rgba(255,0,0,0)").attr("width",Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0])).attr("height",Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1])),c.datasourceContainer.on("mousemove",function(){var a=d3.mouse(this);c.zoom_rect.p2=a;var b=c.zoom_rect.p1[0]<c.zoom_rect.p2[0]?c.zoom_rect.p1[0]:c.zoom_rect.p2[0],d=c.zoom_rect.p1[1]<c.zoom_rect.p2[1]?c.zoom_rect.p1[1]:c.zoom_rect.p2[1],e=Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0]),f=Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1]);c.autoscale?c.datasourceContainer.select("rect.zoomrect").attr("x",b).attr("y",0).attr("width",e).attr("height",c.h):c.datasourceContainer.select("rect.zoomrect").attr("x",b).attr("y",d).attr("width",e).attr("height",f)})},this.zoom=function(a,b){var d=c.datasourceContainer[0][0].getBoundingClientRect();if(a<=c.datasource.startTime&&b>=c.datasource.endTime||$(c.container).append($("<button>").addClass("btn").addClass("clearButton").css("display","block").css("position","absolute").css("left",$(c.container).width()-44-54).css("top",d.top+scrollY+c.p+10).html("<i class='glyphicon glyphicon-zoom-out'></i> Zoom Out").on("click",function(){return $("button.clearButton").remove(),c.renderUpdate("full"),void 0!=c.onzoom&&c.onzoom(c.datasource.startTime,c.datasource.endTime,"zoomout"),!1})),void 0==a&&void 0==b)try{var e=[c.zoom_rect.p1[0],c.zoom_rect.p2[0]].min(),f=[c.zoom_rect.p1[0],c.zoom_rect.p2[0]].max(),g=[c.zoom_rect.p1[1],c.zoom_rect.p2[1]].min()-c.p,h=[c.zoom_rect.p1[1],c.zoom_rect.p2[1]].max()-c.p}catch(i){}if(c.isEDA){a<c.datasource.startTime&&(a=c.datasource.startTime,console.log("Got start time: "+a+" that was earlier than EDA start time: "+c.datasource.startTime)),b>c.datasource.endTime&&(b=c.datasource.endTime.sub(TimeDelta(1)),console.log("Got end time: "+b+" that was later than EDA end time: "+c.datasource.endTime));var j={};j.xmin=a?int(c.datasource.offsetForTime(a)):int(c.datasource.x(e)),(isNaN(j.xmin)||j.xmin<0)&&(j.xmin=0),j.xmax=b?int(c.datasource.offsetForTime(b)):int(c.datasource.x(f)),(isNaN(j.xmax)||j.xmax>c.datasource.offsetForTime(c.datasource.endTime))&&(j.xmax=c.channels.map(function(a){return c.datasource.data[a].length}).min()),j.ymin=c.datasource.y(h)||0,j.ymax=c.datasource.y(g)||1,console.log("Before onzoom with Start="+c.datasource.timeForOffset(j.xmin)+" End="+c.datasource.timeForOffset(j.xmax)),c.currentRange=j,c.renderUpdate(j)}else c.updateSVG(c.data.slice(e,f));void 0!=c.onzoom&&void 0==a&&void 0==b&&c.onzoom(c.datasource.timeForOffset(j.xmin),c.datasource.timeForOffset(j.xmax))},this.mouseup=function(){c.datasourceContainer.on("mousemove",null),c.datasourceContainer.select("rect.zoomrect").remove();var a=Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0]),b=Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1]);a>3&&b>3&&c.zoom()},this.updateCursor=function(a){var b=c.datasource.offsetForTime(a);c.datasourceContainer.selectAll("line.cursor").remove(),c.followCursor?c.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",c.h).attr("x1",c.w/2).attr("x2",c.w/2):c.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",c.h).attr("x1",c.datasource.x.invert(b)).attr("x2",c.datasource.x.invert(b))},this.renderUpdate=function(a){if("full"==a||void 0==a||null==a){var a={};a.xmin=0,a.xmax=c.channels.map(function(a){return c.datasource.data[a].length}).min()-1,a.ymin=c.channels.map(function(a){return c.datasource.data[a].min()}).min(),a.ymax=c.channels.map(function(a){return c.datasource.data[a].max()}).max()}localStorage.range=JSON.stringify(a),c.currentRange=a,c.datasource.x=d3.scale.linear().domain([0,c.w]).range([a.xmin,a.xmax]),c.datasource.y=d3.scale.linear().domain([0,c.h]).range([a.ymax,a.ymin]);var b=a.xmax-a.xmin>c.w?c.w:a.xmax-a.xmin;c.datasource.getMultiChannelDataForOffsetRange(c.channels,a.xmin,a.xmax,b,c.updateSVG)},this.updateSVG=function(a){console.log("Updating SVG"),a.length>c.channels.length&&(console.log("It's happening again.."),a=a.slice(1,a.length-1)),console.log(a),c.datasource.x.domain([0,a.map(function(a){return a.length}).max()]);var b=d3.scale.linear().domain([0,a.map(function(a){return a.length}).max()]).range([0,c.w]);if(c.datasource.y&&!c.autoscale)var d=[c.datasource.y.range()[1],c.datasource.y.range()[0]],e=d3.scale.linear().domain(d).range([c.h,0]);else if(c.showAcc){for(var f=[],g=0;g<a.length;g++)"X"!=c.channels[g]&&"Y"!=c.channels[g]&&"Z"!=c.channels[g]&&f.push(a[g]);var e=d3.scale.linear().domain([f.map(function(a){return a.min()}).min(),f.map(function(a){return a.max()}).max()]).range([c.h*(2/3),0])}else var e=d3.scale.linear().domain([a.map(function(a){return a.min()}).min(),a.map(function(a){return a.max()}).max()]).range([c.h,0]);if(c.showAcc){for(var h=[],g=0;g<c.channels.length;g++)("X"==c.channels[g]||"Y"==c.channels[g]||"Z"==c.channels[g])&&h.push(a[g]);c.y2=d3.scale.linear().domain([h.map(function(a){return a.min()}).min(),h.map(function(a){return a.max()}).max()]).range([c.h,c.h*(2/3)+c.p/3]);var i=d3.svg.line().x(function(a,c){return b(c)}).y(function(a){return c.y2(a)})}c.x=b,c.y=e,c.datasourceContainer.select("#edaclip rect").attr("height",e.range().max()-e.range().min()).attr("y",e.range().min());var j=d3.svg.line().x(function(a,c){return b(c)}).y(function(a){return e(a)});c.data=a,c.renderGrid(c.datasourceContainer,"EDA",b,e),c.showAcc&&c.renderGrid(c.datasourceContainer,"Acc",c.x,c.y2);for(var g=0;g<c.channels.length;g++)a[g].unshift(0),a[g].push(0),console.log("Updating Data for "+c.channels[g]),"X"!=c.channels[g]&&"Y"!=c.channels[g]&&"Z"!=c.channels[g]||!c.showAcc?c.datasourceContainer.select("#"+c.channels[g]).transition(500).attr("d",j(a[g])):c.datasourceContainer.select("#"+c.channels[g]).transition(500).attr("d",i(a[g]));c.datasourceContainer.selectAll(".marker").transition().duration(500).attr("cx",function(a){return c.x(c.datasource.x.invert(a.index))}).style("opacity",function(a){var b=Math.round(c.x(c.datasource.x.invert(a.index)));return b<c.data[0].length&&b>=0?1:0}).attr("cy",function(a){var b=Math.round(c.datasource.x.invert(a.index));return c.showAcc?b<f[f.length-1].length&&b>=0?c.y(f[f.length-1][b]):0:b<c.data[c.data.length-1].length&&b>=0?c.y(c.data[c.data.length-1][b]):0})},this.renderGrid=function(a,b,d,e,f,g){var b=b||"EDA",d=d||c.x,e=e||c.y,g=g||c.w,f=f||e.range().max()-e.range().min(),h=this.p;c.datasourceContainer.selectAll("#background-rect-"+b).remove(),a.append("svg:rect").attr("class","background "+b).attr("id","background-rect-"+b).attr("x",0).attr("y",e.range().min()).attr("width",g).attr("height",f),a.selectAll("g."+b).remove();var i=a.selectAll("g.x."+b).data(d.ticks(5)).enter().append("svg:g").attr("class","x "+b);i.append("svg:line").attr("class","grid").style("shape-rendering","crispEdges").attr("x1",d).attr("x2",d).attr("y1",e.range().min()).attr("y2",e.range().max()),"Acc"!=b&&i.append("svg:text").attr("class","xText "+b).attr("x",d).attr("y",c.h+10).attr("dy",".35em").attr("text-anchor","middle").text(function(a){return c.datasource.timeForOffset(c.datasource.x(a)).shortString()});var j=f>100?10:3,k=a.selectAll("g.y."+b).data(e.ticks(j)).enter().append("svg:g").attr("class","y "+b);k.append("svg:line").attr("class","grid "+b).style("shape-rendering","crispEdges").attr("x1",0).attr("x2",g).attr("y1",e).attr("y2",e),k.selectAll(".yText").remove(),k.append("svg:text").attr("class","yText "+b).attr("x",-3).attr("y",e).attr("dy",".35em").attr("text-anchor","end").text(function(a){return a.toFixed(2).toString()}),c.datasourceContainer.selectAll("text.axis-label-"+b).remove();var l="";l=b,c.units.hasOwnProperty(b)&&(l+=" ("+c.units[b]+")");var m=e.range().min()+(e.range().max()-e.range().min())/2;a.append("svg:text").attr("class","axis-label axis-label-"+b).attr("x",0).attr("y",m).attr("dy","0em").attr("dx","-"+h+"px").attr("text-anchor","middle").attr("transform","rotate(-90, "+-c.p+", "+m+")").text(l),c.datasourceContainer.selectAll("text.title").remove(),a.append("svg:text").attr("class","title").attr("x",g/2).attr("y",0).attr("dy","-"+h/4+"px").attr("dx",0).attr("text-anchor","middle").text(c.datasource.filename)}};