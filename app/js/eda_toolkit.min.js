/**
* EDA Toolkit
* Copyright 2013 Oliver Wilder-Smith 
* http://www.apache.org/licenses/LICENSE-2.0
*/
var e=Math.E;var pi=Math.PI;var np={};var MU="μ";urlParams=function(){var a=location.search.substring(1).split("&");var b={};var c={"true":true,"false":false,"null":null};for(var d=0,e=a.length;d<e;d++){var f=a[d];var g=f.indexOf("=");var h=g==-1?f:f.substring(0,g);var i=g==-1?true:f.substring(g+1);if(i in c){i=c[i]}else if(""+parseFloat(i,10)==i){i=parseFloat(i,10)}b[h]=i}a=c=null;return function j(a){return a in b?b[a]:null}}();float=function(a){return a*1};int=function(a){return parseInt(a,10)};pow=function(a,b){return Math.pow(a,b)};round=function(a,b){var b=b||0;return a.toFixed(b)};String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1};var log=function(a){if(window.console){console.log(a)}};var toast=function(a){var b=document.createElement("div");b.className="toast alert alert-info";b.innerHTML=a;b.style.position="absolute";b.style.display="block";b.style.width="30%";b.style.left="50%";b.style.top="50%";b.style["margin-left"]="-15%";b.style["margin-top"]="0px";document.getElementsByTagName("body")[0].appendChild(b);$(".toast").fadeOut(0);$(".toast").fadeIn(500);setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(a,b){return a.toFixed(b)};function testBit(a,b){var c=1<<b;return a&c}function truncate(a,b){var b=b||0;return Math.trunc(a*pow(10,b))/float(pow(10,b),b)}function unpackStruct(a){var b=[];for(var c=0;c<a.length;c+=2){var d=a.charCodeAt(c);var e=a.charCodeAt(c+1);var f=d*256+e;b.push(f)}return b}function unpackSigned(a){var b=testBit(a,15)>0;var c=a>>13&3;var d=float(a&1023)/1e3;if(b)return truncate(round(-1*d*pow(10,c),3-c),3-c);else return truncate(round(d*pow(10,c),3-c),3-c)}function unpackUnsigned(a){var b=a>>14&3;var c=float(a&16383)/1e4;return truncate(round(c*pow(10,b),4-b),4-b)}Number.prototype.pad=function(a){var b=""+this;var c=b.length-a;for(var d=0;d<c;d++){b="0"+b}return b};Date.prototype.toQFormat=function(){var a="";a+=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate();a+=" ";a+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2);a+=" ";a+="Offset:"+(this.getTimezoneOffset()>0?"+"+this.getTimezoneOffset():this.getTimezoneOffset());return a};Array.prototype.isValid=function(){var a=this;return a.filter(function(a){return!isNaN(a)}).length==a.length};parseDate=function(a){var b=a.split(" ")[0];var c=a.split(" ")[1];var d=float(a.split(" ")[2].split(":")[1]);var e=int(b.split("-")[0]);var f=int(b.split("-")[1]-1);var g=int(b.split("-")[2]);var h=int(c.split(":")[0]);var i=int(c.split(":")[1]);var j=int(c.split(":")[2]);return new Date(e,f,g,h,i,j,0)};var TimeDelta=function(a){var b={};if(!a.isPrototypeOf(Object)){b.days=Math.floor(a/(1e3*60*60*24));b.hours=Math.floor(a%(1e3*60*60*24)/(1e3*60*60));b.minutes=Math.floor(a%(1e3*60*60)/(1e3*60));b.seconds=Math.floor(a%(1e3*60)/1e3);b.milliseconds=Math.floor(a%1e3)}else{b.days=a.days||0;b.hours=a.hours||0;b.minutes=a.minutes||0;b.seconds=a.seconds||0;b.milliseconds=a.milliseconds||0}b.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)};b.valueOf=function(){var a=0;a+=1e3*60*60*24*this.days;a+=1e3*60*60*this.hours;a+=1e3*60*this.minutes;a+=1e3*this.seconds;a+=this.milliseconds;return a};return b};Date.prototype.sub=function(a){var b=this.valueOf()-a.valueOf();return TimeDelta(b)};Date.prototype.add=function(a){return new Date(this.valueOf()+TimeDelta(a).valueOf())};Date.prototype.addMilliseconds=function(a){var b=new Date(this.valueOf()+a);return b};Date.prototype.addSeconds=function(a){return this.addMilliseconds(a*1e3)};Date.prototype.addMinutes=function(a){return this.addSeconds(60*a)};Date.prototype.addHours=function(a){return this.addMinutes(60*a)};Date.prototype.addDays=function(a){return this.addHours(24*a)};Date.prototype.getMinutesSinceMidnight=function(){var a=new Date(this.toString());a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);var b=(a.valueOf()-this.valueOf())/(60*1e3);return b};Date.prototype.shortString=function(a){if(a){return this.toLocaleDateString()+" "+this.toLocaleTimeString()}else{return this.toLocaleTimeString()}};String.prototype.contains=function(a){return this.indexOf(a)>-1};String.prototype.isnum=function(){try{var a=parseFloat(this.toString());return true}catch(b){return false}};String.prototype.isdate=function(){try{var a=new Date(this.toString());if(!a.valueOf().isNaN()){return true}else{return false}}catch(b){return false}};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());if(b!=NaN){return b}else{return this.toString()}}catch(a){return this.toString()}}};guess=function(a){if(typeof a!="string"){return typeof a}else if(a.isdate()){return"date"}else if(a.isnum()){if(a.toString().contains(".")||a.toString().contains(",")){return"float"}else{return"int"}}else{return"unknown"}};autoformat=function(a){var b=guess(a);switch(b){case"float":return float(a);break;case"int":return int(a);break;case"date":return new Date(a);break;default:return a;break}};gaussian=function(a,b){var c=Math.sqrt(b);var d=1/(c*Math.sqrt(2*pi));var f=0;var g=-1*(Math.pow(a-f,2)/(2*c*c));var h=d*Math.pow(e,g);return h};gaussianKernel=function(a,b){var c=new Array;for(var d=-1*b/2;d<b/2;d++){c.push(gaussian(d,a))}return c};gaussianFilter=function(a,b,c){var d=new Array;if(c==undefined){c=100}for(var e=0;e<a.length;e++){var f=e-c/2<0?0:e-c/2;var g=e+c/2>=a.length?a.length-1:e+c/2;var h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};np.timeRange=function(a,b,c){var d=b-a;var e=Math.floor(float(d)/c);var f=new Array;for(var g=0;g<c;g++){f.push(a.addMilliseconds(e*g))}return f};np.arange=function(a,b,c){if(c==undefined){c=1}var d=new Array;for(var e=a;e<b;e+=c){d.push(e)}return d};np.round=function(a,b){var c=a%b;if(c>b/2){a=(Math.round(a/b)+1)*b}else{a=Math.round(a/b)*b}return a};np.map=function(a,b){var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};np.max=function(a){var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};np.min=function(a){var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};convolve=function(a,b){var c=new Array;if(a.length!=b.length){return false}else{for(var d=0;d<a.length;d++){c.push(a[d]*b[d])}return c}};np.sum=function(a){var b=0;for(var c=0;c<a.length;c++){if(!a[c].isNaN()){b+=a[c]}}return b};Array.prototype.max=function(){var a=this.filter(function(a){return!isNaN(a)});var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};Array.prototype.min=function(){var a=this.filter(function(a){return!isNaN(a)});var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};Array.prototype.find=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){if(b[d]==a){c.push(d)}}return c};Array.prototype.map=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};Array.prototype.max=function(){var a=this;var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};Array.prototype.min=function(){var a=this;var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};Array.prototype.map=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};float=function(a){return a*1};int=function(a){return parseInt(a,10)};Array.prototype.clone=function(){var a=this;var b=new Array;for(var c=0;c<a.length;c++){b.push(a[c])}return b};gaussian=function(a,b){var c=Math.sqrt(b);var d=1/(c*Math.sqrt(2*pi));var f=0;var g=-1*(Math.pow(a-f,2)/(2*c*c));var h=d*Math.pow(e,g);return h};gaussianKernel=function(a,b){var c=new Array;for(var d=-1*b/2;d<b/2;d++){c.push(gaussian(d,a))}return c};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());if(b!=NaN){return b}else{return this.toString()}}catch(a){return this.toString()}}};gaussianFilter=function(a,b,c){var d=new Array;if(c==undefined){c=100}for(var e=0;e<a.length;e++){var f=e-c/2<0?0:e-c/2;var g=e+c/2>=a.length?a.length-1:e+c/2;var h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};var np=np||{};np.arange=function(a,b,c){if(c==undefined){c=1}var d=new Array;for(var e=a;e<b;e+=c){d.push(e)}return d};np.round=function(a,b){var c=a%b;if(c>b/2){a=(Math.round(a/b)+1)*b}else{a=Math.round(a/b)*b}return a};np.map=function(a,b){var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};np.max=function(a){var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};np.min=function(a){var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};convolve=function(a,b){var c=new Array;if(a.length!=b.length){return false}else{for(var d=0;d<a.length;d++){c.push(a[d]*b[d])}return c}};np.sum=function(a){var b=0;for(var c=0;c<a.length;c++){if(!a[c].isNaN){b+=a[c]}}return b};np.mean=function(a){return np.sum(a)/(1*a.length)};np.average=np.mean;np.avg=np.mean;np.median=function(a){var b=a.clone();b.sort();var c=int(Math.ceil(a.length/2))-1;if(a.length%2==0){return np.mean(b.slice(c,-c))}else{return b[c]}};var signals=signals||{};signals.sanitize=function(a,b,c){var b=b||[0];var c=c||[NaN];for(var d=0;d<a.length;d++){for(var e=0;e<c.length;e++){if(c[e]=="-"){if(a[d]<0){a[d]=b[e]}}else if(a[d]==c[e]){a[d]=b[e]}}}return a};signals.gaussianFilter=function(a,b){return gaussianFilter(a,b,10)};signals.medianFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.median(a.slice(e,f)))}return c};signals.maxFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.max(a.slice(e,f)))}return c};signals.minFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.min(a.slice(e,f)))}return c};signals.diff=function(a){var b=new Array;for(var c=0;c<a.length-1;c++){b.push(a[c+1]-a[c])}return b};signals.where=function(a,b){var c=new Array;for(var d=0;d<a.length;d++){if(b(a[d])){c.push(d)}}return c};signals.zeroCrossings=function(a){var b=new Array;for(var c=1;c<a.length;c++){if(a[c-1]<0&&a[c]>0){b[c]=1}else if(a[c-1]>0&&a[c]<0){b[c]=-1}else{b[c]=0}}return b};signals.peaks=function(a,b){var c=new Array;var d=signals.diff(a);var e=signals.zeroCrossings(a);var f=signals.where(c,function(a){return a>0});var g=signals.where(c,function(a){return a<0});return[f,g]};var Dropzone=function(a,b,c){var d=this;var c=c||{};d.active=true;d.allowFolders=c.allowFolders||true;d.width=c.width||$("#"+a).width()||300;d.height=c.height||$("#"+a).height()||d.width;d.autoremove=c.autoremove||true;d.callback=b;margin=c.margin||10;d.styles=new StyleSheet;var e=d.styles.addStyle(".dropzone");e.addProperty("background-color: #CCC");e.addProperty("width: "+(d.width-2*margin)+"px");e.addProperty("height: "+(d.height-2*margin)+"px");e.addProperty("margin: "+margin+"px");e.addProperty("border: "+d.width/100+"px dashed");e.addProperty("border-color: #333");e.addProperty("border-radius: 50px");e.addProperty("opacity: 0.75");var f=d.styles.addStyle(".stripes");f.addProperty("background-image: -webkit-linear-gradient(-45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent)");f.addProperty("-webkit-background-size: 100px 100px");var g=document.getElementById(a);g.className+=" dropzone stripes ";if(c.label){var h=$("<h1>").html(c.label);$(g).append(h);var i=$(h).height();$(h).css("margin-top",(d.height-i)/2).css("text-align","center").css("vertical-align","middle")}if(Dropbox){var j=parseInt(Math.random()*1e4).toString();$(g).find("h1").append('<br/><input type="dropbox-chooser" name="selected-file" id="db-chooser-'+j+'" data-link-type="direct" data-multiselect="true" data-extensions=".eda .csv .tsv .avi .webm .mov .mp4 .m4v" />');document.getElementById("db-chooser-"+j).addEventListener("DbxChooserSuccess",function(a){console.log(a);var b=a.files;for(var c=0;c<b.length;c++){var e=b[c];d.callback(e,false,"link")}d.callback({},true);if(d.autoremove){d.remove()}},false)}g.ondragover=function(){if(this.className.indexOf("hover")<0){this.className+=" hover"}return false};g.ondragend=function(){this.className.replace("hover","");return false};g.ondrop=function(a){a.preventDefault();if(d.allowFolders){var b=a.dataTransfer.items[0].webkitGetAsEntry();if(b.isDirectory){if(document.getElementById("foldername")){document.getElementById("foldername").innerHTML=b.name}d.traverseFileTree(b);d.callback({},true);if(d.autoremove){d.remove()}}else{for(var c=a.dataTransfer.files.length-1;c>=0;c--){var e=a.dataTransfer.files[c];d.callback(e)}d.callback({},true);if(d.autoremove){d.remove()}}}else{var e=a.dataTransfer.files[0];d.callback(e);if(d.autoremove){d.remove()}}};d.traverseFileTree=function(a,b){b=b||"";if(a.isFile&&a.name[0]!="."){a.file(function(a){d.callback(a)})}else if(a.isDirectory&&a.name[0]!="."){var c=a.createReader();c.readEntries(function(c){var e=[];for(var f=0;f<c.length;f++){e.push(c[f])}e.sort(function(a,b){return a.name.localeCompare(b.name)});for(var f=0;f<e.length;f++){d.traverseFileTree(e[f],b+a.name+"/")}})}};d.dropzone=g;d.remove=function(){$(g).find("h1").remove();g.className=g.className.replace("dropzone","");g.className=g.className.replace("stripes","");g.ondragover=null;g.ondragend=null;g.ondrop=null;d.active=false}};var Loader=function(a,b){$(a).append($("<div>").addClass("loader").append($("<h2>").text("Loading...")).append($("<div>").attr("id",b).attr("class","progress progress-striped active").append($("<div>").addClass("progress-bar").attr("role","progressbar").attr("style","width: 0%;"))));var c=($(a).height()-$(a).find(".loader").height()-$(a).find("h2").height())/2;$(a).find(".loader").css("margin-top",c)};var StyleSheet=function(){var a=this;a.css=document.createElement("style");a.css.type="text/css";a.styles=[];a.css=document.head.appendChild(a.css);a.addStyle=function(b){var c={};c.selector=b;c.properties=[];a.styles.push(c);c.addProperty=function(b){this.properties.push(b);a.update()};a.update();return c};a.update=function(){var b="\n";for(var c=0;c<a.styles.length;c++){var d=a.styles[c];var e="";e+=d.selector+" {\n";for(var f=0;f<d.properties.length;f++){var g=d.properties[f];e+="    "+g+(g.indexOf(";")>-1?"\n":";\n")}e+="\n}\n\n";b+=e}a.css.innerHTML=b};a.update()};var VideoDroplet=function(a,b,c){var d=this;var c=c||{};d.id=a;d.extension=c.extension||false;d.callback=b;d.vsize=c.vsize||{};d.vsize.width=d.vsize.width||640;d.vsize.height=d.vsize.height||320;d.insertVideo=function(a,b){var c=b.name;var e=b.type;$("#"+d.id).append($("<video>").attr("controls","").attr("class","video-js vjs-default-skin").attr("filename",c).attr("preload","auto").attr("id","video").attr("name","media").attr("src",a).attr("type",e));$("#"+d.id).css("width","auto");$("#"+d.id).css("height","auto");_V_("video").ready(function(){var a=this;a.size(d.vsize.width,d.vsize.height);d.callback(a)})};d.dropzone=new Dropzone(d.id,function(a){var b=new FileReader;d.file=a;if(a.name.endsWith("."+d.extension)||d.extension==false){d.insertVideo(window.webkitURL.createObjectURL(a),a)}else{var c=$("#"+d.id).find(".dropzone").css("background-color");var e=$("#"+d.id).find(".dropzone").css("border-color");$("#"+d.id).find(".dropzone").animate({"background-color":"#f2dede","border-color":"#b94a48"},1e3,function(){$(this).animate({"background-color":c,"border-color":e},1e3)})}return false},{label:"Drop video file here to view"})};var qLogFile=function(){var a=this;this.worker=new Worker("js/eda_toolkit.worker.js");a.isEDAFile=true;a.didAlreadyLoad=false;a.filename="EDA File";a.callbacks={};this.handleMessage=function(b){var c=b.data;switch(c.cmd){case"console":break;case"metadata":a.metadataDidLoad(c.data);break;case"data":a.dataDidLoad(c.data);break;case"scrs":a.callback(c.data);break;case"export":a.callback(c.data);break;case"filter":a.callback(c.data);break;case"progress":a.updateProgress(100*c.progress.toFixed(2));break;case"downsampled":console.log("Got downsampled data back");if(c.key){var d=c.data;console.log(d);a.callbacks[c.key](d)}else{a.callback(c.data);a.callback=null}break;case undefined:break;default:}if(a.validate()&&!a.didAlreadyLoad){a.didAlreadyLoad=true;a.didLoad()}};this.hash=function(){if(!a.didAlreadyLoad){return null}else{var b=a.startTime.toString()+"_"+a.endTime.toString()+"_"+a.filename+"_"+a.data.length*a.data[a.channels[0]][0];return b}};this.load=function(a,b,c){this.url=a;if(c){this.filename=c}else{this.filename=a.split("/").slice(-1)}this.callback=b;if(this.worker==undefined){this.worker=new Worker("js/eda_toolkit.worker.js")}this.worker.onmessage=this.handleMessage;this.worker.postMessage({cmd:"load",url:this.url})};this.loadText=function(a,b,c){this.callback=b;if(c!=undefined)this.filename=c;if(this.worker==undefined){this.worker=new Worker("js/eda_toolkit.worker.js")}this.worker.onmessage=this.handleMessage;this.worker.postMessage({cmd:"loadText",data:a})};this.updateProgress=function(a){if(this.progress!=undefined){$("#"+this.progress).find("div.progress-bar").css("width",Math.round(a)+"%")}else{}};this.didLoad=function(){if(localStorage[a.hash()]!=undefined){var b=JSON.parse(localStorage[a.hash()]);a.rangeMarkers=b.rangeMarkers}if(this.callback!=undefined){this.callback.call(a)}};this.validate=function(){return this.metadata&&this.data};this.metadataDidLoad=function(a){this.metadata=a;this.startTime=this.metadata["Start Time"];this.sampleRate=this.metadata["Sampling Rate"];this.channels=this.metadata["Column Names"].filter(function(a){return!(a.toLowerCase().indexOf("time")>-1||a.toLowerCase().indexOf("date")>-1)})};this.dataDidLoad=function(b){this.data=b;this.events=b.markers;this.data.length=this.channels.map(function(b){return a.data[b].length}).min();var c=this.data.length/this.sampleRate*1e3;this.endTime=this.startTime.addMilliseconds(c);this.duration=this.endTime.sub(this.startTime)};this.setData=function(b,c){if(c.length==a.data.length){for(var d=0;d<a.data.length;d++){a.data[b][d]=c[d]}}else{}};this.getData=function(b){return a.data[b]};this.filter=function(b,c,d){a.callback=function(c){a.setData(b,c);d(a)};var e=a.getData(b);a.worker.postMessage({cmd:"filter",data:{data:e,filterType:c,width:a.sampleRate}})};this.offsetForTime=function(a){var b=a.sub(this.startTime);if(b.valueOf()>=0&&b.valueOf()<this.duration.valueOf()){return Math.round(b.valueOf()/(1e3/this.sampleRate))}else if(b.valueOf()>=0&&b.valueOf()==this.duration.valueOf()){return this.data.length-1}else{throw"Illegal Time: "+a+". Time must be between "+this.startTime+" and "+this.endTime}};this.timeForOffset=function(a){var b=a*(1e3/this.sampleRate);if(b>=0&&b<this.duration.valueOf()){return this.startTime.add(TimeDelta(b))}else if(b>=0&&b==this.duration.valueOf()){return this.endTime}else{console.log("Illegal Offset: "+a+". Offset must be between "+0+" and "+this.data.length-1);return this.startTime.add(TimeDelta(b))}};this.get=function(b,c){var c=c||{};var d=c.start||this.timeForOffset(0);var e=c.end||this.timeForOffset(a.data.EDA.length-1);var f=c.channels||["EDA","X","Y","Z"];var g=c.targetSamples||this.offsetForTime(e)-this.offsetForTime(d);console.log("start: "+d+"("+this.offsetForTime(d)+") \n end: "+e+"("+this.offsetForTime(e)+") \n targetSamples: "+g);a.getMultiChannelDataForOffsetRange(f,this.offsetForTime(d),this.offsetForTime(e),g,function(a){console.log(a);var c=new Array;var h=np.timeRange(d,e,g);for(var i=0;i<a[0].length;i++){var j={};for(var k=0;k<f.length;k++){j[f[k]]=a[k][i]}j["time"]=h[i];c.push(j)}b(c)})};this.getData=function(b,c,d){var e=a.data[b];if(c){var f=(Math.random()*10).toString();a.callbacks[f]=d;if(c>0){this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:data,target:c,key:f}})}else{throw"Target Samples Error: target samples must be greater than 0 and less than "+this.data.length+", not "+c}}else{return e}};this.findSCRs=function(b,c,d){if(c==undefined)c=0;if(d==undefined)d=a.data.EDA.length-1;a.callback=b;a.worker.postMessage({cmd:"scrs",data:{points:this._getDataForOffsetRange("EDA",c,d),width:a.sampleRate}})};this.getDataForOffsetRange=function(b,c,d,e,f){if(b.toLowerCase()=="acc"){a.getMultiChannelDataForOffsetRange(["X","Y","Z"],c,d,e,f)}else{var g=this._getDataForOffsetRange(b,c,d);if(f){var h=(Math.random()*10).toString();a.callbacks[h]=f;this.worker.postMessage({cmd:"downsample",data:{points:g,target:e,key:h}})}else{return g}}};a.getMultiChannelDataForOffsetRange=function(b,c,d,e,f){var g=[];for(var h=0;h<b.length;h++){g.push(this._getDataForOffsetRange(b[h],c,d))}if(f){var i=(Math.random()*10).toString();a.callbacks[i]=f;this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:g,target:e,key:i}})}else{return points}};this._getDataForOffsetRange=function(a,b,c){if(b>=0&&c<this.data.length&&this.data.hasOwnProperty(a)){return this.data[a].slice(b,c)}else{return[]}};this.getDataForTimeRange=function(b,c,d,e,f){var g=this._getDataForTimeRange(b,c,d);if(f){a.callback=f;this.worker.postMessage({cmd:"downsample",data:{points:g,target:e}})}else{return g}};this._getDataForTimeRange=function(a,b,c){var a=a||"EDA";var d=this.offsetForTime(b);var e=this.offsetForTime(c);if(d!=NaN&&end!=NaN){if(this.data.hasOwnProperty(a)){return this.data[a].slice(d,e)}}else{return[]}};this.saveFileAs=function(b){var c=new Blob([b],{type:"text/plain;charset=UTF-8"});saveAs(c,a.filename)};this.savePDF=function(){};this.saveToDropbox=function(b){this.exportToCSV(function(c){b.writeFile(a.filename,c,function(){new Notify("File uploaded to Dropbox!")})})};this.exportToCSV=function(b){if(b){a.callback=b}else{a.callback=a.saveFileAs}a.worker.postMessage({cmd:"export",data:{data:a.data,metadata:a.metadata,useBlob:false}})}};var EDADroplet=function(a,b,c){var d=this;var c=c||{};d.id=a;d.extension=c.extension||"eda";d.callback=b;d.edaFile=new qLogFile;d.edaFile.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);d.draw=function(a){};d.graph=function(a){console.log("Preparing to graph");d.grapher=new Grapher(document.getElementById(d.id));$("#"+d.id).find(".loader").remove();d.grapher.plot(d.edaFile);d.callback(d.edaFile,d.grapher)};d.dropzone=new Dropzone(d.id,function(a){var b=new FileReader;console.log(a);if(a.name.endsWith("."+d.extension)){var c=new Loader("#"+d.id,d.edaFile.progress);console.log("Loading file...");b.onload=function(b){console.log(b.target);d.fileContents=b.target.result;d.edaFile.loadText(b.target.result,d.graph,a.name);return false};b.readAsBinaryString(a)}else{$(".dropzone").addClass("error");setTimeout(function(){$(".dropzone").removeClass("error")},1e3)}return false},{label:"Drop EDA file here to view"})};var FolderDroplet=function(a,b,c){var d=this;var c=c||{};d.id=a;d.extension=c.extension||"eda";d.callback=b;d.vsize=c.vsize||{};d.vsize.width=d.vsize.width||640;d.vsize.height=d.vsize.height||320;d.graphs=[];d.videoFiles=[];d.msg=c.msg||"<i class='icon-folder-open'></i>  Drop folder here to view";$(document).append($("<script>").attr("src","http://vjs.zencdn.net/c/video.js"));$(document).append($("<link>").attr("href","http://vjs.zencdn.net/c/video-js.css").attr("rel","stylesheet"));d.handleError=function(a){$(".dropzone").addClass("error");setTimeout(function(){$(".dropzone").removeClass("error")},1e3)};d.handleEDA=function(a,b){console.log("Loading file...");if(b=="link"){var c="EDA"+($("div.edaGraph").length+1);$("#"+d.id).append($("<div>").attr("id",c).addClass("edaGraph").addClass("row-fluid"));var e=new qLogFile;e.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);var f=new Loader("#"+c,e.progress);e.load(a.link,function(){var a=this;console.log("Preparing to graph");var b=new Grapher(document.getElementById(c));$("#"+c).find(".loader").remove();b.plot(a);d.graphs.push(b);d.callback(d.graphs)},a.name)}else{var g=new FileReader;g.onload=function(b){console.log(b.target);var c="EDA"+($("div.edaGraph").length+1);$("#"+d.id).append($("<div>").attr("id",c).addClass("edaGraph").addClass("row-fluid"));var e=new qLogFile;e.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);var f=new Loader("#"+c,e.progress);d.fileContents=b.target.result;e.loadText(b.target.result,function(){var a=this;console.log("Preparing to graph");var b=new Grapher(document.getElementById(c));$("#"+c).find(".loader").remove();b.plot(a);d.graphs.push(b);d.callback(d.graphs)},a.name);return false};g.readAsBinaryString(a)}};d.setupHandlers=function(a){console.log("Video Width: "+$("video").width());$("video").attr("height",320);$("video").attr("width",$("video").attr("height")*16/9);for(var b=0;b<d.videoFiles.length;b++){var c=d.videoFiles[b];if(d.videoFiles.length==1){$("#"+c.id).css("margin-left",($("#"+d.id).width()-$("#"+c.id).width())/2)}c.addEvent("timeupdate",function(a){if($("#"+this.id).attr("data-start-time")){var b=new Date(parseInt($("#"+this.id).attr("data-start-time")))}else{var c=$("#"+this.id).find("video").attr("filename");var e=c.split(" ")[0].split("-").map(parseInt);var f=c.split(" ")[1].split(".m")[0].split("_").map(parseFloat);console.log(e+" "+f);var b=new Date(e[0],e[1]-1,e[2],f[0],f[1],Math.floor(f[2]),(f[2]-Math.floor(f[2]))*1e3);$("#"+this.id).attr("data-start-time",b.valueOf())}console.log("Current Time: "+this.currentTime());var g=new TimeDelta(this.currentTime()*1e3);for(var h=0;h<d.graphs.length;h++){var i=d.graphs[h];try{i.updateCursor(b.add(g))}catch(j){console.log(j)}}})}if(d.bookmark){var e=d.bookmark.split("-").map(parseInt);var f=e[0]*60*60+e[1]*60+e[0];for(var b=0;b<d.videoFiles.length;b++){d.videoFiles[b].currentTime(f);console.log("Current time for video: "+d.videoFiles[b].id+" is "+d.videoFiles[b].currentTime());d.videoFiles[b].play();d.videoFiles[b].pause();setTimeout(function(){d.videoFiles[b].play();d.videoFiles[b].pause()},400)}}};d.handleVideo=function(a,b){console.log("Got video file: "+a.name);if(b=="link"){var c=a.name;var b="video/"+c.split(".")[c.split(".").length-1];var e=a.link}else{var f=a;var e=window.webkitURL.createObjectURL(a);var c=f.name;var b=f.type}var g="video"+parseInt(Math.random()*1e3+"",10);$("#"+d.id).prepend($("<video>").attr("controls","").attr("class","video-js vjs-default-skin video").attr("filename",c).attr("preload","auto").attr("id",g).attr("name","media").attr("src",e).attr("type",b));$("#"+d.id).css("width","auto");$("#"+d.id).css("height","auto");_V_(g).ready(function(){var a=this;console.log("Video loaded!");a.size(d.vsize.width,d.vsize.height);if($("#"+this.id).attr("data-start-time")){var b=new Date(parseInt($("#"+this.id).attr("data-start-time")))}else{var c=$("#"+this.id).find("video").attr("filename");var e=c.split(" ")[0].split("-").map(parseInt);var f=c.split(" ")[1].split(".m")[0].split("_").map(parseFloat);console.log(e+" "+f);var b=new Date(e[0],e[1]-1,e[2],f[0],f[1],Math.floor(f[2]),(f[2]-Math.floor(f[2]))*1e3);$("#"+this.id).attr("data-start-time",b.valueOf())}if(isNaN(b)){var h=this.id+"_timepicker";$("#"+this.id).popover({type:"auto",title:"<strong>Please specify video start time</strong> <a class='close' href='#' onclick=\"$('#"+this.id+"').popover('hide')\" aria-hidden='true'>&times;</a>",trigger:"manual",html:true,content:'<div class="input-group"><span class="input-group-addon"><i class="icon-time"></i></span><input id="'+h+'" type="text" class="form-control" placeholder="yyyy-mm-dd HH:MM:SS Z"></div>'});$("#"+this.id).popover("show");$("#"+h).on("change",function(){console.log($(this).attr("value"));$("#"+g).attr("data-start-time",moment($(this).attr("value").valueOf()))})}d.videoFiles.push(a)})};var e=function(a,b,c){var c=c||"file_entry";if(b){setTimeout(d.setupHandlers,500);d.callback(d.graphs);return}console.log(a);var e=a.name.split(".")[a.name.split(".").length-1].toLowerCase();switch(e){case"eda":d.handleEDA(a,c);break;case"reda":d.handleEDA(a,c);break;case"csv":d.handleEDA(a,c);break;case"tsv":d.handleEDA(a,c);break;case"avi":d.handleVideo(a,c);break;case"mov":d.handleVideo(a,c);break;case"mp4":d.handleVideo(a,c);break;case"bookmark":d.bookmark=a.name.split(".")[0];break;default:d.handleError(a)}return false};d.dropzone=new Dropzone(d.id,e,{label:d.msg,allowFolders:true});if(urlParams("file")!=null){var f=urlParams("file");var g={};g.link=f;g.name=f.split("/").slice(-1)[0];e(g,false,"link");e({},true,"");d.dropzone.remove()}};$(document).on("keydown",function(a){switch(a.which){case 39:{if($("video").length>0){_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()+.02)}else{for(var b=0;b<graphers.length;b++){var c=graphers[b];var d=c.datasource.timeForOffset(c.datasource.x(0)).add(1e3);var a=c.datasource.timeForOffset(c.datasource.x(c.w)).add(1e3);c.zoom(d,a,"zoomin")}}break}case 8:{break}case 37:case 33:{if($("video").length>0){console.log("Video time: "+_V_($("video").attr("id")).currentTime());_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()-.02)}else{for(var b=0;b<graphers.length;b++){var c=graphers[b];var d=c.datasource.timeForOffset(c.datasource.x(0)).sub(1e3);var a=c.datasource.timeForOffset(c.datasource.x(c.w)).sub(1e3);c.zoom(d,a,"zoomin")}}break}default:return}});if(d3){d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})}}var Grapher=function(a,b){var c=this;this.container=a;this.unrendered=true;this.opts=b||{};this.channels=this.opts.channel||["EDA"];this.autoscale=this.opts.autoscale||true;c.showAcc=false;this.units={EDA:"μ"+"S",X:"gs",Y:"gs",Z:"gs",Tonic:"μ"+"S",Phasic:"μ"+"S"};this.spinOpts={lines:13,length:21,width:12,radius:30,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:true,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};if(d3){this.renderer="svg";this.graph=$(a)}else{this.renderer="canvas";this.graph=$("<canvas>");$(this.container).append(this.graph)}this.width=this.opts.width||$(a).width();this.height=this.opts.height||$(a).height();this.plot=function(a,b){if(b)c.readyCallback=b;try{if(c.spinner){}else{c.spinner=new Spinner(c.spinOpts).spin(document.getElementById(c.graph[0].id))}}catch(d){console.log("Spinner error: "+d.toString())}if(a!=undefined){if(c.renderer=="svg"){if(c.unrendered){if(a.isEDAFile){c.isEDA=true;c.renderData(a);c.addPicker()}else{c.renderSVG(a)}c.unrendered=false}else{if(a.isEDAFile){c.renderUpdate(a)}else{c.updateSVG(a)}}}else{c.renderCanvas(a)}}else{}if(c.spinner){c.spinner.stop()}};this.channelSelectHandler=function(a){var b=$(c.container);$(this).toggleClass("selected-channel");var d=[];$(b).find("#channel-select li a.selected-channel").each(function(a,b){d.push($(b).text())});console.log("New Selected Channels: "+d);c.setChannels(d);$(b).find("#channel-select li.ignore").remove();var e=$(b).find("#channel-select li").remove().sort(function(a,b){if($(a).find("a").hasClass("selected-channel")&&!$(b).find("a").hasClass("selected-channel")){return-1}else if($(b).find("a").hasClass("selected-channel")&&!$(a).find("a").hasClass("selected-channel")){return 1}else{return 0}});e.prependTo($(b).find("#channel-select"));$(b).find("#channel-select li a.selected-channel").last().parent().after('<li class="divider ignore"></li><li role="presentation" class="dropdown-header ignore">Other Channels</li>');$(b).find("#channel-select li a.selected-channel").first().parent().before('<li role="presentation" class="dropdown-header ignore">Visible Channels</li>');$(b).find("#channel-select li a").on("click",c.channelSelectHandler);$(".channel-select-dropdown").sortable({items:"li:has(.selected-channel)",cancel:".ignore"});a.stopPropagation()};this.addPicker=function(){var a=$(c.container);$(c.container).prepend($("<div>").addClass("btn-toolbar").addClass("pull-right").css("margin-bottom",-50).css("margin-right",50).append($("<div>").addClass("btn-group").append($("<button>").attr("class","btn btn-info dropdown-toggle").attr("data-toggle","dropdown").attr("href","#").html("Channels\n<span class='caret'></span>")).append($("<ul>").addClass("dropdown-menu dropdown-menu-right channel-select-dropdown").attr("id","channel-select").attr("role","menu"))));
$(a).find("#channel-select").empty();$(a).find("#channel-select");var b=c.datasource;b.channels.forEach(function(b,c){if(b!="length"){$(a).find("#channel-select").append($("<li>").html("<a href='#'>"+b+"</a>"));console.log("Adding channel: "+b)}});$(a).find("#channel-select li a").each(function(a,b){console.log(b);console.log(c.channels.find($(b).text()));if(c.channels.find($(b).text()).length>0){$(b).attr("class","selected-channel")}else{$(b).attr("class","")}});$(a).find("#channel-select li a").on("click",c.channelSelectHandler);$(a).find("#channel-select").on("sortupdate",function(b){var d=[];$(a).find("#channel-select li a").each(function(a,b){c.datasourceContainer.select("#"+$(b).text()).datum(a)});c.datasourceContainer.selectAll("path").sort(d3.ascending);var d=[];$(a).find("#channel-select li a.selected-channel").each(function(a,b){d.push($(b).text())});c.setChannels(d)})};this.renderCanvas=function(a){var b=c.graph.getContext("2d");var d=$(canvas).width();var e=$(canvas).height();var f=d*1/a.length;var g=e*1/(a.max()-a.min());for(var h=1;h<a.length;h++){var i=a[h-1];var j=a[h];b.moveTo((h-1)*f,e-i*g);b.lineTo(h*f,e-j*g);b.stroke();b.fill()}};this.renderData=function(a){c.datasource=a;if(c.datasource.channels.find("Tonic").length>0&&c.datasource.channels.find("Phasic").length>0&&c.datasource.channels.find("EDA").length>0){console.log("Turning on tonic and phasic since they are present");c.channels=["EDA","Tonic","Phasic"]}else if(c.datasource.channels.find("EDA").length>0){c.channels=["EDA"]}else{c.channels=c.datasource.channels}var b=this.container;var d=$(b).width()/5<25?$(b).width()/5:25;c.w=$(b).width()-3*d;c.h=$(b).height()-2*d;c.datasource.x=d3.scale.linear().domain([0,c.w]).range([0,c.datasource.data.length]);c.datasource.y=d3.scale.linear().domain([0,c.h]).range([c.channels.map(function(a){return c.datasource.data[a].max()}).max(),c.channels.map(function(a){return c.datasource.data[a].min()}).min()]);c.datasource.getMultiChannelDataForOffsetRange(c.channels,0,c.datasource.data.length-1,c.w,function(a){c.renderSVG(a)})};this.zoom_rect={};this.resize=function(a,b){var d=this.container;c.p=$(d).width()/10<50?$(d).width()/10:50;if(b!=undefined){$(d).css("width",b);$(d).find("svg").attr("width",b);c.w=b-3*c.p;c.datasourceContainer.attr("width",c.w)}if(a!=undefined){$(d).css("height",a);$(d).find("svg").attr("height",a);c.h=$(d).height()-2*c.p;c.datasourceContainer.attr("height",c.h)}if(c.currentRange){c.renderUpdate(c.currentRange)}else{c.renderUpdate()}};this.setChannels=function(a){var b=[];for(var d=0;d<a.length;d++){var e=a[d];if(c.datasource.data.hasOwnProperty(e)&&c.datasource.data[e].isValid()){b.push(e);if(c.channels.find(e).length==0){if(e=="X"||e=="Y"||e=="Z"){c.datasourceContainer.append("path").attr("d","").attr("class",e).attr("id",e)}else{c.datasourceContainer.append("path").attr("d","").attr("class",e).attr("clip-path","url(#edaclip)").attr("id",e)}}}}for(var d=0;d<c.channels.length;d++){var e=c.channels[d];if(b.find(e).length==0){c.datasourceContainer.select("#"+e).remove()}}c.channels=b;var f=c.showAcc==true;if(c.channels.find("X").length>0||c.channels.find("Y").length>0||c.channels.find("Z").length>0){c.showAcc=true}else{c.showAcc=false;c.datasourceContainer.selectAll(".Acc").remove();c.datasourceContainer.selectAll(".axis-label-Acc").remove();if(!c.showAcc&&f){c.datasourceContainer.attr("height",c.h)}}$(c.container).find("#channel-select li a").each(function(a,b){console.log(b);console.log(c.channels.find($(b).text()));if(c.channels.find($(b).text()).length>0){$(b).attr("class","selected-channel")}else{$(b).attr("class","")}});if(c.currentRange){c.renderUpdate(c.currentRange)}else{c.renderUpdate()}c.datasourceContainer.selectAll(".marker").moveToFront()};this.unpackComment=function(a){a=a.replace(/^\s+|\s+$/g,"");if(a[0]=="|"){a=a.slice(1,a.length-1)}var b=a.replace(/\|/g,"<br />");return b};this.renderSVG=function(a,b){c.data=a;var d,e,f,g,h,i,j,k;g=c.container;d=$(g).width()/10<50?$(g).width()/10:50;c.p=d;e=$(g).width()-3*d;if(c.showACC){f=2*($(g).height()-3*d)/3}else{f=$(g).height()-2*d}c.w=e;c.h=f;c.datasource.x.domain([0,c.w]);var l=d3.scale.linear().domain([0,a.map(function(a){return a.length}).max()]).range([0,e]);if(c.datasource.y&&!c.autoscale){var m=[c.datasource.y.range()[1],c.datasource.y.range()[0]];var n=d3.scale.linear().domain(m).range([c.h,0])}else{var n=d3.scale.linear().domain([a.map(function(a){return a.min()}).min(),a.map(function(a){return a.max()}).max()]).range([c.h,0])}if(c.showAcc){n=n.range([c.h*(2/3),0]);var o=[];for(var p=0;p<c.channels.length;p++){if(c.channels[p]=="X"||c.channels[p]=="Y"||c.channels[p]=="Z"){o.push(c.data[p])}}var k=d3.scale.linear().domain([o.map(function(a){return a.min()}).min(),o.map(function(a){return a.max()}).max()]).range([c.h*(2/3),c.height]);j=d3.svg.line().x(function(a,b){return l(b)}).y(function(a){return k(a)})}i=d3.svg.line().x(function(a,b){return l(b)}).y(function(a){return n(a)});c.x=l;c.y=n;c.y2=k;c.lineAcc=j;c.svg=d3.select(g).append("svg").attr("class","graph").attr("width",c.width).attr("height",c.height);h=c.svg.append("g").attr("transform","translate("+2*d+","+d+")");h.append("defs").append("svg:clipPath").attr("id","edaclip").append("svg:rect").attr("id","clip-rect").attr("x","0").attr("y","0").attr("width",e).attr("height",f);c.datasourceContainer=h;c.datasourceContainer.on("mousedown",c.mousedown).on("mouseup",c.mouseup).on("dblclick",c.handleDoubleClick);c.renderGrid(c.datasourceContainer,c.channels[0]);for(var p=0;p<c.channels.length;p++){a[p].unshift(0);a[p].push(0);if((c.channels[p]=="X"||c.channels[p]=="Y"||c.channels[p]=="Z")&&c.showAcc){h.append("path").attr("d",c.lineAcc(a[p])).attr("class",c.channels[p]).attr("id",c.channels[p])}else{h.append("path").attr("d",i(a[p])).attr("class",c.channels[p]).attr("clip-path","url(#edaclip)").attr("id",c.channels[p])}}if(c.datasource.events&&c.datasource.events.length>0){c.eventIdx=[];for(var p=0;p<c.datasource.events.length;p++){var q=c.datasource.events[p];c.eventIdx.push(q.index);console.log("Marker at "+q+"("+c.datasource.x.invert(q.index)+"px in current coordinate space) or "+c.datasource.timeForOffset(q.index).toTimeString());h.append("circle").datum(q).attr("class","marker").attr("title",function(a){return c.unpackComment(a.comment+" | Time: "+c.datasource.timeForOffset(a.index).toTimeString())}).attr("cx",function(a){return c.x(c.datasource.x.invert(a.index))}).attr("cy",function(a){var b=Math.round(c.x(c.datasource.x.invert(a.index)));if(b<c.data[c.data.length-1].length&&b>=0){return c.y(c.data[c.data.length-1][b])}else{return 0}}).attr("r",3).style("stroke","rgba(200,0,0,1.0)").style("fill","rgba(200,0,0,0.5)").style("stroke-width",2);$("circle.marker").tooltip({container:"body",html:true,placement:"top"})}}if(c.datasource.rangeMarkers&&c.datasource.rangeMarkers.length>0){c.renderRangeMarkers(c.datasourceContainer,c.x,c.y)}if(c.readyCallback&&!c.didLoad){c.didLoad=true;c.readyCallback(c)}};this.tooltip=function(){var a=d3.mouse(this);c.datasourceContainer.select("g.gtooltip circle").attr("cx",a[0]).attr("cy",c.y(c.data[a[0]-c.p*2])).attr("r",8);c.datasourceContainer.select("text.gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).text(c.datasource.timeForOffset(c.datasource.x(a[0]-2*c.p)).toTimeString()+" | "+c.datasource.y(a[1]-c.p).toFixed(2).toString())};this.mouseover=function(){var a=d3.mouse(this);c.datasourceContainer.append("svg:g").attr("class","gtooltip").enter().append("svg:circle").attr("class",c.channels[0].toLowerCase()).style("stroke-width",3).attr("cx",a[0]).attr("cy",c.y(c.data[a[0]-c.p*2])).attr("r",8).append("svg:text").attr("class","gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).attr("dy",-5).attr("text-anchor","middle").text(c.datasource.timeForOffset(c.datasource.x(a[0]-2*c.p)).toTimeString()+" | "+c.datasource.y(a[1]-c.p).toFixed(2).toString())};this.mousedown=function(){console.log("Mouse click at: "+d3.mouse(this));c.zoom_rect.p1=d3.mouse(this);c.zoom_rect.p2=d3.mouse(this);$(c.graph).find("rect.zoomrect").tooltip("destroy");c.datasourceContainer.select("rect.zoomrect").remove();c.datasourceContainer.append("svg:rect").attr("class","zoomrect").attr("x",c.zoom_rect.p1[0]).attr("y",c.zoom_rect.p1[1]).attr("title","").style("stroke","red").style("stroke-width",2).style("fill","rgba(255,0,0,0.2)").attr("width",Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0])).attr("height",Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1]));c.datasourceContainer.on("mousemove",function(){c.zoom_rect.p2=d3.mouse(this);c.datasourceContainer.on("mouseup",c.mouseup);var a=[c.zoom_rect.p1[0],c.zoom_rect.p2[0]].min();var b=[c.zoom_rect.p1[1],c.zoom_rect.p2[1]].min();var d=Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0]);var e=Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1]);var f=c.datasource.timeForOffset(c.datasource.x([c.zoom_rect.p1[0],c.zoom_rect.p2[0]].min()));var g=c.datasource.timeForOffset(c.datasource.x([c.zoom_rect.p1[0],c.zoom_rect.p2[0]].max()));if(c.autoscale){c.datasourceContainer.select("rect.zoomrect").attr("x",a).attr("y",0).attr("title","<i class='icon-time'></i> "+f.shortString()+" to "+g.shortString()).attr("width",d).attr("height",c.h);if($(".tooltip-inner").length==0){$(c.graph).find("rect.zoomrect").tooltip({container:"body",placement:"top",html:true,trigger:"manual",delay:{show:0,hide:1e3}}).tooltip("show")}else{$(".tooltip-inner").first().html(c.datasourceContainer.select("rect.zoomrect").attr("title"))}}else{c.datasourceContainer.select("rect.zoomrect").attr("x",a).attr("y",b).attr("width",d).attr("height",e)}})};this.zoom=function(a,b,d){try{var e=c.datasourceContainer[0][0].getBoundingClientRect();if(!(a<=c.datasource.startTime&&b>=c.datasource.endTime)){$(c.container).append($("<button>").addClass("btn").addClass("clearButton").css("display","block").css("position","absolute").css("right",107/2).css("top",e.top+scrollY+c.p+10).html("<i class='icon-zoom-out'></i> Zoom Out").on("click",function(a){$(c.container).find("button.clearButton").remove();c.renderUpdate("full");if(c.onzoom!=undefined){c.onzoom(c.datasource.startTime,c.datasource.endTime,"zoomout")}return false}))}else{}if(a==c.datasource.startTime&&b==c.datasource.endTime){$(c.container).find("button.clearButton").remove()}if(a==undefined&&b==undefined){try{var f=[c.zoom_rect.p1[0],c.zoom_rect.p2[0]].min();var g=[c.zoom_rect.p1[0],c.zoom_rect.p2[0]].max();var h=[c.zoom_rect.p1[1],c.zoom_rect.p2[1]].min()-c.p;var i=[c.zoom_rect.p1[1],c.zoom_rect.p2[1]].max()-c.p}catch(j){}}if(a<c.datasource.startTime){a=c.datasource.startTime;console.log("Got start time: "+a+" that was earlier than EDA start time: "+c.datasource.startTime)}if(b>c.datasource.endTime){b=c.datasource.endTime.sub(TimeDelta(1));console.log("Got end time: "+b+" that was later than EDA end time: "+c.datasource.endTime)}var k={};if(a){k.xmin=int(c.datasource.offsetForTime(a))}else{k.xmin=int(c.datasource.x(f))}if(isNaN(k.xmin)||k.xmin<0)k.xmin=0;if(b){k.xmax=int(c.datasource.offsetForTime(b))}else{k.xmax=int(c.datasource.x(g))}if(isNaN(k.xmax)||k.xmax>c.datasource.offsetForTime(c.datasource.endTime)){k.xmax=c.channels.map(function(a){return c.datasource.data[a].length}).min()}k.ymin=c.datasource.y(i)||0;k.ymax=c.datasource.y(h)||1;console.log("Before onzoom with Start="+c.datasource.timeForOffset(k.xmin)+" End="+c.datasource.timeForOffset(k.xmax));c.currentRange=k;c.renderUpdate(k);if(c.onzoom!=undefined&&(a==undefined&&b==undefined)){c.onzoom(c.datasource.timeForOffset(k.xmin),c.datasource.timeForOffset(k.xmax))}}catch(j){console.log(j);c.onzoom(c.datasource.startTime,c.datasource.endTime,"zoomout")}};this.mouseup=function(){$(c.graph).find("rect.zoomrect").tooltip("destroy");c.datasourceContainer.on("mousemove",null);var a=Math.abs(c.zoom_rect.p1[0]-c.zoom_rect.p2[0]);var b=Math.abs(c.zoom_rect.p1[1]-c.zoom_rect.p2[1]);var d=c.datasource.timeForOffset(int(c.datasource.x([c.zoom_rect.p1[0],c.zoom_rect.p2[0]].min())));var e=c.datasource.timeForOffset(int(c.datasource.x([c.zoom_rect.p1[0],c.zoom_rect.p2[0]].max())));if(a>3){var f="ZOOM_ID_"+parseInt(Math.random()*1e3,10).toString();var g="ADD_RANGE_ID_"+parseInt(Math.random()*1e3,10).toString();var h="COMMENT_ID_"+parseInt(Math.random()*1e3,10).toString();var i='<input type="text" class="form-control" placeholder="Comment" id="COMMENT_ID"><br /><input id="COMMENT_ID_COLOR" type="text" value="000"  class="pick-a-color form-control"><br /><div class="btn-group"><button class=\'btn btn-default\' id=\'ZOOM_ID\'><i class=\'icon-zoom-in\'></i> Zoom</button><button class=\'btn btn-primary\' id=\'ADD_RANGE_ID\'><i class=\'icon-map-marker\'></i> Add Range Marker</button></div>'.replace("ZOOM_ID",f).replace("ADD_RANGE_ID",g).replace("COMMENT_ID",h);$(c.graph).find("rect.zoomrect").popover({html:true,container:"body",placement:window.isEmbed?"auto right":"top",trigger:"manual",content:i});$(c.graph).find("rect.zoomrect").popover("show");$("button#"+f).on("click",function(){$(c.graph).find("rect.zoomrect").popover("destroy");c.datasourceContainer.select("rect.zoomrect").remove();c.zoom()});$("button#"+g).on("click",function(){$(c.graph).find("rect.zoomrect").popover("destroy");c.datasourceContainer.select("rect.zoomrect").remove();var a=$("input#"+h).attr("value");var b=$("input#"+h+"_COLOR").attr("value");c.addRangeMarker(d,e,a,b)});try{$(".pick-a-color").pickAColor()}catch(j){console.log(j)}}else{c.datasourceContainer.select("rect.zoomrect").remove()}};this.addRangeMarker=function(a,b,d,e){if(!c.datasource.hasOwnProperty("rangeMarkers")){c.datasource.rangeMarkers=new Array}console.log("Start: "+a+" End: "+b+" Comment: "+d);c.datasource.rangeMarkers.push({startTime:a,endTime:b,comment:d,color:e});c.renderRangeMarkers(c.datasourceContainer,c.x,c.y);c.updateCache()};this.updateCache=function(){localStorage[c.datasource.hash()]=JSON.stringify({rangeMarkers:c.datasource.rangeMarkers})};this.editRangeMarker=function(a){var b=this;console.log("Opening edit range marker dialogue");console.log(b);c.datasourceContainer.on("mousedown",null);var d="DONE_ID_"+parseInt(Math.random()*1e3,10).toString();var e="COMMENT_ID_"+parseInt(Math.random()*1e3,10).toString();var f="REMOVE_ID_"+parseInt(Math.random()*1e3,10).toString();var g="<button class='btn btn-danger pull-left' id='REMOVE_ID'>Delete</button><button class='btn btn-default pull-right' id='DONE_ID'>Save</button>".replace("DONE_ID",d).replace("REMOVE_ID",f);d3.select(b).on("mousedown",null);d3.select(b).on("click",null);$(b).attr("title",null);$(b).attr("data-original-title",null);$(b).popover({html:true,title:'<input type="text" class="form-control" placeholder="Comment" id="COMMENT_ID">'.replace("COMMENT_ID",e),container:"body",placement:window.isEmbed?"auto right":"top",trigger:"manual",content:g});var h=$(b).attr("x")*1;var i=h+$(b).attr("width")*1;var j=c.datasourceContainer.append("svg:g").attr("class","rangemarker edit");j.append("svg:line").style("stroke","black").style("stroke-width","4").style("cursor","pointer").attr("y1",0).attr("y2",c.h).attr("x1",h).attr("x2",h);j.append("svg:circle").attr("cx",h).attr("cy",0).attr("r",5).style("stroke","black").style("stroke-width","2").style("cursor","pointer");j.on("mousedown",function(){var a=d3.select(this);c.datasourceContainer.on("mousemove",function(){var a=d3.mouse(this)[0];console.log("Left Handle: "+a);j.select("line").attr("x1",a);j.select("line").attr("x2",a);j.select("circle").attr("cx",a);d3.select(b).attr("x",j.select("line").attr("x1")).attr("width",k.select("line").attr("x1")*1-j.select("line").attr("x1")*1)});c.datasourceContainer.on("mouseup",function(){c.datasourceContainer.on("mousemove",null)})});var k=c.datasourceContainer.append("svg:g").attr("class","rangemarker edit");k.append("svg:line").style("stroke","black").style("stroke-width","4").style("cursor","pointer").attr("y1",0).attr("y2",c.h).attr("x1",i).attr("x2",i);k.append("svg:circle").attr("cx",i).attr("cy",c.h).attr("r",5).style("stroke","black").style("stroke-width","2").style("cursor","pointer");k.on("mousedown",function(){var a=d3.select(this);c.datasourceContainer.on("mousemove",function(){var a=d3.mouse(this)[0];k.select("line").attr("x1",a);k.select("line").attr("x2",a);k.select("circle").attr("cx",a);d3.select(b).attr("x",j.select("line").attr("x1")).attr("width",k.select("line").attr("x1")*1-j.select("line").attr("x1")*1)});c.datasourceContainer.on("mouseup",function(){c.datasourceContainer.on("mousemove",null)})});$(b).popover("show");var l=d3.select(b).attr("data-index")*1;$("input#"+e).attr("value",c.datasource.rangeMarkers[l].comment);$("button#"+d).on("click",function(){$(b).popover("destroy");j.remove();k.remove();c.datasourceContainer.on("mousedown",c.mousedown);var a=d3.select(b).attr("x")*1;var d=d3.select(b).attr("width")*1+a;var f=c.datasource.timeForOffset(int(c.datasource.x(a)));var g=c.datasource.timeForOffset(int(c.datasource.x(d)));var h=d3.select(b).attr("data-index")*1;c.datasource.rangeMarkers[h]={startTime:f,endTime:g,comment:$("input#"+e).attr("value"),color:$("input#"+e+"_COLOR").attr("value")};c.renderRangeMarkers(c.datasourceContainer,c.x,c.y);c.updateCache()});$("button#"+f).on("click",function(){$(b).popover("destroy");j.remove();k.remove();c.datasourceContainer.on("mousedown",c.mousedown);var a=d3.select(b).attr("data-index")*1;c.datasource.rangeMarkers.splice(a,1);c.renderRangeMarkers(c.datasourceContainer,c.x,c.y);c.updateCache()})};this.renderRangeMarkers=function(a,b,d){if(c.datasource.hasOwnProperty("rangeMarkers")){console.log("Rendering range markers");a.selectAll("rect.rangemarker").remove();for(var e=0;e<c.datasource.rangeMarkers.length;e++){var f=c.datasource.rangeMarkers[e];f.startTime=new Date(f.startTime);f.endTime=new Date(f.endTime);var g=a.append("svg:rect").attr("class","rangemarker").attr("data-index",e).attr("x",c.datasource.x.invert(c.datasource.offsetForTime(f.startTime))).style("fill","#"+f.color).style("opacity",.5).attr("y",0).attr("width",c.datasource.x.invert(c.datasource.offsetForTime(f.endTime))-c.datasource.x.invert(c.datasource.offsetForTime(f.startTime))).attr("height",c.h).on("click",c.editRangeMarker);console.log(g)}}};this.handleDoubleClick=function(a){var a=c.datasource.timeForOffset(c.datasource.x(d3.mouse(this)[0]));console.log("Double click at time: "+a.toTimeString());for(var b=0;b<c.doubleClickCallbacks.length;b++){c.doubleClickCallbacks[b](a)}};this.onDoubleClick=function(a){if(!this.hasOwnProperty("doubleClickCallbacks")){this.doubleClickCallbacks=[]}this.doubleClickCallbacks.push(a)};this.offDoubleClick=function(a){if(!this.hasOwnProperty("doubleClickCallbacks")){this.doubleClickCallbacks=[]}var b=this.doubleClickCallbacks.indexOf(a);if(b>-1){this.doubleClickCallbacks.splice(b,1)}};this.updateCursor=function(a){var b=c.datasource.offsetForTime(a);c.datasourceContainer.selectAll("line.cursor").remove();if(c.followCursor){c.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",c.h).attr("x1",c.w/2).attr("x2",c.w/2)}else{c.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",c.h).attr("x1",c.datasource.x.invert(b)).attr("x2",c.datasource.x.invert(b))}};this.renderUpdate=function(a){if(a=="full"||a==undefined||a==null){var a={};a.xmin=0;a.xmax=c.channels.map(function(a){return c.datasource.data[a].length}).min()-1;a.ymin=c.channels.map(function(a){return c.datasource.data[a].min()}).min();a.ymax=c.channels.map(function(a){return c.datasource.data[a].max()}).max()}c.currentRange=a;c.datasource.x=d3.scale.linear().domain([0,c.w]).range([a.xmin,a.xmax]);c.datasource.y=d3.scale.linear().domain([0,c.h]).range([a.ymax,a.ymin]);var b=a.xmax-a.xmin>c.w?c.w:a.xmax-a.xmin;c.datasource.getMultiChannelDataForOffsetRange(c.channels,a.xmin,a.xmax,b,c.updateSVG)};this.updateSVG=function(a){console.log("Updating SVG");if(a.length>c.channels.length){console.log("It's happening again..");a=a.slice(1,a.length-1)}console.log(a);c.datasource.x.domain([0,c.w]);var b=d3.scale.linear().domain([0,a.map(function(a){return a.length}).max()]).range([0,c.w]);if(c.datasource.y&&!c.autoscale){var d=[c.datasource.y.range()[1],c.datasource.y.range()[0]];var e=d3.scale.linear().domain(d).range([c.h,0])}else{if(c.showAcc){var f=[];for(var g=0;g<a.length;g++){if(!(c.channels[g]=="X"||c.channels[g]=="Y"||c.channels[g]=="Z")){f.push(a[g])}}var e=d3.scale.linear().domain([f.map(function(a){return a.min()}).min(),f.map(function(a){return a.max()}).max()]).range([c.h*(2/3),0])}else{var e=d3.scale.linear().domain([a.map(function(a){return a.min()}).min(),a.map(function(a){return a.max()}).max()]).range([c.h,0])}}if(c.showAcc){var h=[];for(var g=0;g<c.channels.length;g++){if(c.channels[g]=="X"||c.channels[g]=="Y"||c.channels[g]=="Z"){h.push(a[g])}}c.y2=d3.scale.linear().domain([h.map(function(a){return a.min()}).min(),h.map(function(a){return a.max()}).max()]).range([c.h,c.h*(2/3)+c.p/3]);var i=d3.svg.line().x(function(a,c){return b(c)}).y(function(a){return c.y2(a)})}c.x=b;c.y=e;c.datasourceContainer.select("#edaclip rect").attr("height",e.range().max()-e.range().min()).attr("y",e.range().min()).attr("width",b.range().max()-b.range().min()).attr("x",b.range().min());var j=d3.svg.line().x(function(a,c){return b(c)}).y(function(a){return e(a)});c.data=a;c.renderGrid(c.datasourceContainer,c.channels[0],b,e);if(c.showAcc){c.renderGrid(c.datasourceContainer,"Acc",c.x,c.y2)}for(var g=0;g<c.channels.length;g++){a[g].unshift(0);a[g].push(0);console.log("Updating Data for "+c.channels[g]);if((c.channels[g]=="X"||c.channels[g]=="Y"||c.channels[g]=="Z")&&c.showAcc){c.datasourceContainer.select("#"+c.channels[g]).transition(500).attr("d",i(a[g]))}else{c.datasourceContainer.select("#"+c.channels[g]).transition(500).attr("d",j(a[g]))}}c.datasourceContainer.selectAll(".marker").transition().duration(500).attr("cx",function(a){return c.x(c.datasource.x.invert(a.index))}).style("opacity",function(a){var b=Math.round(c.x(c.datasource.x.invert(a.index)));if(b<c.data[0].length&&b>=0){return 1}else{return 0}}).attr("cy",function(a){var b=Math.round(c.datasource.x.invert(a.index));if(c.showAcc){if(b<f[f.length-1].length&&b>=0){return c.y(f[f.length-1][b])}else{return 0}}else if(b<c.data[c.data.length-1].length&&b>=0){return c.y(c.data[c.data.length-1][b])}else{return 0}});c.renderRangeMarkers(c.datasourceContainer,c.x,c.y)};this.renderGrid=function(a,b,d,e,f,g){var b=b||c.channels[0];var d=d||c.x;var e=e||c.y;var g=g||c.w;var f=f||e.range().max()-e.range().min();var h=this.p;console.log("Rendering grid...");console.log(d.domain());console.log(d.range());c.datasourceContainer.selectAll("#background-rect-"+b).remove();var i=a.append("svg:rect").attr("class","background "+b).attr("id","background-rect-"+b).attr("x",0).attr("y",e.range().min()).attr("width",g).attr("height",f);a.selectAll("g."+b).remove();var j=d.ticks(g/150);var k=a.selectAll("g.x."+b).data(j).enter().append("svg:g").attr("class","x "+b);k.append("svg:line").attr("class","grid").style("shape-rendering","crispEdges").attr("x1",d).attr("x2",d).attr("y1",e.range().min()).attr("y2",e.range().max());var l=c.datasource.timeForOffset(c.datasource.x(j[0])).getDate()!=c.datasource.timeForOffset(c.datasource.x(j[j.length-1])).getDate();if(b!="Acc"){k.append("svg:text").attr("class","xText "+b).attr("x",d).attr("y",c.h+10).attr("dy",".35em").style("text-anchor","middle").text(function(a,b){return c.datasource.timeForOffset(c.datasource.x(a)).shortString(l)})}var m=f/30;var n=a.selectAll("g.y."+b).data(e.ticks(m)).enter().append("svg:g").attr("class","y "+b);n.append("svg:line").attr("class","grid "+b).style("shape-rendering","crispEdges").attr("x1",0).attr("x2",g).attr("y1",e).attr("y2",e);n.selectAll(".yText").remove();n.append("svg:text").attr("class","yText "+b).attr("x",-3).attr("y",e).attr("dy",".35em").attr("text-anchor","end").text(function(a,b){return a.toFixed(2).toString()});c.datasourceContainer.selectAll("text.axis-label-"+b).remove();var o="";o=b;if(c.units.hasOwnProperty(b)){o+=" ("+c.units[b]+")"}var p=e.range().min()+(e.range().max()-e.range().min())/2;a.append("svg:text").attr("class","axis-label axis-label-"+b).attr("x",0).attr("y",p).attr("dy","0em").attr("dx","-"+h+"px").attr("text-anchor","middle").attr("transform","rotate(-90, "+-c.p+", "+p+")").text(o);c.datasourceContainer.selectAll("text.title").remove();a.append("svg:text").attr("class","title").attr("x",g/2).attr("y",0).attr("dy","-"+h/4+"px").attr("dx",0).attr("text-anchor","middle").text(c.datasource.filename)}};var version={build:140};