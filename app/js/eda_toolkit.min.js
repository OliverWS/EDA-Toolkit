/**
* EDA Toolkit
* Copyright 2016 Oliver Wilder-Smith 
*/

var e=Math.E;var pi=Math.PI;var np={};var MU="μ";urlParams=function(){var e=location.search.substring(1).split("&");var a={};var t={true:true,false:false,null:null};for(var r=0,n=e.length;r<n;r++){var o=e[r];var i=o.indexOf("=");var s=i==-1?o:o.substring(0,i);var l=i==-1?true:o.substring(i+1);if(l in t){l=t[l]}else if(""+parseFloat(l,10)==l){l=parseFloat(l,10)}a[s]=l}e=t=null;return function e(t){return t in a?a[t]:null}}();float=function(e){return e*1};int=function(e){return parseInt(e,10)};pow=function(e,t){return Math.pow(e,t)};round=function(e,t){var t=t||0;return e.toFixed(t)};String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var log=function(e){if(window.console){console.log(e)}};var toast=function(e){var t=document.createElement("div");t.className="toast alert alert-info";t.innerHTML=e;t.style.position="absolute";t.style.display="block";t.style.width="30%";t.style.left="50%";t.style.top="50%";t.style["margin-left"]="-15%";t.style["margin-top"]="0px";document.getElementsByTagName("body")[0].appendChild(t);$(".toast").fadeOut(0);$(".toast").fadeIn(500);setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(e,t){return e.toFixed(t)};function testBit(e,t){var a=1<<t;return e&a}function truncate(e,t){var t=t||0;return Math.trunc(e*pow(10,t))/float(pow(10,t),t)}function unpackStruct(e){var t=[];for(var a=0;a<e.length;a+=2){var r=e.charCodeAt(a);var n=e.charCodeAt(a+1);var o=r*256+n;t.push(o)}return t}function unpackSigned(e){var t=testBit(e,15)>0;var a=e>>13&3;var r=float(e&1023)/1e3;if(t)return truncate(round(-1*r*pow(10,a),3-a),3-a);else return truncate(round(r*pow(10,a),3-a),3-a)}function unpackUnsigned(e){var t=e>>14&3;var a=float(e&16383)/1e4;return truncate(round(a*pow(10,t),4-t),4-t)}Number.prototype.pad=function(e){var t=""+this;var a=e-t.length;for(var r=0;r<a;r++){t="0"+t}return t};String.prototype.pad=function(e){var t=""+this;var a=e-t.length;for(var r=0;r<a;r++){t="0"+t}return t};Date.prototype.toQFormat=function(){var e="";e+=this.getFullYear()+"-"+(this.getMonth()+1).pad(2)+"-"+this.getDate().pad(2);e+=" ";e+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2);e+=" ";e+="Offset:"+(this.getTimezoneOffset()>0?"+"+(this.getTimezoneOffset()/60).pad(2):(this.getTimezoneOffset()/60).pad(2));return e};Array.prototype.isValid=function(){var e=this;return e.filter(function(e){return!isNaN(e)}).length==e.length};parseDate=function(e){var t=e.split(" ")[0];var a=e.split(" ")[1];var r=float(e.split(" ")[2].split(":")[1]);var n=int(t.split("-")[0]);var o=int(t.split("-")[1]-1);var i=int(t.split("-")[2]);var s=int(a.split(":")[0]);var l=int(a.split(":")[1]);var d=int(a.split(":")[2]);return new Date(n,o,i,s,l,d,0)};var TimeDelta=function(e){var t={};if(!e.isPrototypeOf(Object)){t.days=Math.floor(e/(1e3*60*60*24));t.hours=Math.floor(e%(1e3*60*60*24)/(1e3*60*60));t.minutes=Math.floor(e%(1e3*60*60)/(1e3*60));t.seconds=Math.floor(e%(1e3*60)/1e3);t.milliseconds=Math.floor(e%1e3)}else{t.days=e.days||0;t.hours=e.hours||0;t.minutes=e.minutes||0;t.seconds=e.seconds||0;t.milliseconds=e.milliseconds||0}t.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)};t.valueOf=function(){var e=0;e+=1e3*60*60*24*this.days;e+=1e3*60*60*this.hours;e+=1e3*60*this.minutes;e+=1e3*this.seconds;e+=this.milliseconds;return e};return t};Date.prototype.sub=function(e){var t=this.valueOf()-e.valueOf();return TimeDelta(t)};Date.prototype.add=function(e){return new Date(this.valueOf()+TimeDelta(e).valueOf())};Date.prototype.addMilliseconds=function(e){var t=new Date(this.valueOf()+e);return t};Date.prototype.addSeconds=function(e){return this.addMilliseconds(e*1e3)};Date.prototype.addMinutes=function(e){return this.addSeconds(60*e)};Date.prototype.addHours=function(e){return this.addMinutes(60*e)};Date.prototype.addDays=function(e){return this.addHours(24*e)};Date.prototype.getMinutesSinceMidnight=function(){var e=new Date(this.toString());e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);var t=(e.valueOf()-this.valueOf())/(60*1e3);return t};Date.prototype.shortString=function(e){if(e){return this.toLocaleDateString()+" "+this.toLocaleTimeString()}else{return this.toLocaleTimeString()}};String.prototype.contains=function(e){return this.indexOf(e)>-1};String.prototype.isnum=function(){try{var e=parseFloat(this.toString());return true}catch(e){return false}};String.prototype.isdate=function(){try{var e=new Date(this.toString());if(!e.valueOf().isNaN()){return true}else{return false}}catch(e){return false}};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(e){}try{if(this.toString().indexOf(":")>0){var e=Date.parse(this.toString());if(!isNaN(e)){console.log("Parsed '"+this.toString()+"' to "+new Date(e).toString());return new Date(e)}}}catch(e){console.log(e)}try{var t=parseFloat(this.toString());if(!isNaN(t)){return t}else{return this.toString()}}catch(e){return this.toString()}}};guess=function(e){if(typeof e!="string"){return typeof e}else if(e.isdate()){return"date"}else if(e.isnum()){if(e.toString().contains(".")||e.toString().contains(",")){return"float"}else{return"int"}}else{return"unknown"}};autoformat=function(e){var t=guess(e);switch(t){case"float":return float(e);break;case"int":return int(e);break;case"date":return new Date(e);break;default:return e;break}};gaussian=function(t,a){var r=Math.sqrt(a);var n=1/(r*Math.sqrt(2*pi));var o=0;var i=-1*(Math.pow(t-o,2)/(2*r*r));var s=n*Math.pow(e,i);return s};gaussianKernel=function(e,t){var a=new Array;for(var r=-1*t/2;r<t/2;r++){a.push(gaussian(r,e))}return a};gaussianFilter=function(e,t,a){var r=new Array;if(a==undefined){a=100}for(var n=0;n<e.length;n++){var o=n-a/2<0?0:n-a/2;var i=n+a/2>=e.length?e.length-1:n+a/2;var s=gaussianKernel(t,i-o);r.push(np.sum(convolve(s,e.slice(o,i))))}return r};np.timeRange=function(e,t,a){var r=t-e;var n=Math.floor(float(r)/a);var o=new Array;for(var i=0;i<a;i++){o.push(e.addMilliseconds(n*i))}return o};np.arange=function(e,t,a){if(a==undefined){a=1}var r=new Array;for(var n=e;n<t;n+=a){r.push(n)}return r};np.round=function(e,t){var a=e%t;if(a>t/2){e=(Math.round(e/t)+1)*t}else{e=Math.round(e/t)*t}return e};np.map=function(e,t){var a=new Array;for(var r=0;r<t.length;r++){a.push(e(t[r]))}return a};np.max=function(e){var t=-Infinity;for(var a=0;a<e.length;a++){if(e[a]>t){t=e[a]}}return t};np.min=function(e){var t=Infinity;for(var a=0;a<e.length;a++){if(e[a]<t){t=e[a]}}return t};convolve=function(e,t){var a=new Array;if(e.length!=t.length){return false}else{for(var r=0;r<e.length;r++){a.push(e[r]*t[r])}return a}};np.sum=function(e){var t=0;for(var a=0;a<e.length;a++){if(!e[a].isNaN()){t+=e[a]}}return t};Array.prototype.max=function(){var e=this.filter(function(e){return!isNaN(e)});var t=-Infinity;for(var a=0;a<e.length;a++){if(e[a]>t){t=e[a]}}return t};Array.prototype.min=function(){var e=this.filter(function(e){return!isNaN(e)});var t=Infinity;for(var a=0;a<e.length;a++){if(e[a]<t){t=e[a]}}return t};Array.prototype.find=function(e){var t=this;var a=new Array;for(var r=0;r<t.length;r++){if(t[r]==e){a.push(r)}}return a};Array.prototype.map=function(e){var t=this;var a=new Array;for(var r=0;r<t.length;r++){a.push(e(t[r]))}return a};Array.prototype.max=function(){var e=this;var t=-Infinity;for(var a=0;a<e.length;a++){if(e[a]>t){t=e[a]}}return t};Array.prototype.min=function(){var e=this;var t=Infinity;for(var a=0;a<e.length;a++){if(e[a]<t){t=e[a]}}return t};Array.prototype.map=function(e){var t=this;var a=new Array;for(var r=0;r<t.length;r++){a.push(e(t[r]))}return a};float=function(e){return e*1};int=function(e){return parseInt(e,10)};Array.prototype.clone=function(){var e=this;var t=new Array;for(var a=0;a<e.length;a++){t.push(e[a])}return t};gaussian=function(t,a){var r=Math.sqrt(a);var n=1/(r*Math.sqrt(2*pi));var o=0;var i=-1*(Math.pow(t-o,2)/(2*r*r));var s=n*Math.pow(e,i);return s};gaussianKernel=function(e,t){var a=new Array;for(var r=-1*t/2;r<t/2;r++){a.push(gaussian(r,e))}return a};gaussianFilter=function(e,t,a){var r=new Array;if(a==undefined){a=100}for(var n=0;n<e.length;n++){var o=n-a/2<0?0:n-a/2;var i=n+a/2>=e.length?e.length-1:n+a/2;var s=gaussianKernel(t,i-o);r.push(np.sum(convolve(s,e.slice(o,i))))}return r};var np=np||{};np.arange=function(e,t,a){if(a==undefined){a=1}var r=new Array;for(var n=e;n<t;n+=a){r.push(n)}return r};np.round=function(e,t){var a=e%t;if(a>t/2){e=(Math.round(e/t)+1)*t}else{e=Math.round(e/t)*t}return e};np.map=function(e,t){var a=new Array;for(var r=0;r<t.length;r++){a.push(e(t[r]))}return a};np.max=function(e){var t=-Infinity;for(var a=0;a<e.length;a++){if(e[a]>t){t=e[a]}}return t};np.min=function(e){var t=Infinity;for(var a=0;a<e.length;a++){if(e[a]<t){t=e[a]}}return t};convolve=function(e,t){var a=new Array;if(e.length!=t.length){return false}else{for(var r=0;r<e.length;r++){a.push(e[r]*t[r])}return a}};np.sum=function(e){var t=0;for(var a=0;a<e.length;a++){if(!e[a].isNaN){t+=e[a]}}return t};np.mean=function(e){return np.sum(e)/(1*e.length)};np.average=np.mean;np.avg=np.mean;np.median=function(e){var t=e.clone();t.sort();var a=int(Math.ceil(e.length/2))-1;if(e.length%2==0){return np.mean(t.slice(a,-a))}else{return t[a]}};var signals=signals||{};signals.sanitize=function(e,t,a){var t=t||[0];var a=a||[NaN];for(var r=0;r<e.length;r++){for(var n=0;n<a.length;n++){if(a[n]=="-"){if(e[r]<0){e[r]=t[n]}}else if(e[r]==a[n]){e[r]=t[n]}}}return e};signals.gaussianFilter=function(e,t){return gaussianFilter(e,t,10)};signals.medianFilter=function(e,t){var t=t||3;var a=new Array;for(var r=0;r<e.length;r++){var n=r-t/2<0?0:r-t/2;var o=r+t/2>=e.length?e.length-1:r+t/2;a.push(np.median(e.slice(n,o)))}return a};signals.maxFilter=function(e,t){var t=t||3;var a=new Array;for(var r=0;r<e.length;r++){var n=r-t/2<0?0:r-t/2;var o=r+t/2>=e.length?e.length-1:r+t/2;a.push(np.max(e.slice(n,o)))}return a};signals.minFilter=function(e,t){var t=t||3;var a=new Array;for(var r=0;r<e.length;r++){var n=r-t/2<0?0:r-t/2;var o=r+t/2>=e.length?e.length-1:r+t/2;a.push(np.min(e.slice(n,o)))}return a};signals.diff=function(e){var t=new Array;for(var a=0;a<e.length-1;a++){t.push(e[a+1]-e[a])}return t};signals.where=function(e,t){var a=new Array;for(var r=0;r<e.length;r++){if(t(e[r])){a.push(r)}}return a};signals.zeroCrossings=function(e){var t=new Array;for(var a=1;a<e.length;a++){if(e[a-1]<0&&e[a]>0){t[a]=1}else if(e[a-1]>0&&e[a]<0){t[a]=-1}else{t[a]=0}}return t};signals.peaks=function(e,t){var a=new Array;var r=signals.diff(e);var n=signals.zeroCrossings(e);var o=signals.where(a,function(e){return e>0});var i=signals.where(a,function(e){return e<0});return[o,i]};var Dropzone=function(e,t,a){var o=this;var a=a||{};o.active=true;o.allowFolders=a.allowFolders||true;o.width=a.width||$("#"+e).width()||300;o.height=a.height||$("#"+e).height()||o.width;o.autoremove=a.autoremove||true;o.callback=t;margin=a.margin||10;o.styles=new StyleSheet;var r=o.styles.addStyle(".dropzone");r.addProperty("background-color: #CCC");r.addProperty("width: "+(o.width-2*margin)+"px");r.addProperty("height: "+(o.height-2*margin)+"px");r.addProperty("margin: "+margin+"px");r.addProperty("border: "+o.width/100+"px dashed");r.addProperty("border-color: #333");r.addProperty("border-radius: 50px");r.addProperty("opacity: 0.75");var n=o.styles.addStyle(".stripes");n.addProperty("background-image: -webkit-linear-gradient(-45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent)");n.addProperty("-webkit-background-size: 100px 100px");var i=document.getElementById(e);i.className+=" dropzone stripes ";if(a.label){var s=$("<h1>").html(a.label);$(i).append(s);var l=$(s).height();$(s).css("margin-top",(o.height-l)/2).css("text-align","center").css("vertical-align","middle")}try{if(!(Dropbox===undefined)){var d=parseInt(Math.random()*1e4).toString();$(i).find("h1").append('<br/><input type="dropbox-chooser" name="selected-file" id="db-chooser-'+d+'" data-link-type="direct" data-multiselect="true" data-extensions=".eda .csv .tsv .avi .webm .mov .mp4 .m4v" />');document.getElementById("db-chooser-"+d).addEventListener("DbxChooserSuccess",function(e){console.log(e);var t=e.files;for(var a=0;a<t.length;a++){var r=t[a];o.callback(r,false,"link")}o.callback({},true);if(o.autoremove){o.remove()}},false)}}catch(e){console.log(e)}var c=parseInt(Math.random()*1e4).toString();$(i).find("h1").after('<br/><input type="file" name="files[]" id="'+c+'"  multiple />');$("#"+c).css("display","inline-block").css("position","relative").css("left","50%").css("margin-left","-45px");document.getElementById(c).onchange=function(e){console.log(e);var t=e.target.files;for(var a=0;a<t.length;a++){var r=t[a];o.callback(r)}o.callback({},true);if(o.autoremove){o.remove()}};i.ondragover=function(){if(this.className.indexOf("hover")<0){this.className+=" hover"}return false};i.ondragend=function(){this.className.replace("hover","");return false};i.ondrop=function(e){e.preventDefault();if(o.allowFolders){var t=o.getFirstFile(e);if(t.isDirectory){if(document.getElementById("foldername")){document.getElementById("foldername").innerHTML=t.name}o.traverseFileTree(t);o.callback({},true);if(o.autoremove){o.remove()}}else{for(var a=e.dataTransfer.files.length-1;a>=0;a--){var r=e.dataTransfer.files[a];o.callback(r)}o.callback({},true);if(o.autoremove){o.remove()}}}else{var r=e.dataTransfer.files[0];o.callback(r);if(o.autoremove){o.remove()}}};o.getFiles=function(e){if(window.safari!=undefined){return e.dataTransfer.files}else{return e.dataTransfer.items}};o.getFirstFile=function(e){if(window.safari!=undefined){return o.getFiles(e)[0]}else{return o.getFiles(e)[0].webkitGetAsEntry()}};o.traverseFileTree=function(r,n){n=n||"";if(r.isFile&&r.name[0]!="."){r.file(function(e){o.callback(e)})}else if(r.isDirectory&&r.name[0]!="."){var e=r.createReader();e.readEntries(function(e){var t=[];for(var a=0;a<e.length;a++){t.push(e[a])}t.sort(function(e,t){return e.name.localeCompare(t.name)});for(var a=0;a<t.length;a++){o.traverseFileTree(t[a],n+r.name+"/")}})}};o.dropzone=i;o.remove=function(){$(i).find("h1").remove();$(i).find("input").remove();i.className=i.className.replace("dropzone","");i.className=i.className.replace("stripes","");i.ondragover=null;i.ondragend=null;i.ondrop=null;o.active=false}};var Loader=function(e,t){$(e).append($("<div>").addClass("loader").append($("<h2>").text("Loading...")).append($("<div>").attr("id",t).attr("class","progress progress-striped active").append($("<div>").addClass("progress-bar").attr("role","progressbar").attr("style","width: 0%;"))));var a=($(e).height()-$(e).find(".loader").height()-$(e).find("h2").height())/2;$(e).find(".loader").css("margin-top",a)};var StyleSheet=function(){var i=this;i.css=document.createElement("style");i.css.type="text/css";i.styles=[];i.css=document.head.appendChild(i.css);i.addStyle=function(e){var t={};t.selector=e;t.properties=[];i.styles.push(t);t.addProperty=function(e){this.properties.push(e);i.update()};i.update();return t};i.update=function(){var e="\n";for(var t=0;t<i.styles.length;t++){var a=i.styles[t];var r="";r+=a.selector+" {\n";for(var n=0;n<a.properties.length;n++){var o=a.properties[n];r+="    "+o+(o.indexOf(";")>-1?"\n":";\n")}r+="\n}\n\n";e+=r}i.css.innerHTML=e};i.update()};var VideoDroplet=function(e,t,a){var n=this;var a=a||{};n.id=e;n.extension=a.extension||false;n.callback=t;n.vsize=a.vsize||{};n.vsize.width=n.vsize.width||720;n.vsize.height=n.vsize.height||n.vsize.width*(9/16);n.insertVideo=function(e,t){var a=t.name;var r=t.type;$("#"+n.id).append($("<video>").attr("controls","").attr("class","video-js vjs-default-skin").attr("filename",a).attr("preload","auto").attr("id","video").attr("name","media").attr("src",e).attr("type",r));$("#"+n.id).css("width","auto");$("#"+n.id).css("height","auto");_V_("video").ready(function(){var e=this;e.size(n.vsize.width,n.vsize.height);n.callback(e)})};n.dropzone=new Dropzone(n.id,function(e){var t=new FileReader;n.file=e;if(e.name.endsWith("."+n.extension)||n.extension==false){$("#"+n.id).empty();n.insertVideo(window.webkitURL.createObjectURL(e),e)}else{var a=$("#"+n.id).find(".dropzone").css("background-color");var r=$("#"+n.id).find(".dropzone").css("border-color");$("#"+n.id).find(".dropzone").animate({"background-color":"#f2dede","border-color":"#b94a48"},1e3,function(){$(this).animate({"background-color":a,"border-color":r},1e3)})}return false},{label:"Drop video file here to view"})};var qLogFile=function(){var u=this;this.worker=new Worker("js/eda_toolkit.worker.js");u.isEDAFile=true;u.didAlreadyLoad=false;u.filename="EDA File";u.callbacks={};this.handleMessage=function(e){var t=e.data;switch(t.cmd){case"console":console.log(t.msg);break;case"metadata":u.metadataDidLoad(t.data);break;case"data":u.dataDidLoad(t.data);break;case"scrs":u.callback(t.data);break;case"export":u.callback(t.data);break;case"filter":u.callback(t.data);break;case"progress":u.updateProgress(100*t.progress.toFixed(2));break;case"downsampled":console.log("Got downsampled data back");if(t.key){var a=t.data;console.log(a);u.callbacks[t.key](a)}else{u.callback(t.data);u.callback=null}break;case undefined:break;default:}if(u.validate()&&!u.didAlreadyLoad){u.didAlreadyLoad=true;u.didLoad()}};this.hash=function(){if(!u.didAlreadyLoad){return null}else{var e=u.startTime.toString()+"_"+u.endTime.toString()+"_"+u.filename+"_"+u.data.length*u.data[u.channels[0]][0];return e}};this.load=function(e,t,a){this.url=e;if(a){this.filename=a}else{this.filename=e.split("/").slice(-1)}this.callback=t;if(this.worker==undefined){this.worker=new Worker("js/eda_toolkit.worker.js")}this.worker.onmessage=this.handleMessage;this.worker.postMessage({cmd:"load",url:this.url,filename:this.filename})};this.loadText=function(e,t,a){this.callback=t;if(a!=undefined)this.filename=a;if(this.worker==undefined){this.worker=new Worker("js/eda_toolkit.worker.js")}this.worker.onmessage=this.handleMessage;this.worker.postMessage({cmd:"loadText",data:e,filename:this.filename})};this.updateProgress=function(e){if(this.progress!=undefined){$("#"+this.progress).find("div.progress-bar").css("width",Math.round(e)+"%")}else{}};this.didLoad=function(){if(localStorage[u.hash()]!=undefined){var e=JSON.parse(localStorage[u.hash()]);u.rangeMarkers=e.rangeMarkers}else{u.rangeMarkers=[]}if(sessionStorage["RANGE_MARKERS"]!=undefined){var t=JSON.parse(sessionStorage["RANGE_MARKERS"]);for(var a=0;a<t.length;a++){u.rangeMarkers.push(t[a])}}if(this.callback!=undefined){this.callback.call(u)}};this.validate=function(){return this.metadata&&this.data};this.metadataDidLoad=function(e){this.metadata=e;this.startTime=this.metadata["Start Time"];this.sampleRate=this.metadata["Sampling Rate"];this.channels=this.metadata["Column Names"].filter(function(e){return!(e.toLowerCase().indexOf("time")>-1||e.toLowerCase().indexOf("date")>-1)})};this.dataDidLoad=function(e){this.data=e;this.events=e.markers;this.data.length=this.channels.map(function(e){return u.data[e].length}).min();var t=this.data.length/this.sampleRate*1e3;this.endTime=this.startTime.addMilliseconds(t);this.duration=this.endTime.sub(this.startTime)};this.setData=function(e,t){if(t.length==u.data.length){for(var a=0;a<u.data.length;a++){u.data[e][a]=t[a]}}else{}};this.getData=function(e){return u.data[e]};this.filter=function(t,e,a){u.callback=function(e){u.setData(t,e);a(u)};var r=u.getData(t);u.worker.postMessage({cmd:"filter",data:{data:r,filterType:e,width:u.sampleRate}})};this.fractionalOffsetForTime=function(e){var t=e.sub(this.startTime);if(t.valueOf()>=0&&t.valueOf()<this.duration.valueOf()){return t.valueOf()/(1e3/this.sampleRate)}else if(t.valueOf()>=0&&t.valueOf()==this.duration.valueOf()){return this.data.length-1}else{throw"Illegal Time: "+e+". Time must be between "+this.startTime+" and "+this.endTime}};this.offsetForTime=function(e){var t=e.sub(this.startTime);if(t.valueOf()>=0&&t.valueOf()<this.duration.valueOf()){return Math.round(t.valueOf()/(1e3/this.sampleRate))}else if(t.valueOf()>=0&&t.valueOf()==this.duration.valueOf()){return this.data.length-1}else{throw"Illegal Time: "+e+". Time must be between "+this.startTime+" and "+this.endTime}};this.timeForOffset=function(e){var t=e*(1e3/this.sampleRate);if(t>=0&&t<this.duration.valueOf()){return this.startTime.add(TimeDelta(t))}else if(t>=0&&t==this.duration.valueOf()){return this.endTime}else{console.log("Illegal Offset: "+e+". Offset must be between "+0+" and "+this.data.length-1);return this.startTime.add(TimeDelta(t))}};this.get=function(i,e){var e=e||{};var s=e.start||this.timeForOffset(0);var l=e.end||this.timeForOffset(u.data.EDA.length-1);var d=e.channels||["EDA","X","Y","Z"];var c=e.targetSamples||this.offsetForTime(l)-this.offsetForTime(s);console.log("start: "+s+"("+this.offsetForTime(s)+") \n end: "+l+"("+this.offsetForTime(l)+") \n targetSamples: "+c);u.getMultiChannelDataForOffsetRange(d,this.offsetForTime(s),this.offsetForTime(l),c,function(e){console.log(e);var t=new Array;var a=np.timeRange(s,l,c);for(var r=0;r<e[0].length;r++){var n={};for(var o=0;o<d.length;o++){n[d[o]]=e[o][r]}n["time"]=a[r];t.push(n)}i(t)})};this.getData=function(e,t,a){var r=u.data[e];if(t){var n=(Math.random()*10).toString();u.callbacks[n]=a;if(t>0){this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:data,target:t,key:n}})}else{throw"Target Samples Error: target samples must be greater than 0 and less than "+this.data.length+", not "+t}}else{return r}};this.findSCRs=function(e,t,a){if(t==undefined)t=0;if(a==undefined)a=u.data.EDA.length-1;u.callback=e;u.worker.postMessage({cmd:"scrs",data:{points:this._getDataForOffsetRange("EDA",t,a),width:u.sampleRate}})};this.getDataForOffsetRange=function(e,t,a,r,n){if(e.toLowerCase()=="acc"){u.getMultiChannelDataForOffsetRange(["X","Y","Z"],t,a,r,n)}else{var o=this._getDataForOffsetRange(e,t,a);if(n){var i=(Math.random()*10).toString();u.callbacks[i]=n;this.worker.postMessage({cmd:"downsample",data:{points:o,target:r,key:i}})}else{return o}}};u.getMultiChannelDataForOffsetRange=function(e,t,a,r,n){var o=[];for(var i=0;i<e.length;i++){o.push(this._getDataForOffsetRange(e[i],t,a))}if(n){var s=(Math.random()*10).toString();u.callbacks[s]=n;this.worker.postMessage({cmd:"downsampleMultiChannel",data:{points:o,target:r,key:s}})}else{return points}};this._getDataForOffsetRange=function(e,t,a){if(t>=0&&a<this.data.length&&this.data.hasOwnProperty(e)){return this.data[e].slice(t,a)}else{return[]}};this.getDataForTimeRange=function(e,t,a,r,n){var o=this._getDataForTimeRange(e,t,a);if(n){u.callback=n;this.worker.postMessage({cmd:"downsample",data:{points:o,target:r}})}else{return o}};this._getDataForTimeRange=function(e,t,a){var e=e||"EDA";var r=this.offsetForTime(t);var n=this.offsetForTime(a);if(r!=NaN&&n!=NaN){if(this.data.hasOwnProperty(e)){return this.data[e].slice(r,n)}}else{return[]}};this.saveFileAs=function(e,t){if(t){}else{t="SelectedRegion.csv"}var a=new Blob([e],{type:"text/plain;charset=UTF-8"});var r=document.createElement("a");r.setAttribute("href","data:attachment/csv;charset=utf-8,"+encodeURIComponent(e));r.setAttribute("download",t);r.click()};this.savePDF=function(){};this.saveToDropbox=function(t){this.exportToCSV(function(e){t.writeFile(u.filename,e,function(){new Notify("File uploaded to Dropbox!")})})};this.exportCropped=function(e,t,a,r){if(r){u.callback=r}else{if(a){u.callback=function(e){u.saveFileAs(e,a)}}else{u.callback=u.saveFileAs(file,a)}}var n=Object.assign({},u.data);var o=Object.assign({},u.metadata);for(var i=u.channels.length-1;i>=0;i--){n[u.channels[i]]=this._getDataForTimeRange(u.channels[i],e,t)}o["Start Time"]=e;u.worker.postMessage({cmd:"export",data:{data:n,metadata:o,useBlob:false}})};this.exportToCSV=function(e){if(e){u.callback=e}else{u.callback=u.saveFileAs}var t=u.data;var a=u.metadata;u.worker.postMessage({cmd:"export",data:{data:t,metadata:a,useBlob:false}})}};var EDADroplet=function(e,t,a){var r=this;var a=a||{};r.id=e;r.extension=a.extension||"eda";r.callback=t;r.edaFile=new qLogFile;r.edaFile.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);r.draw=function(e){};r.graph=function(e){console.log("Preparing to graph");r.grapher=new Grapher(document.getElementById(r.id));$("#"+r.id).find(".loader").remove();r.grapher.plot(r.edaFile);r.callback(r.edaFile,r.grapher)};r.dropzone=new Dropzone(r.id,function(t){var e=new FileReader;console.log(t);if(t.name.endsWith("."+r.extension)){var a=new Loader("#"+r.id,r.edaFile.progress);console.log("Loading file...");e.onload=function(e){console.log(e.target);r.fileContents=e.target.result;r.edaFile.loadText(e.target.result,r.graph,t.name);return false};e.readAsBinaryString(t)}else{$(".dropzone").addClass("error");setTimeout(function(){$(".dropzone").removeClass("error")},1e3)}return false},{label:"Drop EDA file here to view"})};var FolderDroplet=function(e,t,a){var l=this;var a=a||{};l.id=e;l.extension=a.extension||"eda";l.callback=t;l.vsize=a.vsize||{};l.vsize.width=l.vsize.width||$("html").width()/2;l.vsize.height=l.vsize.height||l.vsize.width*(9/16);l.graphs=[];l.videoFiles=[];l.msg=a.msg||"<i class='fa fa-files-o'></i>  Drop files here to view";l.handleError=function(e){$(".dropzone").addClass("error");setTimeout(function(){$(".dropzone").removeClass("error")},1e3)};l.handleEDA=function(n,e){console.log("Loading file...");if(e=="link"){var a="EDA"+($("div.edaGraph").length+1);$("#"+l.id).append($("<div>").attr("id",a).addClass("edaGraph").addClass("row-fluid"));var t=new qLogFile;t.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);var r=new Loader("#"+a,t.progress);t.load(n.link,function(){var e=this;console.log("Preparing to graph");var t=new Grapher(document.getElementById(a));$("#"+a).find(".loader").remove();t.plot(e);l.graphs.push(t);l.callback(l.graphs)},n.name)}else{var o=new FileReader;o.onload=function(e){console.log(e.target);var a="EDA"+($("div.edaGraph").length+1);$("#"+l.id).append($("<div>").attr("id",a).addClass("edaGraph").addClass("row-fluid"));var t=new qLogFile;t.progress="progress-indicator-"+parseInt(Math.random()*1e4,10);var r=new Loader("#"+a,t.progress);l.fileContents=e.target.result;t.loadText(e.target.result,function(){var e=this;console.log("Preparing to graph");var t=new Grapher(document.getElementById(a));$("#"+a).find(".loader").remove();t.plot(e);l.graphs.push(t);l.callback(l.graphs)},n.name);return false};o.readAsBinaryString(n)}};l.handleEvents=function(e,t){console.log("Loading file...");var a=new FileReader;a.onload=function(e){console.log(e.target);var t=""+e.target.result;console.log("Loading range markers:...\n"+t);sessionStorage["RANGE_MARKERS"]=t;return false};a.readAsBinaryString(e)};l.setupHandlers=function(e){console.log("Video Width: "+$("video").width());$("video").attr("height",720);$("video").attr("width",720*(16/9));for(var t=0;t<l.videoFiles.length;t++){var a=l.videoFiles[t];if(l.videoFiles.length==1){$("#"+a.id).css("margin-left",($("#"+l.id).width()-$("#"+a.id).width())/2)}a.addEvent("timeupdate",function(e){if($("#"+this.id).attr("data-start-time")){var t=new Date(parseInt($("#"+this.id).attr("data-start-time")))}else{var a=$("#"+this.id).find("video").attr("filename");var r=a.split(" ")[0].split("-").map(parseInt);var n=a.split(" ")[1].split(".m")[0].split("_").map(parseFloat);console.log(r+" "+n);var t=new Date(r[0],r[1]-1,r[2],n[0],n[1],Math.floor(n[2]),(n[2]-Math.floor(n[2]))*1e3);$("#"+this.id).attr("data-start-time",t.valueOf())}console.log("Current Time: "+this.currentTime());var o=new TimeDelta(this.currentTime()*1e3);for(var i=0;i<l.graphs.length;i++){var s=l.graphs[i];try{s.updateCursor(t.add(o))}catch(e){console.log(e)}}})}if(l.bookmark){var r=l.bookmark.split("-").map(parseInt);var n=r[0]*60*60+r[1]*60+r[0];for(var t=0;t<l.videoFiles.length;t++){l.videoFiles[t].currentTime(n);console.log("Current time for video: "+l.videoFiles[t].id+" is "+l.videoFiles[t].currentTime());l.videoFiles[t].play();l.videoFiles[t].pause();setTimeout(function(){l.videoFiles[t].play();l.videoFiles[t].pause()},400)}}};l.handleVideo=function(e,t){console.log("Got video file: "+e.name);if(t=="link"){var a=e.name;var t="video/"+a.split(".")[a.split(".").length-1];var r=e.link}else{var n=e;var r=window.URL.createObjectURL(e);var a=n.name;var t=n.type}var i="video"+parseInt(Math.random()*1e3+"",10);$("#"+l.id).prepend($("<video>").attr("controls","").attr("class","video-js vjs-default-skin video").attr("filename",a).attr("preload","auto").attr("id",i).attr("name","media").attr("src",r).attr("type",t));$("#"+l.id).css("width","auto");$("#"+l.id).css("height","auto");_V_(i).ready(function(){var e=this;console.log("Video loaded!");e.size(l.vsize.width,l.vsize.height);if($("#"+this.id).attr("data-start-time")){var t=new Date(parseInt($("#"+this.id).attr("data-start-time")))}else{var a=$("#"+this.id).find("video").attr("filename");var r=a.split(" ")[0].split("-").map(parseInt);var n=a.split(" ")[1].split(".m")[0].split("_").map(parseFloat);console.log(r+" "+n);var t=new Date(r[0],r[1]-1,r[2],n[0],n[1],Math.floor(n[2]),(n[2]-Math.floor(n[2]))*1e3);$("#"+this.id).attr("data-start-time",t.valueOf())}if(isNaN(t)){var o=this.id+"_timepicker";$("#"+this.id).popover({type:"auto",title:"<strong>Please specify video start time</strong> <a class='close' href='#' onclick=\"$('#"+this.id+"').popover('hide')\" aria-hidden='true'>&times;</a>",trigger:"manual",html:true,content:'<div class="input-group"><span class="input-group-addon"><i class="icon-time"></i></span><input id="'+o+'" type="text" class="form-control" placeholder="yyyy-mm-dd HH:MM:SS Z"></div>'});$("#"+this.id).popover("show");$("#"+o).on("change",function(){console.log($(this).attr("value"));$("#"+i).attr("data-start-time",moment($(this).attr("value").valueOf()))})}l.videoFiles.push(e)})};var r=function(e,t,a){var a=a||"file_entry";if(t){setTimeout(l.setupHandlers,500);l.callback(l.graphs);return}console.log(e);var r=e.name.split(".")[e.name.split(".").length-1].toLowerCase();switch(r){case"eda":l.handleEDA(e,a);break;case"reda":l.handleEDA(e,a);break;case"csv":l.handleEDA(e,a);break;case"tsv":l.handleEDA(e,a);break;case"avi":l.handleVideo(e,a);break;case"mov":l.handleVideo(e,a);break;case"mp4":l.handleVideo(e,a);break;case"bookmark":l.bookmark=e.name.split(".")[0];break;case"events":l.handleEvents(e,a);break;default:l.handleError(e)}return false};l.dropzone=new Dropzone(l.id,r,{label:l.msg,allowFolders:true});if(urlParams("file")!=null){var n=urlParams("file");var o={};o.link=n;o.name=n.split("/").slice(-1)[0];r(o,false,"link");r({},true,"");l.dropzone.remove()}};$(document).on("keydown",function(e){switch(e.which){case 39:{if($("video").length>0){_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()+.02)}else{for(var t=0;t<graphers.length;t++){var a=graphers[t];var r=a.datasource.timeForOffset(a.datasource.x(0)).add(1e3);var e=a.datasource.timeForOffset(a.datasource.x(a.w)).add(1e3);a.zoom(r,e,"zoomin")}}break}case 8:{break}case 37:case 33:{if($("video").length>0){console.log("Video time: "+_V_($("video").attr("id")).currentTime());_V_($("video").attr("id")).currentTime(_V_($("video").attr("id")).currentTime()-.02)}else{for(var t=0;t<graphers.length;t++){var a=graphers[t];var r=a.datasource.timeForOffset(a.datasource.x(0)).sub(1e3);var e=a.datasource.timeForOffset(a.datasource.x(a.w)).sub(1e3);a.zoom(r,e,"zoomin")}}break}default:return}});if(d3){d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})}}var Grapher=function(e,t){var g=this;this.container=e;this.unrendered=true;this.opts=t||{};this.channels=this.opts.channel||["EDA"];this.autoscale=this.opts.autoscale||true;this.annotationType=this.opts.annotationType||"text";this.annotationLabel=this.opts.annotationLabel||"Comment";this.annotationPlaceholder=this.opts.annotationPlaceholder||"Comment";g.headroom=this.opts.headroom||.2;g.RANGE_MARKER_HEIGHT=this.opts.rangemarkerheight||10;g.showAcc=false;this.units={EDA:"μ"+"S",X:"gs",Y:"gs",Z:"gs",Tonic:"μ"+"S",Phasic:"μ"+"S"};this.spinOpts={lines:13,length:21,width:12,radius:30,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:true,hwaccel:true,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};if(d3){this.renderer="svg";this.graph=$(e)}else{this.renderer="canvas";this.graph=$("<canvas>");$(this.container).append(this.graph)}this.width=this.opts.width||$(e).width();this.height=this.opts.height||$(e).height();this.plot=function(e,t){if(t)g.readyCallback=t;try{if(g.spinner){}else{g.spinner=new Spinner(g.spinOpts).spin(document.getElementById(g.graph[0].id))}}catch(e){console.log("Spinner error: "+e.toString())}if(e!=undefined){if(g.renderer=="svg"){if(g.unrendered){if(e.isEDAFile){g.isEDA=true;g.renderData(e);g.addPicker()}else{g.renderSVG(e)}g.unrendered=false}else{if(e.isEDAFile){g.renderUpdate(e)}else{g.updateSVG(e)}}}else{g.renderCanvas(e)}}else{}if(g.spinner){g.spinner.stop()}};this.channelSelectHandler=function(e){var t=$(g.container);$(this).toggleClass("selected-channel");var a=[];$(t).find("#channel-select li a.selected-channel").each(function(e,t){a.push($(t).text())});console.log("New Selected Channels: "+a);g.setChannels(a);$(t).find("#channel-select li.ignore").remove();var r=$(t).find("#channel-select li").remove().sort(function(e,t){if($(e).find("a").hasClass("selected-channel")&&!$(t).find("a").hasClass("selected-channel")){return-1}else if($(t).find("a").hasClass("selected-channel")&&!$(e).find("a").hasClass("selected-channel")){return 1}else{return 0}});r.prependTo($(t).find("#channel-select"));$(t).find("#channel-select li a.selected-channel").last().parent().after('<li class="divider ignore"></li><li role="presentation" class="dropdown-header ignore">Other Channels</li>');$(t).find("#channel-select li a.selected-channel").first().parent().before('<li role="presentation" class="dropdown-header ignore">Visible Channels</li>');$(t).find("#channel-select li a").on("click",g.channelSelectHandler);$(".channel-select-dropdown").sortable({items:"li:has(.selected-channel)",cancel:".ignore"});e.stopPropagation()};this.addPicker=function(){var r=$(g.container);$(g.container).prepend($("<div>").addClass("btn-toolbar").css("margin-bottom",-50).css("position","absolute").css("left",g.width-110).append($("<div>").addClass("btn-group").append($("<button>").attr("class","btn btn-info dropdown-toggle").attr("data-toggle","dropdown").attr("href","#").html("Channels\n<span class='caret'></span>")).append($("<ul>").addClass("dropdown-menu dropdown-menu-right channel-select-dropdown").attr("id","channel-select").attr("role","menu"))));$(r).find("#channel-select").empty();$(r).find("#channel-select");var e=g.datasource;e.channels.forEach(function(e,t){if(e!="length"){$(r).find("#channel-select").append($("<li>").html("<a href='#'>"+e+"</a>"));console.log("Adding channel: "+e)}});$(r).find("#channel-select li a").each(function(e,t){console.log(t);console.log(g.channels.find($(t).text()));if(g.channels.find($(t).text()).length>0){$(t).attr("class","selected-channel")}else{$(t).attr("class","")}});$(r).find("#channel-select li a").on("click",g.channelSelectHandler);$(r).find("#channel-select").on("sortupdate",function(e){var a=[];$(r).find("#channel-select li a").each(function(e,t){g.datasourceContainer.select("#"+$(t).text()).datum(e)});g.datasourceContainer.selectAll("path").sort(d3.ascending);var a=[];$(r).find("#channel-select li a.selected-channel").each(function(e,t){a.push($(t).text())});g.setChannels(a)})};this.renderCanvas=function(e){var t=g.graph.getContext("2d");var a=$(canvas).width();var r=$(canvas).height();var n=a*1/e.length;var o=r*1/(e.max()-e.min());for(var i=1;i<e.length;i++){var s=e[i-1];var l=e[i];t.moveTo((i-1)*n,r-s*o);t.lineTo(i*n,r-l*o);t.stroke();t.fill()}};this.renderData=function(e){g.datasource=e;if(g.datasource.channels.find("Tonic").length>0&&g.datasource.channels.find("Phasic").length>0&&g.datasource.channels.find("EDA").length>0){console.log("Turning on tonic and phasic since they are present");g.channels=["EDA","Tonic","Phasic"]}else if(g.datasource.channels.find("EDA").length>0){g.channels=["EDA"]}else{g.channels=g.datasource.channels}var t=this.container;var a=$(t).width()/5<25?$(t).width()/5:25;g.w=$(t).width()-3*a;g.h=$(t).height()-2*a;g.datasource.x=d3.scale.linear().domain([0,g.w]).range([0,g.datasource.data.length]);g.datasource.y=d3.scale.linear().domain([0,g.h]).range([g.channels.map(function(e){return g.datasource.data[e].max()}).max(),g.channels.map(function(e){return g.datasource.data[e].min()}).min()]);g.datasource.getMultiChannelDataForOffsetRange(g.channels,0,g.datasource.data.length-1,g.w,function(e){g.renderSVG(e)})};this.zoom_rect={};this.resize=function(e,t){var a=this.container;g.p=$(a).width()/10<50?$(a).width()/10:50;if(t!=undefined){$(a).css("width",t);$(a).find("svg").attr("width",t);g.w=t-3*g.p;g.datasourceContainer.attr("width",g.w)}if(e!=undefined){$(a).css("height",e);$(a).find("svg").attr("height",e);g.h=$(a).height()-2*g.p;g.datasourceContainer.attr("height",g.h)}if(g.currentRange){g.renderUpdate(g.currentRange)}else{g.renderUpdate()}};this.setChannels=function(e){var t=[];for(var a=0;a<e.length;a++){var r=e[a];if(g.datasource.data.hasOwnProperty(r)&&g.datasource.data[r].isValid()){t.push(r);if(g.channels.find(r).length==0){if(r=="X"||r=="Y"||r=="Z"){g.datasourceContainer.append("path").attr("d","").attr("class",r).attr("id",r)}else{g.datasourceContainer.append("path").attr("d","").attr("class",r).attr("clip-path","url(#edaclip)").attr("id",r)}}}}for(var a=0;a<g.channels.length;a++){var r=g.channels[a];if(t.find(r).length==0){g.datasourceContainer.select("#"+r).remove();g.datasourceContainer.selectAll("."+r).remove();g.datasourceContainer.selectAll(".axis-label-"+r).remove()}}g.channels=t;var n=g.showAcc==true;if(g.channels.find("X").length>0||g.channels.find("Y").length>0||g.channels.find("Z").length>0){g.showAcc=true}else{g.showAcc=false;g.datasourceContainer.selectAll(".Acc").remove();g.datasourceContainer.selectAll(".axis-label-Acc").remove();if(!g.showAcc&&n){g.datasourceContainer.attr("height",g.h)}}$(g.container).find("#channel-select li a").each(function(e,t){console.log(t);console.log(g.channels.find($(t).text()));if(g.channels.find($(t).text()).length>0){$(t).attr("class","selected-channel")}else{$(t).attr("class","")}});if(g.currentRange){g.renderUpdate(g.currentRange)}else{g.renderUpdate()}g.datasourceContainer.selectAll(".marker").moveToFront()};this.unpackComment=function(e){e=e.replace(/^\s+|\s+$/g,"");if(e[0]=="|"){e=e.slice(1,e.length-1)}var t=e.replace(/\|/g,"<br />");return t};this.renderSVG=function(e,t){g.data=e;var a,r,n,o,i,s,l,d;o=g.container;a=$(o).width()/10<50?$(o).width()/10:50;g.p=a;r=$(o).width()-3*a;if(g.showACC){n=2*($(o).height()-3*a)/3}else{n=$(o).height()-2*a}g.w=r;g.h=n;g.datasource.x.domain([0,g.w]);var c=d3.scale.linear().domain([0,e.map(function(e){return e.length}).max()]).range([0,r]);if(g.datasource.y&&!g.autoscale){var u=[g.datasource.y.range()[1],g.datasource.y.range()[0]];var h=d3.scale.linear().domain(u).range([g.h,0])}else{var h=d3.scale.linear().domain([e.map(function(e){return e.min()}).min(),e.map(function(e){return e.max()}).max()]).range([g.h,0])}if(g.showAcc){h=h.range([g.h*(2/3),0]);var f=[];for(var p=0;p<g.channels.length;p++){if(g.channels[p]=="X"||g.channels[p]=="Y"||g.channels[p]=="Z"){f.push(g.data[p])}}var d=d3.scale.linear().domain([f.map(function(e){return e.min()}).min(),f.map(function(e){return e.max()}).max()]).range([g.h*(2/3),g.height]);l=d3.svg.line().x(function(e,t){return c(t)}).y(function(e){return d(e)})}s=d3.svg.line().x(function(e,t){return c(t)}).y(function(e){return h(e)});g.x=c;g.y=h;g.y2=d;g.lineAcc=l;g.svg=d3.select(o).append("svg").attr("class","graph").attr("width",g.width).attr("height",g.height);i=g.svg.append("g").attr("transform","translate("+2*a+","+a+")");i.append("defs").append("svg:clipPath").attr("id","edaclip").append("svg:rect").attr("id","clip-rect").attr("x","0").attr("y","0").attr("width",r).attr("height",n);g.datasourceContainer=i;g.datasourceContainer.on("mousedown",g.mousedown).on("mouseup",g.mouseup).on("dblclick",g.handleDoubleClick);g.renderGrid(g.datasourceContainer,g.channels[0]);for(var p=0;p<g.channels.length;p++){e[p].unshift(0);e[p].push(0);if((g.channels[p]=="X"||g.channels[p]=="Y"||g.channels[p]=="Z")&&g.showAcc){i.append("path").attr("d",g.lineAcc(e[p])).attr("class",g.channels[p]).attr("id",g.channels[p])}else{i.append("path").attr("d",s(e[p])).attr("class",g.channels[p]).attr("clip-path","url(#edaclip)").attr("id",g.channels[p])}}if(g.datasource.events&&g.datasource.events.length>0){g.eventIdx=[];for(var p=0;p<g.datasource.events.length;p++){var m=g.datasource.events[p];g.eventIdx.push(m.index);console.log("Marker at "+m+"("+g.datasource.x.invert(m.index)+"px in current coordinate space) or "+g.datasource.timeForOffset(m.index).toTimeString());i.append("circle").datum(m).attr("class","marker").attr("title",function(e){return g.unpackComment(e.comment+" | Time: "+g.datasource.timeForOffset(e.index).toTimeString())}).attr("cx",function(e){return g.x(g.datasource.x.invert(e.index))}).attr("cy",function(e){var t=Math.round(g.x(g.datasource.x.invert(e.index)));if(t<g.data[g.data.length-1].length&&t>=0){return g.y(g.data[g.data.length-1][t])}else{return 0}}).attr("r",3).style("stroke","rgba(200,0,0,1.0)").style("fill","rgba(200,0,0,0.5)").style("stroke-width",2);$("circle.marker").tooltip({container:"body",html:true,placement:"top"})}}if(g.datasource.rangeMarkers&&g.datasource.rangeMarkers.length>0){g.renderRangeMarkers(g.datasourceContainer,g.x,g.y)}if(g.readyCallback&&!g.didLoad){g.didLoad=true;g.readyCallback(g)}};this.tooltip=function(){var e=d3.mouse(this);g.datasourceContainer.select("g.gtooltip circle").attr("cx",e[0]).attr("cy",g.y(g.data[e[0]-g.p*2])).attr("r",8);g.datasourceContainer.select("text.gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).text(g.datasource.timeForOffset(g.datasource.x(e[0]-2*g.p)).toTimeString()+" | "+g.datasource.y(e[1]-g.p).toFixed(2).toString())};this.mouseover=function(){var e=d3.mouse(this);g.datasourceContainer.append("svg:g").attr("class","gtooltip").enter().append("svg:circle").attr("class",g.channels[0].toLowerCase()).style("stroke-width",3).attr("cx",e[0]).attr("cy",g.y(g.data[e[0]-g.p*2])).attr("r",8).append("svg:text").attr("class","gtooltip").attr("x",d3.mouse(this)[0]).attr("y",d3.mouse(this)[1]).attr("dy",-5).attr("text-anchor","middle").text(g.datasource.timeForOffset(g.datasource.x(e[0]-2*g.p)).toTimeString()+" | "+g.datasource.y(e[1]-g.p).toFixed(2).toString())};this.mousedown=function(){console.log("Mouse click at: "+d3.mouse(this));g.zoom_rect.p1=d3.mouse(this);g.zoom_rect.p2=d3.mouse(this);$(g.graph).find("rect.zoomrect").tooltip("destroy");g.datasourceContainer.select("rect.zoomrect").remove();g.datasourceContainer.append("svg:rect").attr("class","zoomrect").attr("x",g.zoom_rect.p1[0]).attr("y",g.zoom_rect.p1[1]).attr("title","").style("stroke","red").style("stroke-width",2).style("fill","rgba(255,0,0,0.2)").attr("width",Math.abs(g.zoom_rect.p1[0]-g.zoom_rect.p2[0])).attr("height",Math.abs(g.zoom_rect.p1[1]-g.zoom_rect.p2[1]));g.datasourceContainer.on("mousemove",function(){g.zoom_rect.p2=d3.mouse(this);g.datasourceContainer.on("mouseup",g.mouseup);var e=[g.zoom_rect.p1[0],g.zoom_rect.p2[0]].min();var t=[g.zoom_rect.p1[1],g.zoom_rect.p2[1]].min();var a=Math.abs(g.zoom_rect.p1[0]-g.zoom_rect.p2[0]);var r=Math.abs(g.zoom_rect.p1[1]-g.zoom_rect.p2[1]);var n=g.datasource.timeForOffset(g.datasource.x([g.zoom_rect.p1[0],g.zoom_rect.p2[0]].min()));var o=g.datasource.timeForOffset(g.datasource.x([g.zoom_rect.p1[0],g.zoom_rect.p2[0]].max()));if(g.autoscale){g.datasourceContainer.select("rect.zoomrect").attr("x",e).attr("y",0).attr("title","<i class='icon-time'></i> "+n.shortString()+" to "+o.shortString()).attr("width",a).attr("height",g.h);if($(".tooltip-inner").length==0){$(g.graph).find("rect.zoomrect").tooltip({container:"body",placement:"top",html:true,trigger:"manual",delay:{show:0,hide:1e3}}).tooltip("show")}else{$(".tooltip-inner").first().html(g.datasourceContainer.select("rect.zoomrect").attr("title"))}}else{g.datasourceContainer.select("rect.zoomrect").attr("x",e).attr("y",t).attr("width",a).attr("height",r)}})};this.zoom=function(e,t,a){try{var r=g.datasourceContainer[0][0].getBoundingClientRect();if(!(e<=g.datasource.startTime&&t>=g.datasource.endTime)){$(g.container).append($("<button>").addClass("btn").addClass("clearButton").css("display","block").css("position","absolute").css("left",g.width-110-10).css("top",r.top+scrollY+g.p+10).html("<i class='icon-zoom-out'></i> Zoom Out").on("click",function(e){$(g.container).find("button.clearButton").remove();g.renderUpdate("full");if(g.onzoom!=undefined){g.onzoom(g.datasource.startTime,g.datasource.endTime,"zoomout")}return false}))}else{}if(e==g.datasource.startTime&&t==g.datasource.endTime){$(g.container).find("button.clearButton").remove()}if(e==undefined&&t==undefined){try{var n=[g.zoom_rect.p1[0],g.zoom_rect.p2[0]].min();var o=[g.zoom_rect.p1[0],g.zoom_rect.p2[0]].max();var i=[g.zoom_rect.p1[1],g.zoom_rect.p2[1]].min()-g.p;var s=[g.zoom_rect.p1[1],g.zoom_rect.p2[1]].max()-g.p}catch(e){}}if(e<g.datasource.startTime){e=g.datasource.startTime;console.log("Got start time: "+e+" that was earlier than EDA start time: "+g.datasource.startTime)}if(t>g.datasource.endTime){t=g.datasource.endTime.sub(TimeDelta(1));console.log("Got end time: "+t+" that was later than EDA end time: "+g.datasource.endTime)}var l={};if(e){l.xmin=int(g.datasource.offsetForTime(e))}else{l.xmin=int(g.datasource.x(n))}if(isNaN(l.xmin)||l.xmin<0)l.xmin=0;if(t){l.xmax=int(g.datasource.offsetForTime(t))}else{l.xmax=int(g.datasource.x(o))}if(isNaN(l.xmax)||l.xmax>g.datasource.offsetForTime(g.datasource.endTime)){l.xmax=g.channels.map(function(e){return g.datasource.data[e].length}).min()}l.ymin=g.datasource.y(s)||0;l.ymax=g.datasource.y(i)||1;console.log("Before onzoom with Start="+g.datasource.timeForOffset(l.xmin)+" End="+g.datasource.timeForOffset(l.xmax));g.currentRange=l;g.renderUpdate(l);if(g.onzoom!=undefined&&(e==undefined&&t==undefined)){g.onzoom(g.datasource.timeForOffset(l.xmin),g.datasource.timeForOffset(l.xmax))}}catch(e){console.log(e);g.onzoom(g.datasource.startTime,g.datasource.endTime,"zoomout")}};this.mouseup=function(){$(g.graph).find("rect.zoomrect").tooltip("destroy");g.datasourceContainer.on("mousemove",null);if(!g.isEditing){$(".popover").popover("destroy")}var e=Math.abs(g.zoom_rect.p1[0]-g.zoom_rect.p2[0]);var t=Math.abs(g.zoom_rect.p1[1]-g.zoom_rect.p2[1]);var a=g.datasource.timeForOffset(int(g.datasource.x([g.zoom_rect.p1[0],g.zoom_rect.p2[0]].min())));var r=g.datasource.timeForOffset(int(g.datasource.x([g.zoom_rect.p1[0],g.zoom_rect.p2[0]].max())));if(e>3){var n="ZOOM_ID_"+parseInt(Math.random()*1e3,10).toString();var o="ADD_RANGE_ID_"+parseInt(Math.random()*1e3,10).toString();var i="COMMENT_ID_"+parseInt(Math.random()*1e3,10).toString();var s='<label for="COMMENT_ID">POPOVER_INPUT_LABEL</label><input type="POPOVER_INPUT_TYPE" class="form-control" placeholder="POPOVER_INPUT_PLACEHOLDER" id="COMMENT_ID"><br /><input id="COMMENT_ID_COLOR" type="text" value="4BAAA9"  class="pick-a-color form-control"><br /><div class="btn-group"><button class=\'btn btn-default\' id=\'ZOOM_ID\'><i class=\'icon-zoom-in\'></i> Zoom</button><button class=\'btn btn-primary\' id=\'ADD_RANGE_ID\'><i class=\'icon-map-marker\'></i> Add Range Marker</button></div>'.replace("ZOOM_ID",n).replace("ADD_RANGE_ID",o).replace("POPOVER_INPUT_LABEL",g.annotationLabel).replace("POPOVER_INPUT_TYPE",g.annotationType).replace("POPOVER_INPUT_PLACEHOLDER",g.annotationPlaceholder).replace(/COMMENT_ID/g,i);$(g.graph).find("rect.zoomrect").popover({html:true,container:"body",placement:window.isEmbed?"auto right":"top",trigger:"manual",content:s});$(g.graph).find("rect.zoomrect").popover("show");$("button#"+n).on("click",function(){$(".popover").popover("destroy");g.datasourceContainer.select("rect.zoomrect").remove();g.zoom()});$("button#"+o).on("click",function(){$(".popover").popover("destroy");g.datasourceContainer.select("rect.zoomrect").remove();var e=$("input#"+i).val();var t=$("input#"+i+"_COLOR").val();g.addRangeMarker(a,r,e,t)});$(document).one("keydown",function(e){console.log("Key pressed: "+e.keyCode);if(e.keyCode==27){$(".popover").popover("destroy");g.datasourceContainer.select("rect.zoomrect").remove()}});try{$("input#"+i+"_COLOR").pickAColor()}catch(e){console.log(e)}}else{g.datasourceContainer.select("rect.zoomrect").remove()}};this.addRangeMarker=function(e,t,a,r){if(!g.datasource.hasOwnProperty("rangeMarkers")){g.datasource.rangeMarkers=new Array}console.log("Start: "+e+" End: "+t+" Comment: "+a);g.datasource.rangeMarkers.push({startTime:e,endTime:t,comment:a,color:r});g.renderRangeMarkers(g.datasourceContainer,g.x,g.y);g.updateCache()};this.updateCache=function(){localStorage[g.datasource.hash()]=JSON.stringify({rangeMarkers:g.datasource.rangeMarkers})};this.editRangeMarker=function(e){if(g.isEditing){return}g.isEditing=true;var o=this;console.log("Opening edit range marker dialogue");console.log(o);var t=d3.select(o).attr("data-index")*1;d3.select(o).on("mousedown",null);d3.select(o).on("click",null);g.datasourceContainer.on("mousedown",null);var a="DONE_ID_"+parseInt(Math.random()*1e3,10).toString();var i="COMMENT_ID_"+parseInt(Math.random()*1e3,10).toString();var r="REMOVE_ID_"+parseInt(Math.random()*1e3,10).toString();var s="EXPORT_ID_"+parseInt(Math.random()*1e3,10).toString();var n="<input id=\"COMMENT_ID_COLOR\" type=\"text\" value=\"CURRENT_COLOR\"  class=\"pick-a-color form-control\"><br /><button class='btn btn-danger pull-left' id='REMOVE_ID'>Delete</button><button class='btn btn-info pull-right' id='EXPORT_ID'>Export</button><button class='btn btn-default pull-right' id='DONE_ID'>Save</button>".replace("DONE_ID",a).replace("REMOVE_ID",r).replace(/COMMENT_ID/g,i).replace("CURRENT_COLOR",g.datasource.rangeMarkers[t].color).replace("EXPORT_ID",s);d3.select(o).transition().attr("y",-g.RANGE_MARKER_HEIGHT).style("opacity",.5).attr("height",g.h+g.RANGE_MARKER_HEIGHT);$(o).attr("title",null);$(o).attr("data-original-title",null);$(o).popover({html:true,title:'<input type="POPOVER_INPUT_TYPE" class="form-control" placeholder="POPOVER_INPUT_PLACEHOLDER" id="COMMENT_ID">'.replace("COMMENT_ID",i).replace("POPOVER_INPUT_TYPE",g.annotationType).replace("POPOVER_INPUT_PLACEHOLDER",g.annotationPlaceholder),container:"body",placement:window.isEmbed?"auto right":"top",trigger:"manual",content:n});var l=$(o).attr("x")*1;var d=l+$(o).attr("width")*1;var c=g.datasourceContainer.append("svg:g").attr("class","rangemarker edit");c.append("svg:line").style("stroke","red").style("stroke-width","4").style("cursor","pointer").attr("y1",0).attr("y2",g.h).attr("x1",l).attr("x2",l);c.append("svg:circle").attr("cx",l).attr("cy",0).attr("r",5).style("stroke","red").style("fill","red").style("stroke-width","2").style("cursor","pointer");c.on("mousedown",function(){var e=d3.select(this);g.datasourceContainer.on("mousemove",function(){var e=d3.mouse(this)[0];console.log("Left Handle: "+e);c.select("line").attr("x1",e);c.select("line").attr("x2",e);c.select("circle").attr("cx",e);d3.select(o).attr("x",c.select("line").attr("x1")).attr("width",u.select("line").attr("x1")*1-c.select("line").attr("x1")*1)});g.datasourceContainer.on("mouseup",function(){g.datasourceContainer.on("mousemove",null)})});var u=g.datasourceContainer.append("svg:g").attr("class","rangemarker edit");u.append("svg:line").style("stroke","red").style("stroke-width","4").style("cursor","pointer").attr("y1",0).attr("y2",g.h).attr("x1",d).attr("x2",d);u.append("svg:circle").attr("cx",d).attr("cy",g.h).attr("r",5).style("stroke","red").style("fill","red").style("stroke-width","2").style("cursor","pointer");u.on("mousedown",function(){var e=d3.select(this);g.datasourceContainer.on("mousemove",function(){var e=d3.mouse(this)[0];u.select("line").attr("x1",e);u.select("line").attr("x2",e);u.select("circle").attr("cx",e);d3.select(o).attr("x",c.select("line").attr("x1")).attr("width",u.select("line").attr("x1")*1-c.select("line").attr("x1")*1)});g.datasourceContainer.on("mouseup",function(){g.datasourceContainer.on("mousemove",null)})});$(o).popover("show");$("input#"+i).attr("value",g.datasource.rangeMarkers[t].comment);$("button#"+a).on("click",function(){$(o).popover("destroy");c.remove();u.remove();g.datasourceContainer.on("mousedown",g.mousedown,false);var e=d3.select(o).attr("x")*1;var t=d3.select(o).attr("width")*1+e;var a=g.datasource.timeForOffset(int(g.datasource.x(e)));var r=g.datasource.timeForOffset(int(g.datasource.x(t)));var n=d3.select(o).attr("data-index")*1;g.datasource.rangeMarkers[n]={startTime:a,endTime:r,comment:$("input#"+i).val(),color:$("input#"+i+"_COLOR").val()||g.datasource.rangeMarkers[n].color};g.renderRangeMarkers(g.datasourceContainer,g.x,g.y);g.updateCache();g.isEditing=false});$("button#"+r).on("click",function(){$(o).popover("destroy");c.remove();u.remove();g.datasourceContainer.on("mousedown",g.mousedown,false);var e=d3.select(o).attr("data-index")*1;g.datasource.rangeMarkers.splice(e,1);g.renderRangeMarkers(g.datasourceContainer,g.x,g.y);g.updateCache();g.isEditing=false});$(document).one("keydown",function(e){console.log("Key pressed: "+e.keyCode);if(e.keyCode==27){$(o).popover("destroy");c.remove();u.remove();g.datasourceContainer.on("mousedown",g.mousedown,false);g.renderRangeMarkers(g.datasourceContainer,g.x,g.y);g.updateCache();g.isEditing=false}});$("button#"+s).on("click",function(){var e=d3.select(o).attr("x")*1;var t=d3.select(o).attr("width")*1+e;var a=g.datasource.timeForOffset(int(g.datasource.x(e)));var r=g.datasource.timeForOffset(int(g.datasource.x(t)));var n=g.datasource.filename+"_"+$("input#"+i).val()+".csv";console.log("Exporting data from  "+a.toTimeString()+" to "+r.toTimeString()+" as "+n);g.datasource.exportCropped(a,r,n);$(this).html("Exporting...").attr("disabled","disabled");setTimeout(function(){$("button#"+s).html("Export").attr("disabled",null)},3e3)});try{$("input#"+i+"_COLOR").pickAColor()}catch(e){console.log(e)}};this.renderRangeMarkers=function(e,t,a){if(g.datasource.hasOwnProperty("rangeMarkers")){console.log("Rendering range markers");e.selectAll("rect.rangemarker").remove();for(var r=0;r<g.datasource.rangeMarkers.length;r++){var n=g.datasource.rangeMarkers[r];n.startTime=new Date(n.startTime);n.endTime=new Date(n.endTime);var o=e.append("svg:rect").attr("class","rangemarker").attr("data-index",r).attr("title",n.comment).attr("x",g.datasource.x.invert(g.datasource.offsetForTime(n.startTime))).style("fill","#"+n.color).style("opacity",.85).attr("y",-g.RANGE_MARKER_HEIGHT).attr("width",g.datasource.x.invert(g.datasource.offsetForTime(n.endTime))-g.datasource.x.invert(g.datasource.offsetForTime(n.startTime))).attr("height",g.RANGE_MARKER_HEIGHT).on("mousedown",g.editRangeMarker);$("rect.rangemarker").tooltip({container:"body",html:true,placement:"top"});console.log(o)}}};this.handleDoubleClick=function(e){var e=g.datasource.timeForOffset(g.datasource.x(d3.mouse(this)[0]));console.log("Double click at time: "+e.toTimeString());for(var t=0;t<g.doubleClickCallbacks.length;t++){g.doubleClickCallbacks[t](e)}};this.onDoubleClick=function(e){if(!this.hasOwnProperty("doubleClickCallbacks")){this.doubleClickCallbacks=[]}this.doubleClickCallbacks.push(e)};this.offDoubleClick=function(e){if(!this.hasOwnProperty("doubleClickCallbacks")){this.doubleClickCallbacks=[]}var t=this.doubleClickCallbacks.indexOf(e);if(t>-1){this.doubleClickCallbacks.splice(t,1)}};this.updateCursor=function(e){var t=g.datasource.fractionalOffsetForTime(e);g.datasourceContainer.selectAll("line.cursor").remove();if(g.followCursor){g.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",g.h).attr("x1",g.w/2).attr("x2",g.w/2)}else{g.datasourceContainer.append("svg:line").attr("class","cursor").style("stroke","red").style("stroke-width","3").attr("y1",0).attr("y2",g.h).attr("x1",g.datasource.x.invert(t)).attr("x2",g.datasource.x.invert(t))}};this.renderUpdate=function(e){if(e=="full"||e==undefined||e==null){var e={};e.xmin=0;e.xmax=g.channels.map(function(e){return g.datasource.data[e].length}).min()-1;e.ymin=g.channels.map(function(e){return g.datasource.data[e].min()}).min();e.ymax=g.channels.map(function(e){return g.datasource.data[e].max()}).max()}g.currentRange=e;g.datasource.x=d3.scale.linear().domain([0,g.w]).range([e.xmin,e.xmax]);g.datasource.y=d3.scale.linear().domain([0,g.h]).range([e.ymax,e.ymin]);var t=e.xmax-e.xmin>g.w?g.w:e.xmax-e.xmin;g.datasource.getMultiChannelDataForOffsetRange(g.channels,e.xmin,e.xmax,t,g.updateSVG)};this.updateSVG=function(e){console.log("Updating SVG");if(e.length>g.channels.length){console.log("It's happening again..");e=e.slice(1,e.length-1)}console.log(e);g.datasource.x.domain([0,g.w]);var a=d3.scale.linear().domain([0,e.map(function(e){return e.length}).max()]).range([0,g.w]);if(g.datasource.y&&!g.autoscale){var t=[g.datasource.y.range()[1],g.datasource.y.range()[0]];var r=d3.scale.linear().domain(t).range([g.h,0])}else{if(g.showAcc){var n=[];for(var o=0;o<e.length;o++){if(!(g.channels[o]=="X"||g.channels[o]=="Y"||g.channels[o]=="Z")){n.push(e[o])}}var r=d3.scale.linear().domain([n.map(function(e){return e.min()}).min()*(1-g.headroom),n.map(function(e){return e.max()}).max()*(1+g.headroom)]).range([g.h*(2/3),0])}else{var r=d3.scale.linear().domain([e.map(function(e){return e.min()}).min(),e.map(function(e){return e.max()}).max()]).range([g.h,0])}}if(g.showAcc){var i=[];for(var o=0;o<g.channels.length;o++){if(g.channels[o]=="X"||g.channels[o]=="Y"||g.channels[o]=="Z"){i.push(e[o])}}g.y2=d3.scale.linear().domain([i.map(function(e){return e.min()}).min(),i.map(function(e){return e.max()}).max()]).range([g.h,g.h*(2/3)+g.p/3]);var s=d3.svg.line().x(function(e,t){return a(t)}).y(function(e){return g.y2(e)})}g.x=a;g.y=r;g.datasourceContainer.select("#edaclip rect").attr("height",r.range().max()-r.range().min()).attr("y",r.range().min()).attr("width",a.range().max()-a.range().min()).attr("x",a.range().min());var l=d3.svg.line().x(function(e,t){return a(t)}).y(function(e){return r(e)});g.data=e;g.renderGrid(g.datasourceContainer,g.channels[0],a,r);if(g.showAcc){g.renderGrid(g.datasourceContainer,"Acc",g.x,g.y2)}for(var o=0;o<g.channels.length;o++){e[o].unshift(0);e[o].push(0);console.log("Updating Data for "+g.channels[o]);if((g.channels[o]=="X"||g.channels[o]=="Y"||g.channels[o]=="Z")&&g.showAcc){g.datasourceContainer.select("#"+g.channels[o]).transition(500).attr("d",s(e[o]))}else{g.datasourceContainer.select("#"+g.channels[o]).transition(500).attr("d",l(e[o]))}}g.datasourceContainer.selectAll(".marker").transition().duration(500).attr("cx",function(e){return g.x(g.datasource.x.invert(e.index))}).style("opacity",function(e){var t=Math.round(g.x(g.datasource.x.invert(e.index)));if(t<g.data[0].length&&t>=0){return 1}else{return 0}}).attr("cy",function(e){var t=Math.round(g.datasource.x.invert(e.index));if(g.showAcc){if(t<n[n.length-1].length&&t>=0){return g.y(n[n.length-1][t])}else{return 0}}else if(t<g.data[g.data.length-1].length&&t>=0){return g.y(g.data[g.data.length-1][t])}else{return 0}});g.renderRangeMarkers(g.datasourceContainer,g.x,g.y)};this.renderGrid=function(e,t,a,r,n,o){var t=t||g.channels[0];var a=a||g.x;var r=r||g.y;var o=o||g.w;var n=n||r.range().max()-r.range().min();var i=this.p;console.log("Rendering grid...");console.log(a.domain());console.log(a.range());g.datasourceContainer.selectAll("#background-rect-"+t).remove();var s=e.append("svg:rect").attr("class","background "+t).attr("id","background-rect-"+t).attr("x",0).attr("y",r.range().min()).attr("width",o).attr("height",n);e.selectAll("g."+t).remove();var l=a.ticks(o/150);console.log("X Ticks at: ");console.log(l);var d=e.selectAll("g.x."+t).data(l).enter().append("svg:g").attr("class","x "+t);d.append("svg:line").attr("class","grid").style("shape-rendering","crispEdges").attr("x1",a).attr("x2",a).attr("y1",r.range().min()).attr("y2",r.range().max());var c=g.datasource.timeForOffset(g.datasource.x(l[0])).getDate()!=g.datasource.timeForOffset(g.datasource.x(l[l.length-1])).getDate();if(t!="Acc"){d.append("svg:text").attr("class","xText "+t).attr("x",a).attr("y",g.h+10).attr("dy",".35em").style("text-anchor","middle").text(function(e,t){return g.datasource.timeForOffset(g.datasource.x(a(e))).shortString(c)})}var u=n/30;var h=e.selectAll("g.y."+t).data(r.ticks(u)).enter().append("svg:g").attr("class","y "+t);h.append("svg:line").attr("class","grid "+t).style("shape-rendering","crispEdges").attr("x1",0).attr("x2",o).attr("y1",r).attr("y2",r);h.selectAll(".yText").remove();h.append("svg:text").attr("class","yText "+t).attr("x",-3).attr("y",r).attr("dy",".35em").attr("text-anchor","end").text(function(e,t){return e.toFixed(2).toString()});g.datasourceContainer.selectAll("text.axis-label-"+t).remove();var f="";f=t;if(g.units.hasOwnProperty(t)){f+=" ("+g.units[t]+")"}var p=r.range().min()+(r.range().max()-r.range().min())/2;e.append("svg:text").attr("class","axis-label axis-label-"+t).attr("x",0).attr("y",p).attr("dy","0em").attr("dx","-"+i+"px").attr("text-anchor","middle").attr("transform","rotate(-90, "+-g.p+", "+p+")").text(f);g.datasourceContainer.selectAll("text.title").remove();e.append("svg:text").attr("class","title").attr("x",o/2).attr("y",0).attr("dy","-"+i/4+"px").attr("dx",0).attr("text-anchor","middle").text(g.datasource.filename)}};var version={build:184};