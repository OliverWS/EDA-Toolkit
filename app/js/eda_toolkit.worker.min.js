/**
* EDA Toolkit
* Copyright 2013 Oliver Wilder-Smith 
* http://www.apache.org/licenses/LICENSE-2.0
*/
var e=Math.E;var pi=Math.PI;var np={};var MU="μ";urlParams=function(){var a=location.search.substring(1).split("&");var b={};var c={"true":true,"false":false,"null":null};for(var d=0,e=a.length;d<e;d++){var f=a[d];var g=f.indexOf("=");var h=g==-1?f:f.substring(0,g);var i=g==-1?true:f.substring(g+1);if(i in c){i=c[i]}else if(""+parseFloat(i,10)==i){i=parseFloat(i,10)}b[h]=i}a=c=null;return function j(a){return a in b?b[a]:null}}();float=function(a){return a*1};int=function(a){return parseInt(a,10)};pow=function(a,b){return Math.pow(a,b)};round=function(a,b){var b=b||0;return a.toFixed(b)};String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1};var log=function(a){if(window.console){console.log(a)}};var toast=function(a){var b=document.createElement("div");b.className="toast alert alert-info";b.innerHTML=a;b.style.position="absolute";b.style.display="block";b.style.width="30%";b.style.left="50%";b.style.top="50%";b.style["margin-left"]="-15%";b.style["margin-top"]="0px";document.getElementsByTagName("body")[0].appendChild(b);$(".toast").fadeOut(0);$(".toast").fadeIn(500);setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(a,b){return a.toFixed(b)};function testBit(a,b){var c=1<<b;return a&c}function truncate(a,b){var b=b||0;return Math.trunc(a*pow(10,b))/float(pow(10,b),b)}function unpackStruct(a){var b=[];for(var c=0;c<a.length;c+=2){var d=a.charCodeAt(c);var e=a.charCodeAt(c+1);var f=d*256+e;b.push(f)}return b}function unpackSigned(a){var b=testBit(a,15)>0;var c=a>>13&3;var d=float(a&1023)/1e3;if(b)return truncate(round(-1*d*pow(10,c),3-c),3-c);else return truncate(round(d*pow(10,c),3-c),3-c)}function unpackUnsigned(a){var b=a>>14&3;var c=float(a&16383)/1e4;return truncate(round(c*pow(10,b),4-b),4-b)}Number.prototype.pad=function(a){var b=""+this;var c=b.length-a;for(var d=0;d<c;d++){b="0"+b}return b};Date.prototype.toQFormat=function(){var a="";a+=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate();a+=" ";a+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2);a+=" ";a+="Offset:"+(this.getTimezoneOffset()>0?"+"+this.getTimezoneOffset():this.getTimezoneOffset());return a};Array.prototype.isValid=function(){var a=this;return a.filter(function(a){return!isNaN(a)}).length==a.length};parseDate=function(a){var b=a.split(" ")[0];var c=a.split(" ")[1];var d=float(a.split(" ")[2].split(":")[1]);var e=int(b.split("-")[0]);var f=int(b.split("-")[1]-1);var g=int(b.split("-")[2]);var h=int(c.split(":")[0]);var i=int(c.split(":")[1]);var j=int(c.split(":")[2]);return new Date(e,f,g,h,i,j,0)};var TimeDelta=function(a){var b={};if(!a.isPrototypeOf(Object)){b.days=Math.floor(a/(1e3*60*60*24));b.hours=Math.floor(a%(1e3*60*60*24)/(1e3*60*60));b.minutes=Math.floor(a%(1e3*60*60)/(1e3*60));b.seconds=Math.floor(a%(1e3*60)/1e3);b.milliseconds=Math.floor(a%1e3)}else{b.days=a.days||0;b.hours=a.hours||0;b.minutes=a.minutes||0;b.seconds=a.seconds||0;b.milliseconds=a.milliseconds||0}b.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)};b.valueOf=function(){var a=0;a+=1e3*60*60*24*this.days;a+=1e3*60*60*this.hours;a+=1e3*60*this.minutes;a+=1e3*this.seconds;a+=this.milliseconds;return a};return b};Date.prototype.sub=function(a){var b=this.valueOf()-a.valueOf();return TimeDelta(b)};Date.prototype.add=function(a){return new Date(this.valueOf()+TimeDelta(a).valueOf())};Date.prototype.addMilliseconds=function(a){var b=new Date(this.valueOf()+a);return b};Date.prototype.addSeconds=function(a){return this.addMilliseconds(a*1e3)};Date.prototype.addMinutes=function(a){return this.addSeconds(60*a)};Date.prototype.addHours=function(a){return this.addMinutes(60*a)};Date.prototype.addDays=function(a){return this.addHours(24*a)};Date.prototype.getMinutesSinceMidnight=function(){var a=new Date(this.toString());a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);var b=(a.valueOf()-this.valueOf())/(60*1e3);return b};Date.prototype.shortString=function(a){if(a){return this.toLocaleDateString()+" "+this.toLocaleTimeString()}else{return this.toLocaleTimeString()}};String.prototype.contains=function(a){return this.indexOf(a)>-1};String.prototype.isnum=function(){try{var a=parseFloat(this.toString());return true}catch(b){return false}};String.prototype.isdate=function(){try{var a=new Date(this.toString());if(!a.valueOf().isNaN()){return true}else{return false}}catch(b){return false}};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());if(b!=NaN){return b}else{return this.toString()}}catch(a){return this.toString()}}};guess=function(a){if(typeof a!="string"){return typeof a}else if(a.isdate()){return"date"}else if(a.isnum()){if(a.toString().contains(".")||a.toString().contains(",")){return"float"}else{return"int"}}else{return"unknown"}};autoformat=function(a){var b=guess(a);switch(b){case"float":return float(a);break;case"int":return int(a);break;case"date":return new Date(a);break;default:return a;break}};gaussian=function(a,b){var c=Math.sqrt(b);var d=1/(c*Math.sqrt(2*pi));var f=0;var g=-1*(Math.pow(a-f,2)/(2*c*c));var h=d*Math.pow(e,g);return h};gaussianKernel=function(a,b){var c=new Array;for(var d=-1*b/2;d<b/2;d++){c.push(gaussian(d,a))}return c};gaussianFilter=function(a,b,c){var d=new Array;if(c==undefined){c=100}for(var e=0;e<a.length;e++){var f=e-c/2<0?0:e-c/2;var g=e+c/2>=a.length?a.length-1:e+c/2;var h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};np.timeRange=function(a,b,c){var d=b-a;var e=Math.floor(float(d)/c);var f=new Array;for(var g=0;g<c;g++){f.push(a.addMilliseconds(e*g))}return f};np.arange=function(a,b,c){if(c==undefined){c=1}var d=new Array;for(var e=a;e<b;e+=c){d.push(e)}return d};np.round=function(a,b){var c=a%b;if(c>b/2){a=(Math.round(a/b)+1)*b}else{a=Math.round(a/b)*b}return a};np.map=function(a,b){var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};np.max=function(a){var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};np.min=function(a){var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};convolve=function(a,b){var c=new Array;if(a.length!=b.length){return false}else{for(var d=0;d<a.length;d++){c.push(a[d]*b[d])}return c}};np.sum=function(a){var b=0;for(var c=0;c<a.length;c++){if(!a[c].isNaN()){b+=a[c]}}return b};Array.prototype.max=function(){var a=this.filter(function(a){return!isNaN(a)});var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};Array.prototype.min=function(){var a=this.filter(function(a){return!isNaN(a)});var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};Array.prototype.find=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){if(b[d]==a){c.push(d)}}return c};Array.prototype.map=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};Array.prototype.max=function(){var a=this;var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};Array.prototype.min=function(){var a=this;var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};Array.prototype.map=function(a){var b=this;var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};float=function(a){return a*1};int=function(a){return parseInt(a,10)};Array.prototype.clone=function(){var a=this;var b=new Array;for(var c=0;c<a.length;c++){b.push(a[c])}return b};gaussian=function(a,b){var c=Math.sqrt(b);var d=1/(c*Math.sqrt(2*pi));var f=0;var g=-1*(Math.pow(a-f,2)/(2*c*c));var h=d*Math.pow(e,g);return h};gaussianKernel=function(a,b){var c=new Array;for(var d=-1*b/2;d<b/2;d++){c.push(gaussian(d,a))}return c};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());if(b!=NaN){return b}else{return this.toString()}}catch(a){return this.toString()}}};gaussianFilter=function(a,b,c){var d=new Array;if(c==undefined){c=100}for(var e=0;e<a.length;e++){var f=e-c/2<0?0:e-c/2;var g=e+c/2>=a.length?a.length-1:e+c/2;var h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};var np=np||{};np.arange=function(a,b,c){if(c==undefined){c=1}var d=new Array;for(var e=a;e<b;e+=c){d.push(e)}return d};np.round=function(a,b){var c=a%b;if(c>b/2){a=(Math.round(a/b)+1)*b}else{a=Math.round(a/b)*b}return a};np.map=function(a,b){var c=new Array;for(var d=0;d<b.length;d++){c.push(a(b[d]))}return c};np.max=function(a){var b=-Infinity;for(var c=0;c<a.length;c++){if(a[c]>b){b=a[c]}}return b};np.min=function(a){var b=Infinity;for(var c=0;c<a.length;c++){if(a[c]<b){b=a[c]}}return b};convolve=function(a,b){var c=new Array;if(a.length!=b.length){return false}else{for(var d=0;d<a.length;d++){c.push(a[d]*b[d])}return c}};np.sum=function(a){var b=0;for(var c=0;c<a.length;c++){if(!a[c].isNaN){b+=a[c]}}return b};np.mean=function(a){return np.sum(a)/(1*a.length)};np.average=np.mean;np.avg=np.mean;np.median=function(a){var b=a.clone();b.sort();var c=int(Math.ceil(a.length/2))-1;if(a.length%2==0){return np.mean(b.slice(c,-c))}else{return b[c]}};var signals=signals||{};signals.sanitize=function(a,b,c){var b=b||[0];var c=c||[NaN];for(var d=0;d<a.length;d++){for(var e=0;e<c.length;e++){if(c[e]=="-"){if(a[d]<0){a[d]=b[e]}}else if(a[d]==c[e]){a[d]=b[e]}}}return a};signals.gaussianFilter=function(a,b){return gaussianFilter(a,b,10)};signals.medianFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.median(a.slice(e,f)))}return c};signals.maxFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.max(a.slice(e,f)))}return c};signals.minFilter=function(a,b){var b=b||3;var c=new Array;for(var d=0;d<a.length;d++){var e=d-b/2<0?0:d-b/2;var f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.min(a.slice(e,f)))}return c};signals.diff=function(a){var b=new Array;for(var c=0;c<a.length-1;c++){b.push(a[c+1]-a[c])}return b};signals.where=function(a,b){var c=new Array;for(var d=0;d<a.length;d++){if(b(a[d])){c.push(d)}}return c};signals.zeroCrossings=function(a){var b=new Array;for(var c=1;c<a.length;c++){if(a[c-1]<0&&a[c]>0){b[c]=1}else if(a[c-1]>0&&a[c]<0){b[c]=-1}else{b[c]=0}}return b};signals.peaks=function(a,b){var c=new Array;var d=signals.diff(a);var e=signals.zeroCrossings(a);var f=signals.where(c,function(a){return a>0});var g=signals.where(c,function(a){return a<0});return[f,g]};var separator="---------------------------------------------------------\r\n";var LF="\r\n";var console={};console.log=function(a){self.postMessage({cmd:"console",msg:a})};self.addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"load":if(b.filename!=undefined)self.filename=b.filename;self.get(b.url,self.parse);break;case"loadText":if(b.filename!=undefined)self.filename=b.filename;self.parse(b.data);break;case"downsample":self.downsample(b.data);break;case"downsampleMultiChannel":self.downsampleMultiChannel(b.data);break;case"scrs":self.SCRs(b.data);break;case"export":self.export(b.data);break;case"filter":self.filter(b.data);break;case"stop":self.postMessage("WORKER STOPPED: "+b.msg+". (buttons will no longer work)");self.close();break;default:self.postMessage("Unknown command: "+b.msg)}},false);self.parse=function(a){a=a.toString();if(!a.contains(LF)){LF="\n"}var b=self.detectFormat(a);switch(b){case"edafile":var c=a.split(separator);var d=c[0].split(LF);var e=self.parseHeaders(d);a=null;if(e["File Version"]<1.1){self.parseTextData(c[1],["Z","Y","X","Battery","Temperature","EDA"])}else if(e["File Version"]<1.5&&e["File Version"]>1.09){self.parseTextData(c[1],e["Column Names"])}else{self.parseBinaryData(c[1],["Z","Y","X","Battery","Temperature","EDA"])}break;case"csv":var c=a.split(LF);var d=c.slice(0,4);console.log("Headers: "+d.join("|"));var e=self.parseDSVHeaders(d,",");console.log("Parsed Headers: "+e["Column Names"].join(","));var f=a.replace(e["headerLines"],"");a=null;self.parseTextData(f,e["Column Names"]);break;case"tsv":var c=a.split(LF);var d=c.slice(0,4);console.log("Headers: "+d.join("|"));var f=a.toString().replace(d[0]+LF,"");var e=self.parseDSVHeaders(d,"	");console.log("Parsed Headers: "+e["Column Names"].join("	"));a=null;self.parseTextData(f,e["Column Names"]);break;default:var c=a.toString().split(LF);var d=c.slice(0,4);var f=a.toString().replace(d[0]+LF,"");a=null;var e=self.parseDSVHeaders(d,",");self.parseTextData(f,e["Column Names"]);break}};self.detectFormat=function(a){if(a.indexOf("\n")==-1){LF="\r"}if(a.indexOf(separator)>-1){LF="\r\n";return"edafile"}else if(a.indexOf("	")>-1&&!(a.indexOf(",")>-1)){return"tsv"}else{return"csv"}};self.parseDSVHeaders=function(a,b){colNames=a[0].replace(/\n/g,"").split(b);var c={};c["Column Names"]=colNames;c["headerLines"]=a[0]+LF;var d=[];for(var e=1;e<a.length;e++){d.push(a[e].split(b))}if(d.length>1){try{var f=Date.parse(d[0][0]);var g=Date.parse(d[1][0]);var h=1e3/(g-f);c["Sampling Rate"]=h;c["Start Time"]=new Date(f);if(isNaN(c["Sampling Rate"])){throw"Sample rate invalid: "+h}if(isNaN(c["Start Time"])){throw"Invalid Start Time: "+f}console.log("Successfully identified sample rate: "+h+" and start time: "+c["Start Time"].toString())}catch(i){console.log("Treating file as empatica format (first row is starttime, second row is sample rate)");c["Start Time"]=new Date(parseFloat(a[0].split(b)[0])*1e3);c["Sampling Rate"]=parseFloat(a[1].split(b)[0]);var j="Channel";if(self.filename!=undefined){j=self.filename.split(".")[0]}for(var e=0;e<colNames.length;e++){if(colNames.length>1){c["Column Names"][e]=j+"_"+(e+1)}else{c["Column Names"][e]=j}}c["headerLines"]+=a[1]+LF;console.log("Empatica file: Successfully identified sample rate: "+c["Sampling Rate"]+" and start time: "+c["Start Time"].toString())}}self.metadata=a;self.postMessage({cmd:"metadata",data:c});return c};self.parseHeaders=function(a){var b={};var c=[],d;for(var e=0;e<a.length;e++){var f=a[e];if(f.indexOf(": ")>-1){var g=f.split(": ")[0];var h=f.split(": ")[1];if(h!=undefined&&h!=""){b[g]=h.autoconvert()}}else if(f.indexOf("|")>-1){d=f.replace(/^\s*|\s*$/g,"");d=d.split("|");console.log("Column Names: "+d);for(var i=0;i<d.length;i++){d[i]=d[i].replace(/^\s*|\s*$/g,"");switch(d[i]){case"Z-axis":d[i]="Z";break;case"Y-axis":d[i]="Y";break;case"X-axis":d[i]="X";break;case"°Celsius":d[i]="Temperature";break;case"EDA(uS)":d[i]="EDA";break;case"�Celsius":d[i]="Temperature";break;default:if(d[i].indexOf("Celsius")>-1){d[i]="Temperature"}break}if(d[i].toLowerCase()!="events"){c.push(d[i])}}b["Column Names"]=c}}self.metadata=a;self.postMessage({cmd:"metadata",data:b});b["Column Names"]=d;return b};self.SCRs=function(a){var b=a.width||8;var c=signals.peaks(data,b);console.log("Crossings:");console.log(c);self.postMessage({cmd:"scrs",data:c[0]})};self.filter=function(a){var b=a.data;var c=a.width||self.metadata["Sampling Rate"];var d;console.log("Self.Filter: Got data of "+b.length);switch(a.filterType){case"median":d=signals.medianFilter(b,c);break;case"min":d=signals.minFilter(b,c);break;case"max":d=signals.maxFilter(b,c);break;case"gaussian":d=signals.gaussianFilter(b,c);break;default:d=signals.gaussianFilter(b,c);break}self.postMessage({cmd:"filter",data:d})};self.downsample=function(a){console.log("In downsample");var b=signals.sanitize(a.points,[0],[NaN]);var c=a.target;var d=[];var e=Math.ceil(b.length/c);console.log("Data length: "+b.length+" Target: "+c+" so increment is "+e);if(b.length<=c){d=b}else{var b=gaussianFilter(b,int(e),20);for(var f=0;f<b.length;f+=e){d.push(b[f])}}console.log("Downsampled to : "+d.length);self.postMessage({cmd:"downsampled",data:d,key:a.key})};self.downsampleMultiChannel=function(a){console.log("In downsampleMultiChannel");var b=a.target;var c=[];for(var d=0;d<a.points.length;d++){var e=a.points[d];var f=signals.sanitize(e,[0],[NaN]);var g=[];var h=Math.floor(f.length/b);console.log("Data length: "+f.length+" Target: "+b+" so increment is "+h);if(f.length<=b){g=f}else{for(var i=0;i<f.length;i+=h){g.push(f[i])}}c.push(g)}console.log("Downsampled "+a.points.length+" channels to : "+g.length);console.log(c);self.postMessage({cmd:"downsampled",data:c,key:a.key})};self.export=function(a){var b=a.data;var c=a.metadata;var d="";var e=["Z","Y","X","Batt","Temperature","EDA"];var f="";f+="Log File Created by EDA Toolkit - "+(new Date).getYear()+"\r\n";f+="File Version"+": "+1.01+"\r\n";f+="Firmware Version"+": "+c["Firmware Version"]+"\r\n";f+="UUID"+": "+c["UUID"]+"\r\n";f+="Sampling Rate"+": "+c["Sampling Rate"].toFixed(0)+"\r\n";f+="Start Time"+": "+c["Start Time"].toQFormat()+"\r\n";f+="Z-axis | Y-axis | X-axis | Battery | °Celsius | EDA(uS)\r\n";f+="---------------------------------------------------------\r\n";d+=f;for(var g=0;g<b[e[0]].length;g++){try{var h=e.map(function(a){return b[a][g].toFixed(3)}).join(",")+"\r\n";d+=h}catch(i){console.log(i)}}if(a.useBlob==true){var j=new BlobBuilder;j.push(d);self.postMessage({cmd:"export",data:j.getBlob("text/plain;charset=utf-8")})}else{self.postMessage({cmd:"export",data:d})}};self.parseTextData=function(a,b){console.log(b);var c={};for(var d=0;d<b.length;d++){if(b[d].toLowerCase()!="events"){c[b[d]]=[]}}c.markers=[];var e=a.split(LF);a=null;var f=e.length;for(var g=0;g<f;g++){if(g%1e3==0){self.postMessage({cmd:"progress",progress:float(g)/f})}if(e[g].indexOf(",,,,,")>-1){c.markers.push({index:g,comment:"",type:"manual"})}else{var h=e[g].split(",");for(var i=0;i<h.length;i++){var j=h[i];if(j!=undefined&&j!=""&&j.length>0&&j.charCodeAt(0)!=13){if(b[i].toLowerCase()=="events"){c.markers.push({index:g,comment:j,type:"generated"})}else{c[b[i]].push(j.autoconvert())}}}}}self.postMessage({cmd:"data",data:c})};self.parseBinaryData=function(a,b){var c="åâ";var d={};for(var e=0;e<b.length;e++){d[b[e]]=[]}a=a.replace(/^\r\n*/g,"");var f=a.split(c);a=null;d.markers=[];var g=f.length;for(var h=0;h<g;h++){if(h%1e3==0){self.postMessage({cmd:"progress",progress:float(h)/g})}try{var i=f[h];if(i.length!=12){}if(i.length==0){break}var j=unpackStruct(i);if(i.length!=12){console.log(j)}var k=unpackSigned(j[0]);var l=unpackSigned(j[1]);var m=unpackSigned(j[2]);var n=unpackUnsigned(j[3])*10;var o=unpackSigned(j[4]);var p=unpackUnsigned(j[5]);if(p>=999&&m<=-999){d.markers.push({index:h,comment:"",type:"manual"})}else{d[b[0]].push(k);d[b[1]].push(l);d[b[2]].push(m);d[b[3]].push(n);d[b[4]].push(o);d[b[5]].push(p)}}catch(q){console.log("Problem while unpacking binary data: "+q);continue}}self.postMessage({cmd:"data",data:d})};self.get=function(a,b){var c=new XMLHttpRequest;c.responseType="arraybuffer";c.open("GET",a,false);c.send();var d=new Uint8Array(c.response);var e=d.length;var f=new Array(e);while(e--){f[e]=String.fromCharCode(d[e])}self.parse(f.join(""))};