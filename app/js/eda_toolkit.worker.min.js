/**
* EDA Toolkit
* Copyright 2013 Oliver Wilder-Smith 
* http://www.apache.org/licenses/LICENSE-2.0
*/
function testBit(a,b){var c=1<<b;return a&c}function truncate(a,b){var b=b||0;return Math.trunc(a*pow(10,b))/float(pow(10,b),b)}function unpackStruct(a){for(var b=[],c=0;c<a.length;c+=2){var d=a.charCodeAt(c),e=a.charCodeAt(c+1),f=256*d+e;b.push(f)}return b}function unpackSigned(a){var b=testBit(a,15)>0,c=3&a>>13,d=float(1023&a)/1e3;return b?truncate(round(-1*d*pow(10,c),3-c),3-c):truncate(round(d*pow(10,c),3-c),3-c)}function unpackUnsigned(a){var b=3&a>>14,c=float(16383&a)/1e4;return truncate(round(c*pow(10,b),4-b),4-b)}var e=Math.E,pi=Math.PI,np={},MU="μ";urlParams=function(){for(var a=location.search.substring(1).split("&"),b={},c={"true":!0,"false":!1,"null":null},d=0,e=a.length;e>d;d++){var f=a[d],g=f.indexOf("="),h=-1==g?f:f.substring(0,g),i=-1==g?!0:f.substring(g+1);i in c?i=c[i]:""+parseFloat(i,10)==i&&(i=parseFloat(i,10)),b[h]=i}return a=c=null,function(a){return a in b?b[a]:null}}(),float=function(a){return 1*a},int=function(a){return parseInt(a,10)},pow=function(a,b){return Math.pow(a,b)},round=function(a,b){var b=b||0;return a.toFixed(b)},String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)};var log=function(a){window.console&&console.log(a)},toast=function(a){var b=document.createElement("div");b.className="toast alert alert-info",b.innerHTML=a,b.style.position="absolute",b.style.display="block",b.style.width="30%",b.style.left="50%",b.style.top="50%",b.style["margin-left"]="-15%",b.style["margin-top"]="0px",document.getElementsByTagName("body")[0].appendChild(b),$(".toast").fadeOut(0),$(".toast").fadeIn(500),setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(a,b){return a.toFixed(b)},Number.prototype.pad=function(a){for(var b=""+this,c=b.length-a,d=0;c>d;d++)b="0"+b;return b},Date.prototype.toQFormat=function(){var a="";return a+=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate(),a+=" ",a+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2),a+=" ",a+="Offset:"+(this.getTimezoneOffset()>0?"+"+this.getTimezoneOffset():this.getTimezoneOffset())},parseDate=function(a){var b=a.split(" ")[0],c=a.split(" ")[1];float(a.split(" ")[2].split(":")[1]);var d=int(b.split("-")[0]),e=int(b.split("-")[1]-1),f=int(b.split("-")[2]),g=int(c.split(":")[0]),h=int(c.split(":")[1]),i=int(c.split(":")[2]);return new Date(d,e,f,g,h,i,0)};var TimeDelta=function(a){var b={};return a.isPrototypeOf(Object)?(b.days=a.days||0,b.hours=a.hours||0,b.minutes=a.minutes||0,b.seconds=a.seconds||0,b.milliseconds=a.milliseconds||0):(b.days=Math.floor(a/864e5),b.hours=Math.floor(a%864e5/36e5),b.minutes=Math.floor(a%36e5/6e4),b.seconds=Math.floor(a%6e4/1e3),b.milliseconds=Math.floor(a%1e3)),b.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)},b.valueOf=function(){var a=0;return a+=864e5*this.days,a+=36e5*this.hours,a+=6e4*this.minutes,a+=1e3*this.seconds,a+=this.milliseconds},b};Date.prototype.sub=function(a){var b=this.valueOf()-a.valueOf();return TimeDelta(b)},Date.prototype.add=function(a){return new Date(this.valueOf()+TimeDelta(a).valueOf())},Date.prototype.addMilliseconds=function(a){var b=new Date(this.valueOf()+a);return b},Date.prototype.addSeconds=function(a){return this.addMilliseconds(1e3*a)},Date.prototype.addMinutes=function(a){return this.addSeconds(60*a)},Date.prototype.addHours=function(a){return this.addMinutes(60*a)},Date.prototype.addDays=function(a){return this.addHours(24*a)},Date.prototype.getMinutesSinceMidnight=function(){var a=new Date(this.toString());a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);var b=(a.valueOf()-this.valueOf())/6e4;return b},Date.prototype.shortString=function(){return this.toLocaleTimeString()},String.prototype.contains=function(a){return this.indexOf(a)>-1},String.prototype.isnum=function(){try{return parseFloat(this.toString()),!0}catch(a){return!1}},String.prototype.isdate=function(){try{var a=new Date(this.toString());return a.valueOf().isNaN()?!1:!0}catch(b){return!1}},String.prototype.autoconvert=function(){try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());return 0/0!=b?b:this.toString()}catch(a){return this.toString()}},guess=function(a){return"string"!=typeof a?typeof a:a.isdate()?"date":a.isnum()?a.toString().contains(".")||a.toString().contains(",")?"float":"int":"unknown"},autoformat=function(a){var b=guess(a);switch(b){case"float":return float(a);case"int":return int(a);case"date":return new Date(a);default:return a}},gaussian=function(a,b){var c=Math.sqrt(b),d=1/(c*Math.sqrt(2*pi)),f=0,g=-1*(Math.pow(a-f,2)/(2*c*c)),h=d*Math.pow(e,g);return h},gaussianKernel=function(a,b){for(var c=new Array,d=-1*b/2;b/2>d;d++)c.push(gaussian(d,a));return c},gaussianFilter=function(a,b,c){var d=new Array;void 0==c&&(c=100);for(var e=0;e<a.length;e++){var f=0>e-c/2?0:e-c/2,g=e+c/2>=a.length?a.length-1:e+c/2,h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d},np.timeRange=function(a,b,c){for(var d=b-a,e=Math.floor(float(d)/c),f=new Array,g=0;c>g;g++)f.push(a.addMilliseconds(e*g));return f},np.arange=function(a,b,c){void 0==c&&(c=1);for(var d=new Array,e=a;b>e;e+=c)d.push(e);return d},np.round=function(a,b){var c=a%b;return a=c>b/2?(Math.round(a/b)+1)*b:Math.round(a/b)*b},np.map=function(a,b){for(var c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},np.max=function(a){for(var b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},np.min=function(a){for(var b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},convolve=function(a,b){var c=new Array;if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)c.push(a[d]*b[d]);return c},np.sum=function(a){for(var b=0,c=0;c<a.length;c++)a[c].isNaN()||(b+=a[c]);return b},Array.prototype.max=function(){for(var a=this,b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},Array.prototype.min=function(){for(var a=this,b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},Array.prototype.find=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)b[d]==a&&c.push(d);return c},Array.prototype.map=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},Array.prototype.max=function(){for(var a=this,b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},Array.prototype.min=function(){for(var a=this,b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},Array.prototype.map=function(a){for(var b=this,c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},float=function(a){return 1*a},int=function(a){return parseInt(a,10)},Array.prototype.clone=function(){for(var a=this,b=new Array,c=0;c<a.length;c++)b.push(a[c]);return b},gaussian=function(a,b){var c=Math.sqrt(b),d=1/(c*Math.sqrt(2*pi)),f=0,g=-1*(Math.pow(a-f,2)/(2*c*c)),h=d*Math.pow(e,g);return h},gaussianKernel=function(a,b){for(var c=new Array,d=-1*b/2;b/2>d;d++)c.push(gaussian(d,a));return c},String.prototype.autoconvert=function(){try{return parseDate(this.toString())}catch(a){}try{var b=parseFloat(this.toString());return 0/0!=b?b:this.toString()}catch(a){return this.toString()}},gaussianFilter=function(a,b,c){var d=new Array;void 0==c&&(c=100);for(var e=0;e<a.length;e++){var f=0>e-c/2?0:e-c/2,g=e+c/2>=a.length?a.length-1:e+c/2,h=gaussianKernel(b,g-f);d.push(np.sum(convolve(h,a.slice(f,g))))}return d};var np=np||{};np.arange=function(a,b,c){void 0==c&&(c=1);for(var d=new Array,e=a;b>e;e+=c)d.push(e);return d},np.round=function(a,b){var c=a%b;return a=c>b/2?(Math.round(a/b)+1)*b:Math.round(a/b)*b},np.map=function(a,b){for(var c=new Array,d=0;d<b.length;d++)c.push(a(b[d]));return c},np.max=function(a){for(var b=-1/0,c=0;c<a.length;c++)a[c]>b&&(b=a[c]);return b},np.min=function(a){for(var b=1/0,c=0;c<a.length;c++)a[c]<b&&(b=a[c]);return b},convolve=function(a,b){var c=new Array;if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)c.push(a[d]*b[d]);return c},np.sum=function(a){for(var b=0,c=0;c<a.length;c++)a[c].isNaN||(b+=a[c]);return b},np.mean=function(a){return np.sum(a)/(1*a.length)},np.average=np.mean,np.avg=np.mean,np.median=function(a){var b=a.clone();b.sort();var c=int(Math.ceil(a.length/2))-1;return 0==a.length%2?np.mean(b.slice(c,-c)):b[c]};var signals=signals||{};signals.sanitize=function(a,b,c){for(var b=b||[0],c=c||[0/0],d=0;d<a.length;d++)for(var e=0;e<c.length;e++)"-"==c[e]?a[d]<0&&(a[d]=b[e]):a[d]==c[e]&&(a[d]=b[e]);return a},signals.gaussianFilter=function(a,b){return gaussianFilter(a,b,10)},signals.medianFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.median(a.slice(e,f)))}return c},signals.maxFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.max(a.slice(e,f)))}return c},signals.minFilter=function(a,b){for(var b=b||3,c=new Array,d=0;d<a.length;d++){var e=0>d-b/2?0:d-b/2,f=d+b/2>=a.length?a.length-1:d+b/2;c.push(np.min(a.slice(e,f)))}return c},signals.diff=function(a){for(var b=new Array,c=0;c<a.length-1;c++)b.push(a[c+1]-a[c]);return b},signals.where=function(a,b){for(var c=new Array,d=0;d<a.length;d++)b(a[d])&&c.push(d);return c},signals.zeroCrossings=function(a){for(var b=new Array,c=1;c<a.length;c++)b[c]=a[c-1]<0&&a[c]>0?1:a[c-1]>0&&a[c]<0?-1:0;return b},signals.peaks=function(a){var b=new Array;signals.diff(a),signals.zeroCrossings(a);var c=signals.where(b,function(a){return a>0}),d=signals.where(b,function(a){return 0>a});return[c,d]};var separator="---------------------------------------------------------\r\n",console={};console.log=function(a){self.postMessage({cmd:"console",msg:a})},self.addEventListener("message",function(a){var b=a.data;switch(b.cmd){case"load":self.get(b.url,self.parse);break;case"loadText":self.parse(b.data);break;case"downsample":self.downsample(b.data);break;case"downsampleMultiChannel":self.downsampleMultiChannel(b.data);break;case"scrs":self.SCRs(b.data);break;case"export":self.export(b.data);break;case"filter":self.filter(b.data);break;case"stop":self.postMessage("WORKER STOPPED: "+b.msg+". (buttons will no longer work)"),self.close();break;default:self.postMessage("Unknown command: "+b.msg)}},!1),self.parse=function(a){var b=a.toString().split(separator),c=b[0].split("\n"),d=self.parseHeaders(c);d["File Version"]<1.1?self.parseTextData(b[1],["Z","Y","X","Battery","Temperature","EDA"]):d["File Version"]<1.5&&d["File Version"]>1.09?self.parseTextData(b[1],d["Column Names"]):self.parseBinaryData(b[1],["Z","Y","X","Battery","Temperature","EDA"])},self.parseHeaders=function(a){for(var b,c={},d=[],e=0;e<a.length;e++){var f=a[e];if(f.indexOf(": ")>-1){var g=f.split(": ")[0],h=f.split(": ")[1];void 0!=h&&""!=h&&(c[g]=h.autoconvert())}else if(f.indexOf("|")>-1){b=f.replace(/^\s*|\s*$/g,""),b=b.split("|"),console.log("Column Names: "+b);for(var i=0;i<b.length;i++){switch(b[i]=b[i].replace(/^\s*|\s*$/g,""),b[i]){case"Z-axis":b[i]="Z";break;case"Y-axis":b[i]="Y";break;case"X-axis":b[i]="X";break;case"°Celsius":b[i]="Temperature";break;case"EDA(uS)":b[i]="EDA";break;case"�Celsius":b[i]="Temperature";break;default:b[i].indexOf("Celsius")>-1&&(b[i]="Temperature")}"events"!=b[i].toLowerCase()&&d.push(b[i])}c["Column Names"]=d}}return self.metadata=a,self.postMessage({cmd:"metadata",data:c}),c["Column Names"]=b,c},self.SCRs=function(a){var b=a.width||8,c=signals.peaks(data,b);console.log("Crossings:"),console.log(c),self.postMessage({cmd:"scrs",data:c[0]})},self.filter=function(a){var b,c=a.data,d=a.width||self.metadata["Sampling Rate"];switch(console.log("Self.Filter: Got data of "+c.length),a.filterType){case"median":b=signals.medianFilter(c,d);break;case"min":b=signals.minFilter(c,d);break;case"max":b=signals.maxFilter(c,d);break;case"gaussian":b=signals.gaussianFilter(c,d);break;default:b=signals.gaussianFilter(c,d)}self.postMessage({cmd:"filter",data:b})},self.downsample=function(a){console.log("In downsample");var b=signals.sanitize(a.points,[0],[0/0]),c=a.target,d=[],e=Math.ceil(b.length/c);if(console.log("Data length: "+b.length+" Target: "+c+" so increment is "+e),b.length<=c)d=b;else for(var b=gaussianFilter(b,int(e),20),f=0;f<b.length;f+=e)d.push(b[f]);console.log("Downsampled to : "+d.length),self.postMessage({cmd:"downsampled",data:d,key:a.key})},self.downsampleMultiChannel=function(a){console.log("In downsampleMultiChannel");for(var b=a.target,c=[],d=0;d<a.points.length;d++){var e=a.points[d],f=signals.sanitize(e,[0],[0/0]),g=[],h=Math.floor(f.length/b);if(console.log("Data length: "+f.length+" Target: "+b+" so increment is "+h),f.length<=b)g=f;else for(var i=0;i<f.length;i+=h)g.push(f[i]);c.push(g)}console.log("Downsampled "+a.points.length+" channels to : "+g.length),console.log(c),self.postMessage({cmd:"downsampled",data:c,key:a.key})},self.export=function(a){var b=a.data,c=a.metadata,d="",e=["Z","Y","X","Batt","Temperature","EDA"],f="";f+="Log File Created by EDA Toolkit - 2012\r\n",f+="File Version: 1.01\r\n",f+="Firmware Version: "+c["Firmware Version"]+"\r\n",f+="UUID: "+c.UUID+"\r\n",f+="Sampling Rate: "+c["Sampling Rate"].toFixed(0)+"\r\n",f+="Start Time: "+c["Start Time"].toQFormat()+"\r\n",f+="Z-axis | Y-axis | X-axis | Battery | °Celsius | EDA(uS)\r\n",f+="---------------------------------------------------------\r\n",d+=f;for(var g=0;g<b[e[0]].length;g++)try{var h=e.map(function(a){return b[a][g].toFixed(3)}).join(",")+"\r\n";d+=h}catch(i){console.log(i)}if(1==a.useBlob){var j=new BlobBuilder;j.append(d),self.postMessage({cmd:"export",data:j.getBlob("text/plain;charset=utf-8")})}else self.postMessage({cmd:"export",data:d})},self.parseTextData=function(a,b){console.log(b);for(var c={},d=0;d<b.length;d++)"events"!=b[d].toLowerCase()&&(c[b[d]]=[]);c.markers=[];for(var e=a.split("\n"),f=e.length,g=0;f>g;g++)if(0==g%1e3&&self.postMessage({cmd:"progress",progress:float(g)/f}),e[g].indexOf(",,,,,")>-1)c.markers.push({index:g,comment:"",type:"manual"});else for(var h=e[g].split(","),i=0;i<h.length;i++){var j=h[i];void 0!=j&&""!=j&&j.length>0&&13!=j.charCodeAt(0)&&("events"==b[i].toLowerCase()?(console.log("Value: "+j+" | value.length="+j.length+" | value.charCode="+j.charCodeAt(0)),c.markers.push({index:g,comment:j,type:"generated"})):c[b[i]].push(j.autoconvert()))}self.postMessage({cmd:"data",data:c})},self.parseBinaryData=function(a,b){for(var c="åâ",d={},e=0;e<b.length;e++)d[b[e]]=[];a=a.replace(/^\r\n*/g,"");var f=a.split(c);d.markers=[];for(var g=f.length,h=0;g>h;h++){0==h%1e3&&self.postMessage({cmd:"progress",progress:float(h)/g});try{var i=f[h];if(12!=i.length&&(console.log(i),console.log("Line length: "+i.length+" at index: "+h+" of "+g)),0==i.length){console.log("> Encountered a blank line at #"+index+" of (headless) binData - this is most likely EOF");break}var j=unpackStruct(i);12!=i.length&&console.log(j);var k=unpackSigned(j[0]),l=unpackSigned(j[1]),m=unpackSigned(j[2]),n=10*unpackUnsigned(j[3]),o=unpackSigned(j[4]),p=unpackUnsigned(j[5]);p>=999&&-999>=m?d.markers.push({index:h,comment:"",type:"manual"}):(d[b[0]].push(k),d[b[1]].push(l),d[b[2]].push(m),d[b[3]].push(n),d[b[4]].push(o),d[b[5]].push(p))}catch(q){console.log("Problem while unpacking binary data: "+q);continue}}self.postMessage({cmd:"data",data:d})},self.get=function(a){var b=new XMLHttpRequest;b.responseType="arraybuffer",b.open("GET",a,!1),b.send();for(var c=new Uint8Array(b.response),d=c.length,e=new Array(d);d--;)e[d]=String.fromCharCode(c[d]);var f=e.join("");self.parse(f),console.log(f)};