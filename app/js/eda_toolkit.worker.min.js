/**
* EDA Toolkit
* Copyright 2016 Oliver Wilder-Smith 
*/

var e=Math.E;var pi=Math.PI;var np={};var MU="μ";urlParams=function(){var e=location.search.substring(1).split("&");var t={};var r={true:true,false:false,null:null};for(var a=0,n=e.length;a<n;a++){var s=e[a];var i=s.indexOf("=");var o=i==-1?s:s.substring(0,i);var l=i==-1?true:s.substring(i+1);if(l in r){l=r[l]}else if(""+parseFloat(l,10)==l){l=parseFloat(l,10)}t[o]=l}e=r=null;return function e(r){return r in t?t[r]:null}}();float=function(e){return e*1};int=function(e){return parseInt(e,10)};pow=function(e,r){return Math.pow(e,r)};round=function(e,r){var r=r||0;return e.toFixed(r)};String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var log=function(e){if(window.console){console.log(e)}};var toast=function(e){var r=document.createElement("div");r.className="toast alert alert-info";r.innerHTML=e;r.style.position="absolute";r.style.display="block";r.style.width="30%";r.style.left="50%";r.style.top="50%";r.style["margin-left"]="-15%";r.style["margin-top"]="0px";document.getElementsByTagName("body")[0].appendChild(r);$(".toast").fadeOut(0);$(".toast").fadeIn(500);setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(e,r){return e.toFixed(r)};function testBit(e,r){var t=1<<r;return e&t}function truncate(e,r){var r=r||0;return Math.trunc(e*pow(10,r))/float(pow(10,r),r)}function unpackStruct(e){var r=[];for(var t=0;t<e.length;t+=2){var a=e.charCodeAt(t);var n=e.charCodeAt(t+1);var s=a*256+n;r.push(s)}return r}function unpackSigned(e){var r=testBit(e,15)>0;var t=e>>13&3;var a=float(e&1023)/1e3;if(r)return truncate(round(-1*a*pow(10,t),3-t),3-t);else return truncate(round(a*pow(10,t),3-t),3-t)}function unpackUnsigned(e){var r=e>>14&3;var t=float(e&16383)/1e4;return truncate(round(t*pow(10,r),4-r),4-r)}Number.prototype.pad=function(e){var r=""+this;var t=e-r.length;for(var a=0;a<t;a++){r="0"+r}return r};String.prototype.pad=function(e){var r=""+this;var t=e-r.length;for(var a=0;a<t;a++){r="0"+r}return r};Date.prototype.toQFormat=function(){var e="";e+=this.getFullYear()+"-"+(this.getMonth()+1).pad(2)+"-"+this.getDate().pad(2);e+=" ";e+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2);e+=" ";e+="Offset:"+(this.getTimezoneOffset()>0?"+"+(this.getTimezoneOffset()/60).pad(2):(this.getTimezoneOffset()/60).pad(2));return e};Array.prototype.isValid=function(){var e=this;return e.filter(function(e){return!isNaN(e)}).length==e.length};parseDate=function(e){var r=e.split(" ")[0];var t=e.split(" ")[1];var a=float(e.split(" ")[2].split(":")[1]);var n=int(r.split("-")[0]);var s=int(r.split("-")[1]-1);var i=int(r.split("-")[2]);var o=int(t.split(":")[0]);var l=int(t.split(":")[1]);var u=int(t.split(":")[2]);return new Date(n,s,i,o,l,u,0)};var TimeDelta=function(e){var r={};if(!e.isPrototypeOf(Object)){r.days=Math.floor(e/(1e3*60*60*24));r.hours=Math.floor(e%(1e3*60*60*24)/(1e3*60*60));r.minutes=Math.floor(e%(1e3*60*60)/(1e3*60));r.seconds=Math.floor(e%(1e3*60)/1e3);r.milliseconds=Math.floor(e%1e3)}else{r.days=e.days||0;r.hours=e.hours||0;r.minutes=e.minutes||0;r.seconds=e.seconds||0;r.milliseconds=e.milliseconds||0}r.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)};r.valueOf=function(){var e=0;e+=1e3*60*60*24*this.days;e+=1e3*60*60*this.hours;e+=1e3*60*this.minutes;e+=1e3*this.seconds;e+=this.milliseconds;return e};return r};Date.prototype.sub=function(e){var r=this.valueOf()-e.valueOf();return TimeDelta(r)};Date.prototype.add=function(e){return new Date(this.valueOf()+TimeDelta(e).valueOf())};Date.prototype.addMilliseconds=function(e){var r=new Date(this.valueOf()+e);return r};Date.prototype.addSeconds=function(e){return this.addMilliseconds(e*1e3)};Date.prototype.addMinutes=function(e){return this.addSeconds(60*e)};Date.prototype.addHours=function(e){return this.addMinutes(60*e)};Date.prototype.addDays=function(e){return this.addHours(24*e)};Date.prototype.getMinutesSinceMidnight=function(){var e=new Date(this.toString());e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);var r=(e.valueOf()-this.valueOf())/(60*1e3);return r};Date.prototype.shortString=function(e){if(e){return this.toLocaleDateString()+" "+this.toLocaleTimeString()}else{return this.toLocaleTimeString()}};String.prototype.contains=function(e){return this.indexOf(e)>-1};String.prototype.isnum=function(){try{var e=parseFloat(this.toString());return true}catch(e){return false}};String.prototype.isdate=function(){try{var e=new Date(this.toString());if(!e.valueOf().isNaN()){return true}else{return false}}catch(e){return false}};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(e){}try{if(this.toString().indexOf(":")>0){var e=Date.parse(this.toString());if(!isNaN(e)){console.log("Parsed '"+this.toString()+"' to "+new Date(e).toString());return new Date(e)}}}catch(e){console.log(e)}try{var r=parseFloat(this.toString());if(!isNaN(r)){return r}else{return this.toString()}}catch(e){return this.toString()}}};guess=function(e){if(typeof e!="string"){return typeof e}else if(e.isdate()){return"date"}else if(e.isnum()){if(e.toString().contains(".")||e.toString().contains(",")){return"float"}else{return"int"}}else{return"unknown"}};autoformat=function(e){var r=guess(e);switch(r){case"float":return float(e);break;case"int":return int(e);break;case"date":return new Date(e);break;default:return e;break}};gaussian=function(r,t){var a=Math.sqrt(t);var n=1/(a*Math.sqrt(2*pi));var s=0;var i=-1*(Math.pow(r-s,2)/(2*a*a));var o=n*Math.pow(e,i);return o};gaussianKernel=function(e,r){var t=new Array;for(var a=-1*r/2;a<r/2;a++){t.push(gaussian(a,e))}return t};gaussianFilter=function(e,r,t){var a=new Array;if(t==undefined){t=100}for(var n=0;n<e.length;n++){var s=n-t/2<0?0:n-t/2;var i=n+t/2>=e.length?e.length-1:n+t/2;var o=gaussianKernel(r,i-s);a.push(np.sum(convolve(o,e.slice(s,i))))}return a};np.timeRange=function(e,r,t){var a=r-e;var n=Math.floor(float(a)/t);var s=new Array;for(var i=0;i<t;i++){s.push(e.addMilliseconds(n*i))}return s};np.arange=function(e,r,t){if(t==undefined){t=1}var a=new Array;for(var n=e;n<r;n+=t){a.push(n)}return a};np.round=function(e,r){var t=e%r;if(t>r/2){e=(Math.round(e/r)+1)*r}else{e=Math.round(e/r)*r}return e};np.map=function(e,r){var t=new Array;for(var a=0;a<r.length;a++){t.push(e(r[a]))}return t};np.max=function(e){var r=-Infinity;for(var t=0;t<e.length;t++){if(e[t]>r){r=e[t]}}return r};np.min=function(e){var r=Infinity;for(var t=0;t<e.length;t++){if(e[t]<r){r=e[t]}}return r};convolve=function(e,r){var t=new Array;if(e.length!=r.length){return false}else{for(var a=0;a<e.length;a++){t.push(e[a]*r[a])}return t}};np.sum=function(e){var r=0;for(var t=0;t<e.length;t++){if(!e[t].isNaN()){r+=e[t]}}return r};Array.prototype.max=function(){var e=this.filter(function(e){return!isNaN(e)});var r=-Infinity;for(var t=0;t<e.length;t++){if(e[t]>r){r=e[t]}}return r};Array.prototype.min=function(){var e=this.filter(function(e){return!isNaN(e)});var r=Infinity;for(var t=0;t<e.length;t++){if(e[t]<r){r=e[t]}}return r};Array.prototype.find=function(e){var r=this;var t=new Array;for(var a=0;a<r.length;a++){if(r[a]==e){t.push(a)}}return t};Array.prototype.map=function(e){var r=this;var t=new Array;for(var a=0;a<r.length;a++){t.push(e(r[a]))}return t};Array.prototype.max=function(){var e=this;var r=-Infinity;for(var t=0;t<e.length;t++){if(e[t]>r){r=e[t]}}return r};Array.prototype.min=function(){var e=this;var r=Infinity;for(var t=0;t<e.length;t++){if(e[t]<r){r=e[t]}}return r};Array.prototype.map=function(e){var r=this;var t=new Array;for(var a=0;a<r.length;a++){t.push(e(r[a]))}return t};float=function(e){return e*1};int=function(e){return parseInt(e,10)};Array.prototype.clone=function(){var e=this;var r=new Array;for(var t=0;t<e.length;t++){r.push(e[t])}return r};gaussian=function(r,t){var a=Math.sqrt(t);var n=1/(a*Math.sqrt(2*pi));var s=0;var i=-1*(Math.pow(r-s,2)/(2*a*a));var o=n*Math.pow(e,i);return o};gaussianKernel=function(e,r){var t=new Array;for(var a=-1*r/2;a<r/2;a++){t.push(gaussian(a,e))}return t};gaussianFilter=function(e,r,t){var a=new Array;if(t==undefined){t=100}for(var n=0;n<e.length;n++){var s=n-t/2<0?0:n-t/2;var i=n+t/2>=e.length?e.length-1:n+t/2;var o=gaussianKernel(r,i-s);a.push(np.sum(convolve(o,e.slice(s,i))))}return a};var np=np||{};np.arange=function(e,r,t){if(t==undefined){t=1}var a=new Array;for(var n=e;n<r;n+=t){a.push(n)}return a};np.round=function(e,r){var t=e%r;if(t>r/2){e=(Math.round(e/r)+1)*r}else{e=Math.round(e/r)*r}return e};np.map=function(e,r){var t=new Array;for(var a=0;a<r.length;a++){t.push(e(r[a]))}return t};np.max=function(e){var r=-Infinity;for(var t=0;t<e.length;t++){if(e[t]>r){r=e[t]}}return r};np.min=function(e){var r=Infinity;for(var t=0;t<e.length;t++){if(e[t]<r){r=e[t]}}return r};convolve=function(e,r){var t=new Array;if(e.length!=r.length){return false}else{for(var a=0;a<e.length;a++){t.push(e[a]*r[a])}return t}};np.sum=function(e){var r=0;for(var t=0;t<e.length;t++){if(!e[t].isNaN){r+=e[t]}}return r};np.mean=function(e){return np.sum(e)/(1*e.length)};np.average=np.mean;np.avg=np.mean;np.median=function(e){var r=e.clone();r.sort();var t=int(Math.ceil(e.length/2))-1;if(e.length%2==0){return np.mean(r.slice(t,-t))}else{return r[t]}};var signals=signals||{};signals.sanitize=function(e,r,t){var r=r||[0];var t=t||[NaN];for(var a=0;a<e.length;a++){for(var n=0;n<t.length;n++){if(t[n]=="-"){if(e[a]<0){e[a]=r[n]}}else if(e[a]==t[n]){e[a]=r[n]}}}return e};signals.gaussianFilter=function(e,r){return gaussianFilter(e,r,10)};signals.medianFilter=function(e,r){var r=r||3;var t=new Array;for(var a=0;a<e.length;a++){var n=a-r/2<0?0:a-r/2;var s=a+r/2>=e.length?e.length-1:a+r/2;t.push(np.median(e.slice(n,s)))}return t};signals.maxFilter=function(e,r){var r=r||3;var t=new Array;for(var a=0;a<e.length;a++){var n=a-r/2<0?0:a-r/2;var s=a+r/2>=e.length?e.length-1:a+r/2;t.push(np.max(e.slice(n,s)))}return t};signals.minFilter=function(e,r){var r=r||3;var t=new Array;for(var a=0;a<e.length;a++){var n=a-r/2<0?0:a-r/2;var s=a+r/2>=e.length?e.length-1:a+r/2;t.push(np.min(e.slice(n,s)))}return t};signals.diff=function(e){var r=new Array;for(var t=0;t<e.length-1;t++){r.push(e[t+1]-e[t])}return r};signals.where=function(e,r){var t=new Array;for(var a=0;a<e.length;a++){if(r(e[a])){t.push(a)}}return t};signals.zeroCrossings=function(e){var r=new Array;for(var t=1;t<e.length;t++){if(e[t-1]<0&&e[t]>0){r[t]=1}else if(e[t-1]>0&&e[t]<0){r[t]=-1}else{r[t]=0}}return r};signals.peaks=function(e,r){var t=new Array;var a=signals.diff(e);var n=signals.zeroCrossings(e);var s=signals.where(t,function(e){return e>0});var i=signals.where(t,function(e){return e<0});return[s,i]};var separator="---------------------------------------------------------\r\n";var LF="\r\n";var console={};console.log=function(e){self.postMessage({cmd:"console",msg:e})};self.addEventListener("message",function(e){var r=e.data;switch(r.cmd){case"load":if(r.filename!=undefined)self.filename=r.filename;self.get(r.url,self.parse);break;case"loadText":if(r.filename!=undefined)self.filename=r.filename;self.parse(r.data);break;case"downsample":self.downsample(r.data);break;case"downsampleMultiChannel":self.downsampleMultiChannel(r.data);break;case"scrs":self.SCRs(r.data);break;case"export":self.export(r.data);break;case"filter":self.filter(r.data);break;case"stop":self.postMessage("WORKER STOPPED: "+r.msg+". (buttons will no longer work)");self.close();break;default:self.postMessage("Unknown command: "+r.msg)}},false);self.parse=function(e){e=e.toString();if(!e.contains(LF)){LF="\n"}var r=self.detectFormat(e);switch(r){case"edafile":var t=e.split(separator);var a=t[0].split(LF);var n=self.parseHeaders(a);e=null;if(n["File Version"]<1.1){self.parseTextData(t[1],["Z","Y","X","Battery","Temperature","EDA"])}else if(n["File Version"]<1.5&&n["File Version"]>1.09){self.parseTextData(t[1],n["Column Names"])}else{self.parseBinaryData(t[1],["Z","Y","X","Battery","Temperature","EDA"])}break;case"csv":var t=e.split(LF);var a=t.slice(0,4);console.log("Headers: "+a.join("|"));var n=self.parseDSVHeaders(a,",");console.log("Parsed Headers: "+n["Column Names"].join(","));var s=e.replace(n["headerLines"],"");e=null;self.parseTextData(s,n["Column Names"]);break;case"tsv":var t=e.split(LF);var a=t.slice(0,4);console.log("Headers: "+a.join("|"));var s=e.toString().replace(a[0]+LF,"");var n=self.parseDSVHeaders(a,"\t");console.log("Parsed Headers: "+n["Column Names"].join("\t"));e=null;self.parseTextData(s,n["Column Names"]);break;default:var t=e.toString().split(LF);var a=t.slice(0,4);var s=e.toString().replace(a[0]+LF,"");e=null;var n=self.parseDSVHeaders(a,",");self.parseTextData(s,n["Column Names"]);break}};self.detectFormat=function(e){if(e.indexOf("\n")==-1){LF="\r"}if(e.indexOf(separator)>-1){LF="\r\n";return"edafile"}else if(e.indexOf("\t")>-1&&!(e.indexOf(",")>-1)){return"tsv"}else{return"csv"}};self.parseDSVHeaders=function(r,t){colNames=r[0].replace(/\n/g,"").split(t);var a={};a["Column Names"]=colNames;a["headerLines"]=r[0]+LF;var e=[];for(var n=1;n<r.length;n++){e.push(r[n].split(t))}if(e.length>1){try{var s=Date.parse(e[0][0]);var i=Date.parse(e[1][0]);var o=1e3/(i-s);a["Sampling Rate"]=o;a["Start Time"]=new Date(s);if(isNaN(a["Sampling Rate"])){s=new Date(parseInt(e[0][0]));i=new Date(parseInt(e[1][0]));o=1e3/(i-s);if(isNaN(a["Sampling Rate"])){throw"Sample rate invalid: "+o}}if(isNaN(a["Start Time"])){throw"Invalid Start Time: "+s}console.log("Successfully identified sample rate: "+o+" and start time: "+a["Start Time"].toString())}catch(e){console.log("Treating file as empatica format (first row is starttime, second row is sample rate)");a["Start Time"]=new Date(parseFloat(r[0].split(t)[0])*1e3);a["Sampling Rate"]=parseFloat(r[1].split(t)[0]);var l="Channel";if(self.filename!=undefined){l=self.filename.split(".")[0]}for(var n=0;n<colNames.length;n++){if(colNames.length>1){a["Column Names"][n]=l+"_"+(n+1)}else{a["Column Names"][n]=l}}a["headerLines"]+=r[1]+LF;console.log("Empatica file: Successfully identified sample rate: "+a["Sampling Rate"]+" and start time: "+a["Start Time"].toString())}}self.metadata=r;self.postMessage({cmd:"metadata",data:a});return a};self.parseHeaders=function(e){var r={};var t=[],a;for(var n=0;n<e.length;n++){var s=e[n];if(s.indexOf(": ")>-1){var i=s.split(": ")[0];var o=s.split(": ")[1];if(o!=undefined&&o!=""){r[i]=o.autoconvert()}}else if(s.indexOf("|")>-1){a=s.replace(/^\s*|\s*$/g,"");a=a.split("|");console.log("Column Names: "+a);for(var l=0;l<a.length;l++){a[l]=a[l].replace(/^\s*|\s*$/g,"");switch(a[l]){case"Z-axis":a[l]="Z";break;case"Y-axis":a[l]="Y";break;case"X-axis":a[l]="X";break;case"°Celsius":a[l]="Temperature";break;case"EDA(uS)":a[l]="EDA";break;case"�Celsius":a[l]="Temperature";break;default:if(a[l].indexOf("Celsius")>-1){a[l]="Temperature"}break}if(a[l].toLowerCase()!="events"){t.push(a[l])}}r["Column Names"]=t}}self.metadata=e;self.postMessage({cmd:"metadata",data:r});r["Column Names"]=a;return r};self.SCRs=function(e){var r=e.width||8;var t=signals.peaks(data,r);console.log("Crossings:");console.log(t);self.postMessage({cmd:"scrs",data:t[0]})};self.filter=function(e){var r=e.data;var t=e.width||self.metadata["Sampling Rate"];var a;console.log("Self.Filter: Got data of "+r.length);switch(e.filterType){case"median":a=signals.medianFilter(r,t);break;case"min":a=signals.minFilter(r,t);break;case"max":a=signals.maxFilter(r,t);break;case"gaussian":a=signals.gaussianFilter(r,t);break;default:a=signals.gaussianFilter(r,t);break}self.postMessage({cmd:"filter",data:a})};self.downsample=function(e){console.log("In downsample");var r=signals.sanitize(e.points,[0],[NaN]);var t=e.target;var a=[];var n=Math.ceil(r.length/t);console.log("Data length: "+r.length+" Target: "+t+" so increment is "+n);if(r.length<=t){a=r}else{var r=gaussianFilter(r,int(n),20);for(var s=0;s<r.length;s+=n){a.push(r[s])}}console.log("Downsampled to : "+a.length);self.postMessage({cmd:"downsampled",data:a,key:e.key})};self.downsampleMultiChannel=function(e){console.log("In downsampleMultiChannel");var r=e.target;var t=[];for(var a=0;a<e.points.length;a++){var n=e.points[a];var s=signals.sanitize(n,[0],[NaN]);var i=[];var o=Math.floor(s.length/r);console.log("Data length: "+s.length+" Target: "+r+" so increment is "+o);if(s.length<=r){i=s}else{for(var l=0;l<s.length;l+=o){i.push(s[l])}}t.push(i)}console.log("Downsampled "+e.points.length+" channels to : "+i.length);console.log(t);self.postMessage({cmd:"downsampled",data:t,key:e.key})};self.export=function(e){var r=e.data;var t=e.metadata;console.log("Got a request for data export");console.log(r);var a="";var n=["Z","Y","X","Battery","Temperature","EDA"];var s="";s+="Log File Created by EDA Toolkit - "+(new Date).getYear()+"\r\n";s+="File Version"+": "+1.01+"\r\n";s+="Firmware Version"+": "+t["Firmware Version"]+"\r\n";s+="UUID"+": "+t["UUID"]+"\r\n";s+="Sampling Rate"+": "+t["Sampling Rate"].toFixed(0)+"\r\n";s+="Start Time"+": "+t["Start Time"].toQFormat()+"\r\n";s+="Z-axis | Y-axis | X-axis | Battery | °Celsius | EDA(uS)\r\n";s+="---------------------------------------------------------\r\n";a+=s;for(var i=0;i<r[n[0]].length;i++){try{var o="";for(var l=0;l<n.length;l++){try{var u=n[l];o+=r[u][i].toFixed(3);o+=l==n.length-1?"\r\n":","}catch(e){}}a+=o}catch(e){}}self.postMessage({cmd:"export",data:a})};self.parseTextData=function(e,r){console.log(r);var t={};for(var a=0;a<r.length;a++){if(r[a].toLowerCase()!="events"){t[r[a]]=[]}}t.markers=[];var n=e.split(LF);e=null;var s=n.length;for(var i=0;i<s;i++){if(i%1e3==0){self.postMessage({cmd:"progress",progress:float(i)/s})}if(n[i].indexOf(",,,,,")>-1){t.markers.push({index:i,comment:"",type:"manual"})}else{var o=n[i].split(",");for(var l=0;l<o.length;l++){var u=o[l];if(u!=undefined&&u!=""&&u.length>0&&u.charCodeAt(0)!=13){if(r[l].toLowerCase()=="events"){t.markers.push({index:i,comment:u,type:"generated"})}else{t[r[l]].push(u.autoconvert())}}}}}self.postMessage({cmd:"data",data:t})};self.parseBinaryData=function(e,r){var t="åâ";var a={};for(var n=0;n<r.length;n++){a[r[n]]=[]}e=e.replace(/^\r\n*/g,"");var s=e.split(t);e=null;a.markers=[];var i=s.length;for(var o=0;o<i;o++){if(o%1e3==0){self.postMessage({cmd:"progress",progress:float(o)/i})}try{var l=s[o];if(l.length!=12){}if(l.length==0){break}var u=unpackStruct(l);if(l.length!=12){console.log(u)}var f=unpackSigned(u[0]);var p=unpackSigned(u[1]);var c=unpackSigned(u[2]);var v=unpackUnsigned(u[3])*10;var g=unpackSigned(u[4]);var h=unpackUnsigned(u[5]);if(h>=999&&c<=-999){a.markers.push({index:o,comment:"",type:"manual"})}else{a[r[0]].push(f);a[r[1]].push(p);a[r[2]].push(c);a[r[3]].push(v);a[r[4]].push(g);a[r[5]].push(h)}}catch(e){console.log("Problem while unpacking binary data: "+e);continue}}self.postMessage({cmd:"data",data:a})};self.get=function(e,r){var t=new XMLHttpRequest;t.responseType="arraybuffer";t.open("GET",e,false);t.send();var a=new Uint8Array(t.response);var n=a.length;var s=new Array(n);while(n--){s[n]=String.fromCharCode(a[n])}self.parse(s.join(""))};