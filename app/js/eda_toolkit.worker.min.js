/**
* EDA Toolkit
* Copyright 2016 Oliver Wilder-Smith 
*/

var e=Math.E;var pi=Math.PI;var np={};var MU="μ";urlParams=function(){var e=location.search.substring(1).split("&");var r={};var t={true:true,false:false,null:null};for(var a=0,n=e.length;a<n;a++){var s=e[a];var i=s.indexOf("=");var o=i==-1?s:s.substring(0,i);var l=i==-1?true:s.substring(i+1);if(l in t){l=t[l]}else if(""+parseFloat(l,10)==l){l=parseFloat(l,10)}r[o]=l}e=t=null;return function e(t){return t in r?r[t]:null}}();float=function(e){return e*1};int=function(e){return parseInt(e,10)};pow=function(e,t){return Math.pow(e,t)};round=function(e,t){var t=t||0;return e.toFixed(t)};String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var log=function(e){if(window.console){console.log(e)}};var toast=function(e){var t=document.createElement("div");t.className="toast alert alert-info";t.innerHTML=e;t.style.position="absolute";t.style.display="block";t.style.width="30%";t.style.left="50%";t.style.top="50%";t.style["margin-left"]="-15%";t.style["margin-top"]="0px";document.getElementsByTagName("body")[0].appendChild(t);$(".toast").fadeOut(0);$(".toast").fadeIn(500);setTimeout(function(){$(".toast").fadeOut(500)},3e3)};Math.trunc=function(e,t){return e.toFixed(t)};function testBit(e,t){var r=1<<t;return e&r}function truncate(e,t){var t=t||0;return Math.trunc(e*pow(10,t))/float(pow(10,t),t)}function unpackStruct(e){var t=[];for(var r=0;r<e.length;r+=2){var a=e.charCodeAt(r);var n=e.charCodeAt(r+1);var s=a*256+n;t.push(s)}return t}function unpackSigned(e){var t=testBit(e,15)>0;var r=e>>13&3;var a=float(e&1023)/1e3;if(t)return truncate(round(-1*a*pow(10,r),3-r),3-r);else return truncate(round(a*pow(10,r),3-r),3-r)}function unpackUnsigned(e){var t=e>>14&3;var r=float(e&16383)/1e4;return truncate(round(r*pow(10,t),4-t),4-t)}Number.prototype.pad=function(e){var t=""+this;var r=e-t.length;for(var a=0;a<r;a++){t="0"+t}return t};String.prototype.pad=function(e){var t=""+this;var r=e-t.length;for(var a=0;a<r;a++){t="0"+t}return t};Date.prototype.toQFormat=function(){var e="";e+=this.getFullYear()+"-"+(this.getMonth()+1).pad(2)+"-"+this.getDate().pad(2);e+=" ";e+=this.getHours().pad(2)+":"+this.getMinutes().pad(2)+":"+this.getSeconds().pad(2);e+=" ";e+="Offset:"+(this.getTimezoneOffset()>0?"+"+(this.getTimezoneOffset()/60).pad(2):(this.getTimezoneOffset()/60).pad(2));return e};Array.prototype.isValid=function(){var e=this;return e.filter(function(e){return!isNaN(e)}).length==e.length};parseDate=function(e){var t=e.split(" ")[0];var r=e.split(" ")[1];var a=float(e.split(" ")[2].split(":")[1]);var n=int(t.split("-")[0]);var s=int(t.split("-")[1]-1);var i=int(t.split("-")[2]);var o=int(r.split(":")[0]);var l=int(r.split(":")[1]);var u=int(r.split(":")[2]);return new Date(n,s,i,o,l,u,0)};var TimeDelta=function(e){var t={};if(!e.isPrototypeOf(Object)){t.days=Math.floor(e/(1e3*60*60*24));t.hours=Math.floor(e%(1e3*60*60*24)/(1e3*60*60));t.minutes=Math.floor(e%(1e3*60*60)/(1e3*60));t.seconds=Math.floor(e%(1e3*60)/1e3);t.milliseconds=Math.floor(e%1e3)}else{t.days=e.days||0;t.hours=e.hours||0;t.minutes=e.minutes||0;t.seconds=e.seconds||0;t.milliseconds=e.milliseconds||0}t.toString=function(){return this.days+" days "+this.hours+":"+this.minutes+":"+this.seconds+"."+this.milliseconds.toFixed(3)};t.valueOf=function(){var e=0;e+=1e3*60*60*24*this.days;e+=1e3*60*60*this.hours;e+=1e3*60*this.minutes;e+=1e3*this.seconds;e+=this.milliseconds;return e};return t};Date.prototype.sub=function(e){var t=this.valueOf()-e.valueOf();return TimeDelta(t)};Date.prototype.add=function(e){return new Date(this.valueOf()+TimeDelta(e).valueOf())};Date.prototype.addMilliseconds=function(e){var t=new Date(this.valueOf()+e);return t};Date.prototype.addSeconds=function(e){return this.addMilliseconds(e*1e3)};Date.prototype.addMinutes=function(e){return this.addSeconds(60*e)};Date.prototype.addHours=function(e){return this.addMinutes(60*e)};Date.prototype.addDays=function(e){return this.addHours(24*e)};Date.prototype.getMinutesSinceMidnight=function(){var e=new Date(this.toString());e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);var t=(e.valueOf()-this.valueOf())/(60*1e3);return t};Date.prototype.shortString=function(e){if(e){return this.toLocaleDateString()+" "+this.toLocaleTimeString()}else{return this.toLocaleTimeString()}};String.prototype.contains=function(e){return this.indexOf(e)>-1};String.prototype.isnum=function(){try{var e=parseFloat(this.toString());return true}catch(e){return false}};String.prototype.isdate=function(){try{var e=new Date(this.toString());if(!e.valueOf().isNaN()){return true}else{return false}}catch(e){return false}};String.prototype.autoconvert=function(){{try{return parseDate(this.toString())}catch(e){}try{if(this.toString().indexOf(":")>0){var e=Date.parse(this.toString());if(!isNaN(e)){console.log("Parsed '"+this.toString()+"' to "+new Date(e).toString());return new Date(e)}}}catch(e){console.log(e)}try{var t=parseFloat(this.toString());if(!isNaN(t)){return t}else{return this.toString()}}catch(e){return this.toString()}}};guess=function(e){if(typeof e!="string"){return typeof e}else if(e.isdate()){return"date"}else if(e.isnum()){if(e.toString().contains(".")||e.toString().contains(",")){return"float"}else{return"int"}}else{return"unknown"}};autoformat=function(e){var t=guess(e);switch(t){case"float":return float(e);break;case"int":return int(e);break;case"date":return new Date(e);break;default:return e;break}};gaussian=function(t,r){var a=Math.sqrt(r);var n=1/(a*Math.sqrt(2*pi));var s=0;var i=-1*(Math.pow(t-s,2)/(2*a*a));var o=n*Math.pow(e,i);return o};gaussianKernel=function(e,t){var r=new Array;for(var a=-1*t/2;a<t/2;a++){r.push(gaussian(a,e))}return r};gaussianFilter=function(e,t,r){var a=new Array;if(r==undefined){r=100}for(var n=0;n<e.length;n++){var s=n-r/2<0?0:n-r/2;var i=n+r/2>=e.length?e.length-1:n+r/2;var o=gaussianKernel(t,i-s);a.push(np.sum(convolve(o,e.slice(s,i))))}return a};np.timeRange=function(e,t,r){var a=t-e;var n=Math.floor(float(a)/r);var s=new Array;for(var i=0;i<r;i++){s.push(e.addMilliseconds(n*i))}return s};np.arange=function(e,t,r){if(r==undefined){r=1}var a=new Array;for(var n=e;n<t;n+=r){a.push(n)}return a};np.round=function(e,t){var r=e%t;if(r>t/2){e=(Math.round(e/t)+1)*t}else{e=Math.round(e/t)*t}return e};np.map=function(e,t){var r=new Array;for(var a=0;a<t.length;a++){r.push(e(t[a]))}return r};np.max=function(e){var t=-Infinity;for(var r=0;r<e.length;r++){if(e[r]>t){t=e[r]}}return t};np.min=function(e){var t=Infinity;for(var r=0;r<e.length;r++){if(e[r]<t){t=e[r]}}return t};convolve=function(e,t){var r=new Array;if(e.length!=t.length){return false}else{for(var a=0;a<e.length;a++){r.push(e[a]*t[a])}return r}};np.sum=function(e){var t=0;for(var r=0;r<e.length;r++){if(!e[r].isNaN()){t+=e[r]}}return t};Array.prototype.max=function(){var e=this.filter(function(e){return!isNaN(e)});var t=-Infinity;for(var r=0;r<e.length;r++){if(e[r]>t){t=e[r]}}return t};Array.prototype.min=function(){var e=this.filter(function(e){return!isNaN(e)});var t=Infinity;for(var r=0;r<e.length;r++){if(e[r]<t){t=e[r]}}return t};Array.prototype.find=function(e){var t=this;var r=new Array;for(var a=0;a<t.length;a++){if(t[a]==e){r.push(a)}}return r};Array.prototype.map=function(e){var t=this;var r=new Array;for(var a=0;a<t.length;a++){r.push(e(t[a]))}return r};Array.prototype.max=function(){var e=this;var t=-Infinity;for(var r=0;r<e.length;r++){if(e[r]>t){t=e[r]}}return t};Array.prototype.min=function(){var e=this;var t=Infinity;for(var r=0;r<e.length;r++){if(e[r]<t){t=e[r]}}return t};Array.prototype.map=function(e){var t=this;var r=new Array;for(var a=0;a<t.length;a++){r.push(e(t[a]))}return r};float=function(e){return e*1};int=function(e){return parseInt(e,10)};Array.prototype.clone=function(){var e=this;var t=new Array;for(var r=0;r<e.length;r++){t.push(e[r])}return t};gaussian=function(t,r){var a=Math.sqrt(r);var n=1/(a*Math.sqrt(2*pi));var s=0;var i=-1*(Math.pow(t-s,2)/(2*a*a));var o=n*Math.pow(e,i);return o};gaussianKernel=function(e,t){var r=new Array;for(var a=-1*t/2;a<t/2;a++){r.push(gaussian(a,e))}return r};gaussianFilter=function(e,t,r){var a=new Array;if(r==undefined){r=100}for(var n=0;n<e.length;n++){var s=n-r/2<0?0:n-r/2;var i=n+r/2>=e.length?e.length-1:n+r/2;var o=gaussianKernel(t,i-s);a.push(np.sum(convolve(o,e.slice(s,i))))}return a};var np=np||{};np.arange=function(e,t,r){if(r==undefined){r=1}var a=new Array;for(var n=e;n<t;n+=r){a.push(n)}return a};np.round=function(e,t){var r=e%t;if(r>t/2){e=(Math.round(e/t)+1)*t}else{e=Math.round(e/t)*t}return e};np.map=function(e,t){var r=new Array;for(var a=0;a<t.length;a++){r.push(e(t[a]))}return r};np.max=function(e){var t=-Infinity;for(var r=0;r<e.length;r++){if(e[r]>t){t=e[r]}}return t};np.min=function(e){var t=Infinity;for(var r=0;r<e.length;r++){if(e[r]<t){t=e[r]}}return t};convolve=function(e,t){var r=new Array;if(e.length!=t.length){return false}else{for(var a=0;a<e.length;a++){r.push(e[a]*t[a])}return r}};np.sum=function(e){var t=0;for(var r=0;r<e.length;r++){if(!e[r].isNaN){t+=e[r]}}return t};np.mean=function(e){return np.sum(e)/(1*e.length)};np.average=np.mean;np.avg=np.mean;np.median=function(e){var t=e.clone();t.sort();var r=int(Math.ceil(e.length/2))-1;if(e.length%2==0){return np.mean(t.slice(r,-r))}else{return t[r]}};var signals=signals||{};signals.sanitize=function(e,t,r){var t=t||[0];var r=r||[NaN];for(var a=0;a<e.length;a++){for(var n=0;n<r.length;n++){if(r[n]=="-"){if(e[a]<0){e[a]=t[n]}}else if(e[a]==r[n]){e[a]=t[n]}}}return e};signals.gaussianFilter=function(e,t){return gaussianFilter(e,t,10)};signals.medianFilter=function(e,t){var t=t||3;var r=new Array;for(var a=0;a<e.length;a++){var n=a-t/2<0?0:a-t/2;var s=a+t/2>=e.length?e.length-1:a+t/2;r.push(np.median(e.slice(n,s)))}return r};signals.maxFilter=function(e,t){var t=t||3;var r=new Array;for(var a=0;a<e.length;a++){var n=a-t/2<0?0:a-t/2;var s=a+t/2>=e.length?e.length-1:a+t/2;r.push(np.max(e.slice(n,s)))}return r};signals.minFilter=function(e,t){var t=t||3;var r=new Array;for(var a=0;a<e.length;a++){var n=a-t/2<0?0:a-t/2;var s=a+t/2>=e.length?e.length-1:a+t/2;r.push(np.min(e.slice(n,s)))}return r};signals.diff=function(e){var t=new Array;for(var r=0;r<e.length-1;r++){t.push(e[r+1]-e[r])}return t};signals.where=function(e,t){var r=new Array;for(var a=0;a<e.length;a++){if(t(e[a])){r.push(a)}}return r};signals.zeroCrossings=function(e){var t=new Array;for(var r=1;r<e.length;r++){if(e[r-1]<0&&e[r]>0){t[r]=1}else if(e[r-1]>0&&e[r]<0){t[r]=-1}else{t[r]=0}}return t};signals.peaks=function(e,t){var r=new Array;var a=signals.diff(e);var n=signals.zeroCrossings(e);var s=signals.where(r,function(e){return e>0});var i=signals.where(r,function(e){return e<0});return[s,i]};var separator="---------------------------------------------------------\r\n";var LF="\r\n";var console={};console.log=function(e){self.postMessage({cmd:"console",msg:e})};self.addEventListener("message",function(e){var t=e.data;switch(t.cmd){case"load":if(t.filename!=undefined)self.filename=t.filename;self.get(t.url,self.parse);break;case"loadText":if(t.filename!=undefined)self.filename=t.filename;self.parse(t.data);break;case"downsample":self.downsample(t.data);break;case"downsampleMultiChannel":self.downsampleMultiChannel(t.data);break;case"scrs":self.SCRs(t.data);break;case"export":self.export(t.data);break;case"filter":self.filter(t.data);break;case"stop":self.postMessage("WORKER STOPPED: "+t.msg+". (buttons will no longer work)");self.close();break;default:self.postMessage("Unknown command: "+t.msg)}},false);self.parse=function(e){e=e.toString();if(!e.contains(LF)){LF="\n"}var t=self.detectFormat(e);switch(t){case"edafile":var r=e.split(separator);var a=r[0].split(LF);var n=self.parseHeaders(a);e=null;if(n["File Version"]<1.1){self.parseTextData(r[1],["Z","Y","X","Battery","Temperature","EDA"])}else if(n["File Version"]<1.5&&n["File Version"]>1.09){self.parseTextData(r[1],n["Column Names"])}else{self.parseBinaryData(r[1],["Z","Y","X","Battery","Temperature","EDA"])}break;case"csv":var r=e.split(LF);var a=r.slice(0,4);console.log("Headers: "+a.join("|"));var n=self.parseDSVHeaders(a,",");console.log("Parsed Headers: "+n["Column Names"].join(","));var s=e.replace(n["headerLines"],"");e=null;self.parseTextData(s,n["Column Names"]);break;case"tsv":var r=e.split(LF);var a=r.slice(0,4);console.log("Headers: "+a.join("|"));var s=e.toString().replace(a[0]+LF,"");var n=self.parseDSVHeaders(a,"\t");console.log("Parsed Headers: "+n["Column Names"].join("\t"));e=null;self.parseTextData(s,n["Column Names"]);break;default:var r=e.toString().split(LF);var a=r.slice(0,4);var s=e.toString().replace(a[0]+LF,"");e=null;var n=self.parseDSVHeaders(a,",");self.parseTextData(s,n["Column Names"]);break}};self.detectFormat=function(e){if(e.indexOf("\n")==-1){LF="\r"}if(e.indexOf(separator)>-1){LF="\r\n";return"edafile"}else if(e.indexOf("\t")>-1&&!(e.indexOf(",")>-1)){return"tsv"}else{return"csv"}};self.parseDSVHeaders=function(t,r){colNames=t[0].replace(/\n/g,"").split(r);var a={};a["Column Names"]=colNames;a["headerLines"]=t[0]+LF;var e=[];for(var n=1;n<t.length;n++){e.push(t[n].split(r))}if(e.length>1){try{var s=Date.parse(e[0][0]);var i=Date.parse(e[1][0]);var o=1e3/(i-s);a["Sampling Rate"]=o;a["Start Time"]=new Date(s);if(isNaN(a["Sampling Rate"])){s=new Date(parseInt(e[0][0]));i=new Date(parseInt(e[1][0]));o=1e3/(i-s);a["Start Time"]=new Date(parseInt(s));if(isNaN(a["Sampling Rate"])){throw"Sample rate invalid: "+o}}if(isNaN(a["Start Time"])){throw"Invalid Start Time: "+s}console.log("Successfully identified sample rate: "+o+" and start time: "+a["Start Time"].toString())}catch(e){console.log("Treating file as empatica format (first row is starttime, second row is sample rate)");a["Start Time"]=new Date(parseFloat(t[0].split(r)[0])*1e3);a["Sampling Rate"]=parseFloat(t[1].split(r)[0]);var l="Channel";if(self.filename!=undefined){l=self.filename.split(".")[0]}for(var n=0;n<colNames.length;n++){if(colNames.length>1){a["Column Names"][n]=l+"_"+(n+1)}else{a["Column Names"][n]=l}}a["headerLines"]+=t[1]+LF;console.log("Empatica file: Successfully identified sample rate: "+a["Sampling Rate"]+" and start time: "+a["Start Time"].toString())}}self.metadata=t;self.postMessage({cmd:"metadata",data:a});return a};self.parseHeaders=function(e){var t={};var r=[],a;for(var n=0;n<e.length;n++){var s=e[n];if(s.indexOf(": ")>-1){var i=s.split(": ")[0];var o=s.split(": ")[1];if(o!=undefined&&o!=""){t[i]=o.autoconvert()}}else if(s.indexOf("|")>-1){a=s.replace(/^\s*|\s*$/g,"");a=a.split("|");console.log("Column Names: "+a);for(var l=0;l<a.length;l++){a[l]=a[l].replace(/^\s*|\s*$/g,"");switch(a[l]){case"Z-axis":a[l]="Z";break;case"Y-axis":a[l]="Y";break;case"X-axis":a[l]="X";break;case"°Celsius":a[l]="Temperature";break;case"EDA(uS)":a[l]="EDA";break;case"�Celsius":a[l]="Temperature";break;default:if(a[l].indexOf("Celsius")>-1){a[l]="Temperature"}break}if(a[l].toLowerCase()!="events"){r.push(a[l])}}t["Column Names"]=r}}self.metadata=e;self.postMessage({cmd:"metadata",data:t});t["Column Names"]=a;return t};self.SCRs=function(e){var t=e.width||8;var r=signals.peaks(data,t);console.log("Crossings:");console.log(r);self.postMessage({cmd:"scrs",data:r[0]})};self.filter=function(e){var t=e.data;var r=e.width||self.metadata["Sampling Rate"];var a;console.log("Self.Filter: Got data of "+t.length);switch(e.filterType){case"median":a=signals.medianFilter(t,r);break;case"min":a=signals.minFilter(t,r);break;case"max":a=signals.maxFilter(t,r);break;case"gaussian":a=signals.gaussianFilter(t,r);break;default:a=signals.gaussianFilter(t,r);break}self.postMessage({cmd:"filter",data:a})};self.downsample=function(e){console.log("In downsample");var t=signals.sanitize(e.points,[0],[NaN]);var r=e.target;var a=[];var n=Math.ceil(t.length/r);console.log("Data length: "+t.length+" Target: "+r+" so increment is "+n);if(t.length<=r){a=t}else{var t=gaussianFilter(t,int(n),20);for(var s=0;s<t.length;s+=n){a.push(t[s])}}console.log("Downsampled to : "+a.length);self.postMessage({cmd:"downsampled",data:a,key:e.key})};self.downsampleMultiChannel=function(e){console.log("In downsampleMultiChannel");var t=e.target;var r=[];for(var a=0;a<e.points.length;a++){var n=e.points[a];var s=signals.sanitize(n,[0],[NaN]);var i=[];var o=Math.floor(s.length/t);console.log("Data length: "+s.length+" Target: "+t+" so increment is "+o);if(s.length<=t){i=s}else{for(var l=0;l<s.length;l+=o){i.push(s[l])}}r.push(i)}console.log("Downsampled "+e.points.length+" channels to : "+i.length);console.log(r);self.postMessage({cmd:"downsampled",data:r,key:e.key})};self.export=function(e){var t=e.data;var r=e.metadata;console.log("Got a request for data export");console.log(t);var a="";var n=["Z","Y","X","Battery","Temperature","EDA"];var s="";s+="Log File Created by EDA Toolkit - "+(new Date).getYear()+"\r\n";s+="File Version"+": "+1.01+"\r\n";s+="Firmware Version"+": "+r["Firmware Version"]+"\r\n";s+="UUID"+": "+r["UUID"]+"\r\n";s+="Sampling Rate"+": "+r["Sampling Rate"].toFixed(0)+"\r\n";s+="Start Time"+": "+r["Start Time"].toQFormat()+"\r\n";s+="Z-axis | Y-axis | X-axis | Battery | °Celsius | EDA(uS)\r\n";s+="---------------------------------------------------------\r\n";a+=s;for(var i=0;i<t[n[0]].length;i++){try{var o="";for(var l=0;l<n.length;l++){try{var u=n[l];o+=t[u][i].toFixed(3);o+=l==n.length-1?"\r\n":","}catch(e){}}a+=o}catch(e){}}self.postMessage({cmd:"export",data:a})};self.parseTextData=function(e,t){console.log(t);var r={};for(var a=0;a<t.length;a++){if(t[a].toLowerCase()!="events"){r[t[a]]=[]}}r.markers=[];var n=e.split(LF);e=null;var s=n.length;for(var i=0;i<s;i++){if(i%1e3==0){self.postMessage({cmd:"progress",progress:float(i)/s})}if(n[i].indexOf(",,,,,")>-1){r.markers.push({index:i,comment:"",type:"manual"})}else{var o=n[i].split(",");for(var l=0;l<o.length;l++){var u=o[l];if(u!=undefined&&u!=""&&u.length>0&&u.charCodeAt(0)!=13){if(t[l].toLowerCase()=="events"){r.markers.push({index:i,comment:u,type:"generated"})}else{r[t[l]].push(u.autoconvert())}}}}}self.postMessage({cmd:"data",data:r})};self.parseBinaryData=function(e,t){var r="åâ";var a={};for(var n=0;n<t.length;n++){a[t[n]]=[]}e=e.replace(/^\r\n*/g,"");var s=e.split(r);e=null;a.markers=[];var i=s.length;for(var o=0;o<i;o++){if(o%1e3==0){self.postMessage({cmd:"progress",progress:float(o)/i})}try{var l=s[o];if(l.length!=12){}if(l.length==0){break}var u=unpackStruct(l);if(l.length!=12){console.log(u)}var f=unpackSigned(u[0]);var p=unpackSigned(u[1]);var c=unpackSigned(u[2]);var v=unpackUnsigned(u[3])*10;var g=unpackSigned(u[4]);var h=unpackUnsigned(u[5]);if(h>=999&&c<=-999){a.markers.push({index:o,comment:"",type:"manual"})}else{a[t[0]].push(f);a[t[1]].push(p);a[t[2]].push(c);a[t[3]].push(v);a[t[4]].push(g);a[t[5]].push(h)}}catch(e){console.log("Problem while unpacking binary data: "+e);continue}}self.postMessage({cmd:"data",data:a})};self.get=function(e,t){var r=new XMLHttpRequest;r.responseType="arraybuffer";r.open("GET",e,false);r.send();var a=new Uint8Array(r.response);var n=a.length;var s=new Array(n);while(n--){s[n]=String.fromCharCode(a[n])}self.parse(s.join(""))};